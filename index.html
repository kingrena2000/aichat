<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÊâãÊú∫Ê°åÈù¢</title>
    <!-- ========== Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπïÁöÑÈÖçÁΩÆ ========== -->

    <!-- iOS ÂõæÊ†áÔºàÊúÄÈáçË¶ÅÔºâ -->
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">

    <!-- Android /ÈÄöÁî®ÂõæÊ†á -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

    <!-- iOS: ÂÖ®Â±èÊ®°ÂºèÔºàÂéªÊéâÊµèËßàÂô®Âú∞ÂùÄÊ†èÔºâ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- iOS: Áä∂ÊÄÅÊ†èÊ†∑ÂºèÔºàÈªëËâ≤ÂçäÈÄèÊòéÔºåÈÖçÂêà‰Ω†ÁöÑÊ∑±Ëâ≤ËÉåÊôØÔºâ -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- iOS: ‰∏ªÂ±èÂπï‰∏äÊòæÁ§∫ÁöÑÂêçÂ≠ó -->
    <meta name="apple-mobile-web-app-title" content="ÊàëÁöÑÊ°åÈù¢">

    <!-- Android: Web App Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Android: ‰∏ªÈ¢òËâ≤ÔºàÂú∞ÂùÄÊ†èÈ¢úËâ≤Ôºâ -->
    <meta name="theme-color" content="#0a1628">
	
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; height: 100vh; overflow: hidden; user-select: none; -webkit-user-select: none; }

        .phone-home-screen {
            position: fixed; inset: 0;
            background: linear-gradient(145deg, #0a1628 0%, #1a3a5c 30%, #2d6187 60%, #4a90b8 100%);
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; overflow: hidden; color: #fff;
        }
        .phone-home-screen.has-wallpaper { background-size: cover; background-position: center; }
        .phone-home-screen.has-wallpaper::before {
            content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.15); z-index: 0;
        }
        .phone-home-screen > * { position: relative; z-index: 1; }

        .home-status-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 24px 4px; font-size: 13px; font-weight: 600;}
        .home-status-icons { display: flex; gap: 6px; font-size: 12px; }
        .home-status-icons i { opacity: 0.9; }

        .home-datetime { text-align: center; padding: 20px 20px 10px; }
        .home-time {
            font-size: 64px; font-weight: 200; letter-spacing: 2px; line-height: 1;
            text-shadow: 0 2px 12px rgba(0,0,0,0.25);
        }
        .home-date {
            font-size: 15px; opacity: 0.85; margin-top: 4px;
            text-shadow: 0 1px 6px rgba(0,0,0,0.2);
        }

        .home-weather-widget {
            margin: 12px 20px; padding: 14px 18px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 16px; border: 1px solid rgba(255,255,255,0.2);
            display: flex; align-items: center; gap: 14px;
            cursor: pointer; transition: background 0.2s;
        }
        .home-weather-widget:active { background: rgba(255,255,255,0.25); }
        .weather-icon-box { font-size: 28px; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; opacity: 0.9; }
        .weather-info { flex: 1; }
        .weather-temp-row { display: flex; align-items: baseline; gap: 8px; }
        .weather-temp-row .temp { font-size: 28px; font-weight: 300; }
        .weather-temp-row .desc { font-size: 14px; opacity: 0.85; }
        .weather-city-row { font-size: 12px; opacity: 0.65; margin-top: 2px; }

        .home-app-grid {
            flex: 1; display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 8px 0; padding: 16px 16px; align-content: start; overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .home-app-grid::-webkit-scrollbar { display: none; }

        .home-app-item {
            display: flex; flex-direction: column; align-items: center;
            gap: 6px; padding: 8px 4px; cursor: pointer;
            -webkit-tap-highlight-color: transparent; transition: transform 0.15s;
        }
        .home-app-item:active { transform: scale(0.88); }

        .home-app-icon {
            width: 56px; height: 56px; border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 26px; color: white;
            box-shadow: 0 3px 12px rgba(0,0,0,0.2); position: relative; overflow: hidden;
        }
        .home-app-name {
            font-size: 11px; text-shadow: 0 1px 4px rgba(0,0,0,0.4);
            max-width: 64px; text-align: center;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        .icon-wechat   { background: linear-gradient(135deg, #2DC100, #07C160); }
        .icon-game1{ background: linear-gradient(135deg, #5856D6, #AF52DE); }
        .icon-game2    { background: linear-gradient(135deg, #34AADC, #5AC8FA); }
        .icon-settings { background: linear-gradient(135deg, #8E8E93, #636366); }
        .icon-diary    { background: linear-gradient(135deg, #FF9500, #FFCC00); }
        .icon-notes    { background: linear-gradient(135deg, #FFCC00, #FFD426); color: #333; }
        .icon-clock    { background: linear-gradient(135deg, #1C1C1E, #3A3A3C); }
        .icon-netease  { background: linear-gradient(135deg, #C20C0C, #E83030); }
        .icon-weather  { background: linear-gradient(135deg, #34AADC, #5AC8FA); }
        .icon-files    { background: linear-gradient(135deg, #007AFF, #5AC8FA); }
        .icon-phone    { background: linear-gradient(135deg, #34C759, #30D158); }
        .icon-wallpaper{ background: linear-gradient(135deg, #AF52DE, #DA8FFF); }

        .home-dock { padding: 12px 20px 20px; display: flex; justify-content: center; }
        .home-dock-bg {
            display: flex; gap: 20px; padding: 12px 28px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-radius: 22px; border: 1px solid rgba(255,255,255,0.15);
        }
        .home-dock-item { cursor: pointer; -webkit-tap-highlight-color: transparent; transition: transform 0.15s; }
        .home-dock-item:active { transform: scale(0.88); }
        .home-dock-icon {
            width: 52px; height: 52px; border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: white; box-shadow: 0 3px 12px rgba(0,0,0,0.2);}

        .home-toast {
            position: fixed; bottom: 120px; left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0,0,0,0.75); backdrop-filter: blur(10px);
            color: white; padding: 10px 24px; border-radius: 20px;
            font-size: 14px; opacity: 0; transition: all 0.3s ease;
            pointer-events: none; z-index: 100; white-space: nowrap;
        }
        .home-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        .page-leaving { animation: pageLeave 0.35s ease forwards; }
        @keyframes pageLeave {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.06); opacity: 0; }
        }

        .city-modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(6px); z-index: 200;
            display: none; align-items: center; justify-content: center;
        }
        .city-modal-overlay.show { display: flex; }
        .city-modal {
            background: rgba(30,40,60,0.95); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 24px; width: 88%; max-width: 340px;
        }
        .city-modal-title { font-size: 17px; font-weight: 700; text-align: center; margin-bottom: 16px; }
        .city-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
        .city-btn {
            padding: 10px 6px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.05);
            color: #fff; font-size: 13px; cursor: pointer; text-align: center; transition: all 0.15s;
        }
        .city-btn:hover { background: rgba(255,255,255,0.12); }
        .city-btn:active { transform: scale(0.95); }
        .city-btn.active { border-color: #5AC8FA; background: rgba(90,200,250,0.15); color: #5AC8FA; }
        .city-custom-row { display: flex; gap: 8px; }
        .city-input {
            flex: 1; padding: 10px 14px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.06);
            color: #fff; font-size: 13px; outline: none;
        }
        .city-input::placeholder { color: rgba(255,255,255,0.3); }
        .city-input:focus { border-color: rgba(90,200,250,0.4); }
        .city-confirm-btn {
            padding: 10px 18px; border-radius: 12px; border: none;
            background: linear-gradient(135deg, #34AADC, #5AC8FA);
            color: #fff; font-size: 13px; font-weight: 600; cursor: pointer;
        }
        .city-confirm-btn:active { transform: scale(0.95); }
        .city-cancel-btn {
            display: block; margin: 12px auto 0; padding: 8px 24px;
            background: none; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; color: rgba(255,255,255,0.5); font-size: 13px; cursor: pointer;
        }

        .wallpaper-modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(6px); z-index: 200;
            display: none; align-items: center; justify-content: center;
        }
        .wallpaper-modal-overlay.show { display: flex; }
        .wallpaper-modal {
            background: rgba(30,40,60,0.95); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 24px; width: 88%; max-width: 360px;
        }
        .wallpaper-modal-title { font-size: 17px; font-weight: 700; text-align: center; margin-bottom: 20px; }
        .wallpaper-preview {
            width: 100%; height: 160px; border-radius: 12px; margin-bottom: 16px;
            background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.15);
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; cursor: pointer; transition: border-color 0.2s;
        }
        .wallpaper-preview:hover { border-color: rgba(255,255,255,0.3); }
        .wallpaper-preview img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .wallpaper-preview .placeholder { color: rgba(255,255,255,0.3); text-align: center; font-size: 13px; line-height: 1.6; }
        .wallpaper-btns { display: flex; gap: 8px; margin-bottom: 12px; }
        .wallpaper-btn {
            flex: 1; padding: 10px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.06);
            color: #fff; font-size: 13px; cursor: pointer; text-align: center; transition: all 0.15s;
        }
        .wallpaper-btn:hover { background: rgba(255,255,255,0.12); }
        .wallpaper-btn:active { transform: scale(0.95); }
        .wallpaper-btn i { display: block; font-size: 20px; margin-bottom: 4px; }
        .wallpaper-url-row { display: flex; gap: 8px; margin-bottom: 12px; display: none; }
        .wallpaper-url-input {
            flex: 1; padding: 10px 14px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.06);
            color: #fff; font-size: 13px; outline: none;
        }
        .wallpaper-url-input::placeholder { color: rgba(255,255,255,0.3); }
        .wallpaper-actions { display: flex; gap: 8px; }
        .wallpaper-action-btn {
            flex: 1; padding: 12px; border-radius: 14px; border: none;
            font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.15s;
        }
        .wallpaper-action-btn:active { transform: scale(0.96); }
        .wallpaper-save { background: linear-gradient(135deg, #AF52DE, #DA8FFF); color: #fff; }
        .wallpaper-reset { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.7); }
    </style>
</head>
<body>

<div class="phone-home-screen" id="phoneHomeScreen">
    <div class="home-status-bar">
        <span id="statusBarTime" style="font-size:14px;font-weight:600;"></span>
        <div class="home-status-icons">
            <i class="fa fa-signal"></i>
            <i class="fa fa-wifi"></i>
            <i class="fa fa-battery-full"></i>
        </div>
    </div>

    <div class="home-datetime">
        <div class="home-time" id="homeTime">12:00</div>
        <div class="home-date" id="homeDate">1Êúà1Êó• ÊòüÊúü‰∏Ä</div>
    </div>

    <div class="home-weather-widget" onclick="openCityModal()">
        <div class="weather-icon-box" id="weatherIcon"><i class="fa fa-sun-o"></i></div>
        <div class="weather-info">
            <div class="weather-temp-row">
                <span class="temp" id="weatherTemp">--¬∞</span>
                <span class="desc" id="weatherDesc">Âä†ËΩΩ‰∏≠</span>
            </div>
            <div class="weather-city-row"><span id="weatherCity">--</span> ¬∑ÁÇπÂáªÂàáÊç¢ÂüéÂ∏Ç</div>
        </div>
    </div>

    <div class="home-app-grid">
        <div class="home-app-item" onclick="openApp('wechat.html')">
            <div class="home-app-icon icon-wechat"><i class="fa fa-wechat"></i></div>
            <span class="home-app-name">ÂæÆ‰ø°</span>
        </div>
        <div class="home-app-item" onclick="openApp('water-sort.html')">
            <div class="home-app-icon icon-game1">üß™</div>
            <span class="home-app-name">ÂÄíÊ∞¥ÊéíÂ∫è</span>
        </div>
        <div class="home-app-item" onclick="openApp('turtle-soup.html')">
            <div class="home-app-icon icon-game2">üê¢</div>
            <span class="home-app-name">Êµ∑ÈæüÊ±§</span>
        </div>
        <div class="home-app-item" onclick="openApp('diary.html')">
            <div class="home-app-icon icon-diary"><i class="fa fa-book"></i></div>
            <span class="home-app-name">Êó•ËÆ∞Êú¨</span>
        </div>
        <div class="home-app-item" onclick="openNativeApp('mobilenotes://', 'Â§áÂøòÂΩï')">
            <div class="home-app-icon icon-notes"><i class="fa fa-pencil-square-o"></i></div>
            <span class="home-app-name">Â§áÂøòÂΩï</span>
        </div>
        <div class="home-app-item" onclick="openNativeApp('clock-alarm://', 'Êó∂Èíü')">
            <div class="home-app-icon icon-clock"><i class="fa fa-clock-o"></i></div>
            <span class="home-app-name">Êó∂Èíü</span>
        </div>
        <div class="home-app-item" onclick="openNativeApp('orpheuswidget://', 'ÁΩëÊòì‰∫ëÈü≥‰πê','https://music.163.com/')">
            <div class="home-app-icon icon-netease"><i class="fa fa-music"></i></div>
            <span class="home-app-name">ÁΩëÊòì‰∫ëÈü≥‰πê</span>
        </div>
        <div class="home-app-item" onclick="openApp('settings.html')">
            <div class="home-app-icon icon-settings"><i class="fa fa-cog"></i></div>
            <span class="home-app-name">ËÆæÁΩÆ</span>
        </div>
        <div class="home-app-item" onclick="openWallpaperModal()">
            <div class="home-app-icon icon-wallpaper"><i class="fa fa-paint-brush"></i></div>
            <span class="home-app-name">Â£ÅÁ∫∏</span>
        </div>
    </div>

    <div class="home-dock">
        <div class="home-dock-bg">
            <div class="home-dock-item" onclick="showToast('ÁîµËØùÂäüËÉΩÂºÄÂèë‰∏≠...')">
                <div class="home-dock-icon icon-phone"><i class="fa fa-phone"></i></div></div>
            <div class="home-dock-item" onclick="openApp('wechat.html')">
                <div class="home-dock-icon icon-wechat"><i class="fa fa-wechat"></i></div>
            </div>
            <div class="home-dock-item" onclick="openApp('settings.html')">
                <div class="home-dock-icon icon-settings"><i class="fa fa-cog"></i></div>
            </div>
        </div>
    </div>
</div>

<div id="homeToast" class="home-toast"></div>
<input type="file" id="wallpaperFileInput" accept="image/*" style="display:none;">

<!--ÂüéÂ∏ÇÂºπÁ™ó -->
<div class="city-modal-overlay" id="cityModalOverlay">
    <div class="city-modal">
        <div class="city-modal-title">üåç ÈÄâÊã©ÂüéÂ∏Ç</div>
        <div class="city-grid" id="cityGrid"></div>
        <div class="city-custom-row">
            <input type="text" class="city-input" id="cityCustomInput" placeholder="ËæìÂÖ•ÂüéÂ∏ÇËã±ÊñáÂêç..." autocomplete="off">
            <button class="city-confirm-btn" onclick="confirmCity()">Á°ÆÂÆö</button>
        </div>
        <button class="city-cancel-btn" onclick="closeCityModal()">ÂèñÊ∂à</button>
    </div>
</div>

<!--Â£ÅÁ∫∏ÂºπÁ™ó -->
<div class="wallpaper-modal-overlay" id="wallpaperModalOverlay">
    <div class="wallpaper-modal">
        <div class="wallpaper-modal-title">üé® ËÆæÁΩÆÂ£ÅÁ∫∏</div>
        <div class="wallpaper-preview" id="wallpaperPreview" onclick="document.getElementById('wallpaperFileInput').click()">
            <img id="wallpaperPreviewImg" src="" alt=""><div class="placeholder" id="wallpaperPlaceholder"><i class="fa fa-image" style="font-size:32px;display:block;margin-bottom:8px;"></i>ÁÇπÂáª‰∏ä‰º†ÊàñÈ¢ÑËßà</div>
        </div>
        <div class="wallpaper-btns">
            <div class="wallpaper-btn" onclick="document.getElementById('wallpaperFileInput').click()">
                <i class="fa fa-upload"></i>Êú¨Âú∞‰∏ä‰º†
            </div>
            <div class="wallpaper-btn" onclick="toggleUrlInput()">
                <i class="fa fa-link"></i>ËæìÂÖ•URL
            </div>
        </div>
        <div class="wallpaper-url-row" id="wallpaperUrlRow">
            <input type="text" class="wallpaper-url-input" id="wallpaperUrlInput" placeholder="https://example.com/bg.jpg">
            <button class="city-confirm-btn" onclick="previewUrl()">È¢ÑËßà</button></div>
        <div class="wallpaper-actions">
            <button class="wallpaper-action-btn wallpaper-reset" onclick="resetWallpaper()">ÊÅ¢Â§çÈªòËÆ§</button>
            <button class="wallpaper-action-btn wallpaper-save" onclick="saveWallpaper()">Â∫îÁî®Â£ÅÁ∫∏</button>
        </div>
        <button class="city-cancel-btn" onclick="closeWallpaperModal()">ÂèñÊ∂à</button>
    </div>
</div>

<script>
// ==================== Êó∂Èó¥====================
function updateTime() {
    const now = new Date();
    const h = now.getHours().toString().padStart(2,'0');
    const m = now.getMinutes().toString().padStart(2,'0');
    const el = document.getElementById('homeTime');
    const st = document.getElementById('statusBarTime');
    if (el) el.textContent = h + ':' + m;
    if (st) st.textContent = h + ':' + m;

    const dateEl = document.getElementById('homeDate');
    if (dateEl) {
        const wd = ['ÊòüÊúüÊó•','ÊòüÊúü‰∏Ä','ÊòüÊúü‰∫å','ÊòüÊúü‰∏â','ÊòüÊúüÂõõ','ÊòüÊúü‰∫î','ÊòüÊúüÂÖ≠'];
        dateEl.textContent = (now.getMonth()+1) + 'Êúà' + now.getDate() + 'Êó• ' + wd[now.getDay()];
    }
}

// ==================== Â§©Ê∞î ====================
const CITY_MAP = {
    'Beijing':'Âåó‰∫¨','Shanghai':'‰∏äÊµ∑','Guangzhou':'ÂπøÂ∑û','Shenzhen':'Ê∑±Âú≥',
    'Hangzhou':'Êù≠Â∑û','Chengdu':'ÊàêÈÉΩ','Wuhan':'Ê≠¶Ê±â','Nanjing':'Âçó‰∫¨',
    'Xian':'Ë•øÂÆâ','Chongqing':'ÈáçÂ∫Ü','Tianjin':'Â§©Ê¥•','Suzhou':'ËãèÂ∑û',
    'Changsha':'ÈïøÊ≤ô','Zhengzhou':'ÈÉëÂ∑û','Tokyo':'‰∏ú‰∫¨','Seoul':'È¶ñÂ∞î',
    'London':'‰º¶Êï¶','NewYork':'Á∫ΩÁ∫¶','Paris':'Â∑¥Èªé','Singapore':'Êñ∞Âä†Âù°'
};
const PRESET_CITIES = ['Beijing','Shanghai','Guangzhou','Shenzhen','Hangzhou','Chengdu','Wuhan','Nanjing','Chongqing','Tokyo','Seoul','London'];
function getCityName(c){ return CITY_MAP[c]||c; }

async function fetchWeather() {
    const city = localStorage.getItem('homeWeatherCity')||'Beijing';
    const cityEl = document.getElementById('weatherCity');
    const tempEl = document.getElementById('weatherTemp');
    const descEl = document.getElementById('weatherDesc');
    const iconEl = document.getElementById('weatherIcon');
    if (cityEl) cityEl.textContent = getCityName(city);
    try {
        const r = await fetch('https://wttr.in/' + encodeURIComponent(city) + '?format=j1');
        if (!r.ok) throw new Error('fail');
        const d = await r.json();
        const cur = d.current_condition && d.current_condition[0];
        if (cur) {
            const t = cur.temp_C;
            const desc = (cur.lang_zh&&cur.lang_zh[0]&&cur.lang_zh[0].value)||(cur.weatherDesc&&cur.weatherDesc[0]&&cur.weatherDesc[0].value)||'Êú™Áü•';
            const code = parseInt(cur.weatherCode)||0;
            if (tempEl) tempEl.textContent = t + '¬∞';
            if (descEl) descEl.textContent = desc;
            if (iconEl) iconEl.innerHTML = getWIcon(code);
            localStorage.setItem('homeWeatherCache', JSON.stringify({temp:t,desc:desc,code:code,ts:Date.now()}));
        }
    } catch(e) {
        try {
            const c = JSON.parse(localStorage.getItem('homeWeatherCache')||'{}');
            if (c.temp) {
                if (tempEl) tempEl.textContent = c.temp + '¬∞';
                if (descEl) descEl.textContent = c.desc||'';
                if (iconEl) iconEl.innerHTML = getWIcon(c.code||0);
            }
        } catch(_){}
    }
}
function getWIcon(c) {
    if (c===113) return '<i class="fa fa-sun-o"></i>';
    if (c===116||c===119||c===122) return '<i class="fa fa-cloud"></i>';
    if ([176,263,266,293,296,299,302,305,308,311,314,353,356,359].includes(c)) return '<i class="fa fa-tint"></i>';
    if ([179,182,185,227,230,320,323,326,329,332,335,338,350,362,365,368,371,374,377,392,395].includes(c)) return '<i class="fa fa-snowflake-o"></i>';
    if ([200,386,389].includes(c)) return '<i class="fa fa-bolt"></i>';
    if ([143,248,260].includes(c)) return '<i class="fa fa-low-vision"></i>';
    return '<i class="fa fa-sun-o"></i>';
}

// ==================== ÂüéÂ∏ÇÂºπÁ™ó ====================
function openCityModal() {
    const grid = document.getElementById('cityGrid');
    const overlay = document.getElementById('cityModalOverlay');
    const cur = localStorage.getItem('homeWeatherCity')||'Beijing';
    grid.innerHTML = '';
    PRESET_CITIES.forEach(function(code) {
        const btn = document.createElement('div');
        btn.className = 'city-btn' + (code===cur?' active':'');
        btn.textContent = getCityName(code);
        btn.onclick = function() { localStorage.setItem('homeWeatherCity',code); closeCityModal(); fetchWeather(); };
        grid.appendChild(btn);
    });
    const input = document.getElementById('cityCustomInput');
    input.value = PRESET_CITIES.includes(cur)?'':cur;
    overlay.classList.add('show');
}
function closeCityModal(){ document.getElementById('cityModalOverlay').classList.remove('show'); }
function confirmCity() {
    const v = document.getElementById('cityCustomInput').value.trim();
    if (!v) { showToast('ËØ∑ËæìÂÖ•ÂüéÂ∏ÇÂêç'); return; }
    localStorage.setItem('homeWeatherCity', v);
    closeCityModal(); fetchWeather();
}

// ==================== Â£ÅÁ∫∏ ====================
var pendingWallpaperData = null;

function openWallpaperModal() {
    const overlay = document.getElementById('wallpaperModalOverlay');
    const img = document.getElementById('wallpaperPreviewImg');
    const ph = document.getElementById('wallpaperPlaceholder');
    const saved = localStorage.getItem('homeWallpaper');
    if (saved) {
        img.src = saved; img.style.display = 'block'; ph.style.display = 'none';
        pendingWallpaperData = saved;
    } else {
        img.style.display = 'none'; ph.style.display = '';
        pendingWallpaperData = null;
    }
    document.getElementById('wallpaperUrlRow').style.display = 'none';
    overlay.classList.add('show');
}
function closeWallpaperModal() {
    document.getElementById('wallpaperModalOverlay').classList.remove('show');
    pendingWallpaperData = null;
}
function toggleUrlInput() {
    const row = document.getElementById('wallpaperUrlRow');
    row.style.display = row.style.display === 'none' ? 'flex' : 'none';
}
function previewUrl() {
    const url = document.getElementById('wallpaperUrlInput').value.trim();
    if (!url) { showToast('ËØ∑ËæìÂÖ•URL'); return; }
    const img = document.getElementById('wallpaperPreviewImg');
    const ph = document.getElementById('wallpaperPlaceholder');
    img.onload = function() { img.style.display = 'block'; ph.style.display = 'none'; pendingWallpaperData = url; showToast('È¢ÑËßàÊàêÂäü'); };
    img.onerror = function() { showToast('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•'); };
    img.src = url;
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('wallpaperFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        compressImage(file, 1200, 0.8, function(base64) {
            const img = document.getElementById('wallpaperPreviewImg');
            const ph = document.getElementById('wallpaperPlaceholder');
            img.src = base64; img.style.display = 'block'; ph.style.display = 'none';
            pendingWallpaperData = base64;
            showToast('ÂõæÁâáÂ∑≤ÂéãÁº©Â∞±Áª™');
        });
        this.value = '';
    });
});

function compressImage(file, maxSize, quality, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            var w = img.width, h = img.height;
            if (w > maxSize || h > maxSize) {
                if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
                else { w = Math.round(w * maxSize / h); h = maxSize; }
            }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            callback(canvas.toDataURL('image/jpeg', quality));
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function saveWallpaper() {
    const screen = document.getElementById('phoneHomeScreen');
    if (pendingWallpaperData) {
        try {
            localStorage.setItem('homeWallpaper', pendingWallpaperData);
            screen.style.backgroundImage = "url('" + pendingWallpaperData + "')";
            screen.classList.add('has-wallpaper');
            showToast('Â£ÅÁ∫∏Â∑≤Â∫îÁî®');
        } catch (e) {
            if (e.name === 'QuotaExceededError') {
                showToast('ÂõæÁâáÂ§™Â§ßÔºåËØ∑Êç¢‰∏ÄÂº†ËæÉÂ∞èÁöÑÂõæ');
            } else { showToast('‰øùÂ≠òÂ§±Ë¥•'); }
            return;
        }
    }
    closeWallpaperModal();
}

function resetWallpaper() {
    localStorage.removeItem('homeWallpaper');
    const screen = document.getElementById('phoneHomeScreen');
    screen.style.backgroundImage = '';
    screen.classList.remove('has-wallpaper');
    document.getElementById('wallpaperPreviewImg').style.display = 'none';
    document.getElementById('wallpaperPlaceholder').style.display = '';
    pendingWallpaperData = null;
    showToast('Â∑≤ÊÅ¢Â§çÈªòËÆ§Â£ÅÁ∫∏');
    closeWallpaperModal();
}

function loadWallpaper() {
    const saved = localStorage.getItem('homeWallpaper');
    const screen = document.getElementById('phoneHomeScreen');
    if (saved && screen) {
        screen.style.backgroundImage = "url('" + saved + "')";
        screen.classList.add('has-wallpaper');
    }
}

// ==================== È°µÈù¢Ë∑≥ËΩ¨ÔºàÂÜÖÈÉ®È°µÈù¢Ôºâ ====================
function openApp(url) {
    if (navigator.vibrate) navigator.vibrate(10);
    document.getElementById('phoneHomeScreen').classList.add('page-leaving');
    setTimeout(function() { window.location.href = url; }, 300);
}

// ==================== Âî§Ëµ∑ÂéüÁîüAPP ====================
function openNativeApp(scheme, name, fallbackUrl) {
    if (navigator.vibrate) navigator.vibrate(10);

    var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    var isAndroid = /Android/.test(navigator.userAgent);

    if (isIOS) {
        window.location.href = scheme;
    } else if (isAndroid) {
        var startTime = Date.now();
        var iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = scheme;
        document.body.appendChild(iframe);
        setTimeout(function() {
            document.body.removeChild(iframe);
            if (Date.now() - startTime < 2500) {
                if (fallbackUrl) {
                    window.location.href = fallbackUrl;
                } else {
                    showToast(name + '‰ªÖÊîØÊåÅiOSËÆæÂ§áÁõ¥Êé•ÊâìÂºÄ');
                }
            }
        }, 2000);
    } else {
        if (fallbackUrl) {
            window.open(fallbackUrl, '_blank');
        } else {
            showToast(name + ' ‰ªÖÊîØÊåÅiOSËÆæÂ§áÁõ¥Êé•ÊâìÂºÄ');
        }
    }
}

// ==================== Toast ====================
function showToast(text) {
    const t = document.getElementById('homeToast');
    if (!t) return; t.textContent = text; t.classList.add('show');
    setTimeout(function() { t.classList.remove('show'); }, 2000);
}

// ==================== ÂàùÂßãÂåñ ====================
function init() {
    updateTime(); setInterval(updateTime, 30000);
    fetchWeather(); setInterval(fetchWeather, 30*60*1000);
    loadWallpaper();document.getElementById('cityModalOverlay').addEventListener('click', function(e){ if(e.target===this) closeCityModal(); });
    document.getElementById('wallpaperModalOverlay').addEventListener('click', function(e){ if(e.target===this) closeWallpaperModal(); });
    document.getElementById('cityCustomInput').addEventListener('keydown', function(e){ if(e.key==='Enter') confirmCity(); });
}
init();

// ‰øÆÂ§çËøîÂõûÁôΩÂ±èÔºöÊµèËßàÂô®bfcacheÊÅ¢Â§çÊó∂Á¶ªÂú∫Âä®Áîª‰ªçÁîüÊïà
window.addEventListener('pageshow', function(event) {
    var screen = document.getElementById('phoneHomeScreen');
    screen.classList.remove('page-leaving');
    loadWallpaper();
    updateTime();
});
</script>
</body>
</html>
