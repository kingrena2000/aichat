<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾®ä¿¡é£æ ¼å¤šAIèŠå¤© (v5.2)</title>
    <!-- Head and Style sections remain the same -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"></noscript>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              wechat: { green: '#07C160', lightGreen: '#E6F4EA', gray: '#F5F5F5', darkGray: '#E5E5E5', text: '#333333', lightText: '#888888', red: '#F43530' },
              chat: { user: '#DDF4E8', ai: '#FFFFFF' },
              diary: { bg: '#FDFCF7', border: '#F0EAD6', text: '#6B4F4F' }
            },
            fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'] },
          },
        }
      }
    </script>
    <style type="text/tailwindcss">
      @layer utilities {
        .chat-bubble-user { @apply bg-chat-user rounded-2xl rounded-tr-none px-4 py-2 max-w-[80%] shadow-sm; }
        .chat-bubble-ai { @apply bg-chat-ai rounded-2xl rounded-tl-none px-4 py-2 max-w-[80%] shadow-sm border border-wechat-darkGray; }
        .nav-item-active { @apply text-wechat-green; }
        .input-focus { @apply ring-2 ring-wechat-green/30 outline-none; }
        .avatar-preview { @apply w-16 h-16 rounded-full object-cover border-2 border-wechat-green/50 cursor-pointer transition-all hover:border-wechat-green; }
        .avatar-upload-btn { @apply w-full bg-wechat-gray hover:bg-wechat-darkGray text-wechat-text py-2 rounded-lg text-sm transition-colors; }
        .typing-indicator { @apply text-center text-wechat-lightText text-sm py-2 px-4 opacity-0 pointer-events-none transition-opacity duration-300; }
        .typing-indicator.show { @apply opacity-100 pointer-events-auto; }
        .slide-delete-btn { @apply w-20 h-full bg-wechat-red text-white flex items-center justify-center transition-transform duration-300 transform translate-x-full; }
        .chat-item-wrapper { @apply flex items-center justify-between bg-white transition-transform duration-300; }
        .chat-item-wrapper.swipe-left { @apply transform -translate-x-20; }
        .chat-detail-header { @apply bg-[#ECE5DD] py-6 flex flex-col items-center; }
        .chat-item-actions { @apply absolute right-4 top-1/2 transform -translate-y-1/2 flex gap-2 opacity-0 transition-opacity duration-300; }
        .chat-item-container:hover .chat-item-actions { @apply opacity-100; }
        .delete-action-btn { @apply bg-wechat-red/10 text-wechat-red p-1.5 rounded-full hover:bg-wechat-red/20 transition-colors; }
        .edit-action-btn { @apply bg-wechat-green/10 text-wechat-green p-1.5 rounded-full hover:bg-wechat-green/20 transition-colors; }
        .user-avatar-small { @apply w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-white flex-shrink-0; }
        .message-context-menu { @apply absolute bg-white shadow-lg rounded-md p-2 z-50 text-sm; }


        .diary-entry-card { @apply bg-diary-bg border border-diary-border rounded-lg p-4 mb-4 shadow-sm break-words; }
      }
    </style>
    <style>
/* ========== è¡¨æƒ…åŠŸèƒ½æ ·å¼ ========== */
.sticker-panel {
    position: absolute;
    bottom: 100%;
    left: 0;
    width: 320px;
    max-height: 350px;
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    display: none;
    flex-direction: column;
    margin-bottom: 8px;
    z-index: 20;
}
.sticker-panel.show { display: flex; }
.sticker-tabs {
    display: flex;
    border-bottom: 1px solid #e5e5e5;
}
.sticker-tab {
    flex: 1;
    padding: 10px;
    border: none;
    background: transparent;
    color: #888;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.3s;
}
.sticker-tab.active {
    color: #07C160;
    border-bottom: 2px solid #07C160;
    margin-bottom: -1px;
}
.sticker-content {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    max-height: 250px;
}
.sticker-section { display: none; }
.sticker-section.active { display: block; }
.emoji-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 4px;
}
.emoji-item {
    width: 100%;
    aspect-ratio: 1;
    border: none;
    background: transparent;
    font-size: 22px;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}
.emoji-item:hover {
    background: #f0f0f0;
    transform: scale(1.15);
}
.sticker-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
}
.sticker-item {
    aspect-ratio: 1;
    border: 2px solid transparent;
    background: #f5f5f5;
    border-radius: 8px;
    cursor: pointer;
    overflow: hidden;
    transition: all 0.2s;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}
.sticker-item:hover {
    border-color: #07C160;
    transform: scale(1.05);
}
.sticker-item img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}
.sticker-item .sticker-name {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.6);
    font-size: 10px;
    padding: 2px;
    text-align: center;
    color: #fff;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.sticker-item .delete-sticker-btn {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 18px;
    height: 18px;
    background: rgba(244,53,48,0.9);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 10px;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
}
.sticker-item:hover .delete-sticker-btn { display: flex; }
.sticker-manage-bar {
    border-top: 1px solid #e5e5e5;
    padding: 8px;
    display: flex;
    gap: 6px;
}
.sticker-manage-btn {
    flex: 1;
    padding: 8px;
    border: 1px dashed #ccc;
    background: transparent;
    color: #666;
    border-radius: 6px;
    cursor: pointer;
    font-size: 11px;
    transition: all 0.3s;
}
.sticker-manage-btn:hover {
    border-color: #07C160;
    color: #07C160;
    background: rgba(7,193,96,0.05);
}
.sticker-tool-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: #f5f5f5;
    color: #666;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.sticker-tool-btn:hover { background: #e5e5e5; }
.sticker-tool-btn.active { background: #07C160; color: white; }
.message-sticker {
    max-width: 120px;
    max-height: 120px;
    border-radius: 6px;
    vertical-align: middle;
    cursor: pointer;
}
.message-sticker:hover { transform: scale(1.03); }
.sticker-upload-preview-box {
    width: 80px;
    height: 80px;
    border: 2px dashed #ccc;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 12px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s;
}
.sticker-upload-preview-box:hover { border-color: #07C160; }
.sticker-upload-preview-box img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}
.import-format-hint {
    background: rgba(7,193,96,0.1);
    border: 1px solid rgba(7,193,96,0.3);
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
}
.import-format-hint-title {
    font-size: 12px;
    color: #07C160;
    margin-bottom: 6px;
    font-weight: 500;
}
.import-format-hint-code {
    font-family: monospace;
    font-size: 11px;
    color: #666;
    background: #f9f9f9;
    padding: 8px;
    border-radius: 4px;
    white-space: pre-wrap;
    word-break: break-all;
}
.sticker-empty-state {
    text-align: center;
    padding: 30px 15px;
    color: #999;
}
.sticker-empty-state i { font-size: 32px; margin-bottom: 10px; display: block; opacity: 0.5; }
.sticker-empty-state p { font-size: 12px; }

      html, body { height: 100%; overflow: hidden; -webkit-overflow-scrolling: touch; }
      @supports (padding-bottom: constant(safe-area-inset-bottom)) or (padding-bottom: env(safe-area-inset-bottom)) {
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .nav-safe-area { padding-bottom: calc(0.5rem + env(safe-area-inset-bottom)); }
      }
      .chat-input-container { position: fixed; bottom: 0; left: 0; right: 0; z-index: 10; }
      .chat-content, .chat-list-container, .diary-list-container, .diary-entries-container { overflow-y: auto; -webkit-overflow-scrolling: touch; }
      .chat-page { display: flex; flex-direction: column; height: 100vh; }
      .chat-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
      input[type="checkbox"] { flex-shrink: 0; }
      button:disabled { opacity: 0.7; cursor: not-allowed; }
    </style>
</head>
<body class="bg-wechat-gray font-sans text-wechat-text">
<div class="h-screen overflow-hidden">
    <!-- HTML structure remains identical -->
    <div id="chatListPage" class="h-full flex flex-col"><header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10"><h1 class="text-lg font-semibold">AIèŠå¤©åŠ©æ‰‹</h1><button id="addChatBtn" class="text-wechat-text p-2 rounded-full hover:bg-wechat-gray transition-colors"><i class="fa fa-plus"></i></button></header><div id="chatListContainer" class="flex-1 chat-list-container bg-white"><div id="emptyChatList" class="flex flex-col items-center justify-center h-full text-wechat-lightText py-10"><i class="fa fa-comments-o text-4xl mb-3 opacity-50"></i><p class="text-sm">æš‚æ— èŠå¤©å¯¹è±¡ï¼Œç‚¹å‡»å³ä¸Šè§’"+"æ·»åŠ </p></div></div><nav class="bg-white border-t border-wechat-darkGray flex nav-safe-area"><button id="chatNavBtn" class="flex-1 py-3 flex flex-col items-center justify-center nav-item-active"><i class="fa fa-comments text-lg"></i><span class="text-xs mt-1">èŠå¤©</span></button><button id="diaryNavBtn" class="flex-1 py-3 flex flex-col items-center justify-center text-wechat-lightText"><i class="fa fa-book text-lg"></i><span class="text-xs mt-1">æ—¥è®°</span></button><button id="settingsNavBtn" class="flex-1 py-3 flex flex-col items-center justify-center text-wechat-lightText"><i class="fa fa-cog text-lg"></i><span class="text-xs mt-1">è®¾ç½®</span></button></nav></div>
    <div id="chatPage" class="chat-page hidden"><header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10"><div class="flex items-center"><button id="backToChatListBtn" class="text-wechat-text p-2 mr-2"><i class="fa fa-arrow-left"></i></button><div class="flex items-center"><div id="chatPageAvatar" class="w-8 h-8 rounded-full overflow-hidden mr-2"></div><h1 id="chatPageTitle" class="text-lg font-semibold">èŠå¤©å¯¹è±¡</h1></div></div><button id="chatPageMoreBtn" class="text-wechat-text p-2 rounded-full hover:bg-wechat-gray transition-colors"><i class="fa fa-ellipsis-v"></i></button></header><main class="chat-main"><div id="chatPageTypingIndicator" class="typing-indicator"><span id="chatPageTypingText">æ­£åœ¨è¾“å…¥ä¸­...</span></div><div id="chatPageContainer" class="chat-content p-4 bg-[#ECE5DD]"></div>

<div class="chat-input-container bg-white border-t border-wechat-darkGray p-3 safe-area-bottom">
    <div class="flex items-center gap-2" style="position: relative;">
        <!-- è¡¨æƒ…é¢æ¿ -->
        <div class="sticker-panel" id="stickerPanel">
            <div class="sticker-tabs">
                <button class="sticker-tab active" id="emojiTabBtn">ğŸ˜€ Emoji</button>
                <button class="sticker-tab" id="customStickerTabBtn">ğŸ–¼ï¸ è¡¨æƒ…å›¾</button>
            </div>
            <div class="sticker-content">
                <div class="sticker-section active" id="emojiSection">
                    <div class="emoji-grid" id="emojiGrid"></div>
                </div>
                <div class="sticker-section" id="customStickerSection">
                    <div class="sticker-grid" id="stickerGrid"></div>
                    <div class="sticker-empty-state" id="stickerEmptyHint" style="display:none;">
                        <i class="fa fa-picture-o"></i>
                        <p>è¿˜æ²¡æœ‰è¡¨æƒ…å›¾<br>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </p>
                    </div>
                </div>
            </div>
            <div class="sticker-manage-bar">
                <button class="sticker-manage-btn" id="addStickerUploadBtn"><i class="fa fa-upload"></i> ä¸Šä¼ </button>
                <button class="sticker-manage-btn" id="addStickerUrlBtn"><i class="fa fa-link"></i> URL</button>
                <button class="sticker-manage-btn" id="addStickerImportBtn"><i class="fa fa-download"></i> å¯¼å…¥</button>
            </div>
        </div>
        
        <button class="sticker-tool-btn" id="stickerToggleBtn"><i class="fa fa-smile-o"></i></button>
        <textarea id="chatPageMessageInput" class="flex-1 border border-wechat-darkGray rounded-full px-4 py-2 text-sm resize-none focus:input-focus transition-all" placeholder="è¾“å…¥æ¶ˆæ¯... ç”¨ :åç§°: å‘è¡¨æƒ…" rows="1"></textarea>
        <button id="chatPageSendBtn" class="w-10 h-10 rounded-full bg-wechat-green flex items-center justify-center text-white"><i class="fa fa-paper-plane"></i></button>
    </div>
</div>
</main></div>

    <div id="settingsPage" class="fixed inset-0 bg-white z-20 transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto safe-area-bottom"><div class="p-4 border-b border-wechat-darkGray flex items-center justify-between sticky top-0 bg-white z-10"><h2 class="text-lg font-semibold">è®¾ç½®</h2><button id="closeSettingsBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button></div><div class="p-4 space-y-8 pb-20"><div class="space-y-6"><h3 class="text-base font-semibold text-wechat-text border-b border-wechat-darkGray pb-2">ç”¨æˆ·ä¿¡æ¯è®¾ç½®</h3><div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">ä½ çš„å¤´åƒ</label><div class="flex flex-col items-center"><div class="relative mb-3"><img id="userAvatarPreview" class="avatar-preview" alt="ä½ çš„å¤´åƒé¢„è§ˆ"><i id="userAvatarIcon" class="fa fa-user absolute inset-0 flex items-center justify-center text-white text-xl bg-gray-400 rounded-full"></i></div><div class="flex gap-3 w-full max-w-xs"><label class="flex-1 text-center"><input type="file" id="userAvatarUpload" accept="image/*" class="hidden"><button type="button" class="avatar-upload-btn" onclick="document.getElementById('userAvatarUpload').click()"><i class="fa fa-upload mr-1"></i> æœ¬åœ°ä¸Šä¼ </button></label><button type="button" class="flex-1 avatar-upload-btn" id="userAvatarUrlBtn"><i class="fa fa-link mr-1"></i> è¾“å…¥URL</button></div><div id="userAvatarUrlContainer" class="w-full max-w-xs mt-3 hidden"><input type="url" id="userAvatarUrl" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="è¾“å…¥å¤´åƒå›¾ç‰‡URL"><div class="flex gap-2 mt-2"><button type="button" class="flex-1 bg-wechat-green text-white py-2 rounded-lg text-sm" id="userAvatarUrlConfirm">ç¡®è®¤</button><button type="button" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm" id="userAvatarUrlCancel">å–æ¶ˆ</button></div></div></div></div><div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">ä½ çš„åç§°<span class="text-xs text-wechat-lightText ml-1">(å‘é€ç»™APIä½¿ç”¨)</span></label><input type="text" id="userName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="è¾“å…¥ä½ çš„åç§°" value="user"></div></div><div class="space-y-6"><h3 class="text-base font-semibold text-wechat-text border-b border-wechat-darkGray pb-2">APIä¸æ¨¡å‹é…ç½®</h3><form id="settingsForm" class="space-y-4"><div><label class="block text-sm font-medium text-wechat-text mb-1">API Base URL</label><input type="url" id="baseUrl" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="https://api.openai.com/v1" value="https://api.openai.com/v1"></div><div><label class="block text-sm font-medium text-wechat-text mb-1">API Key</label><input type="password" id="apiKey" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="sk-..."></div>
<div><label class="block text-sm font-medium text-wechat-text mb-1">æ¨¡å‹åç§°</label><div class="flex gap-2"><select id="modelName" class="flex-1 border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus"></select><button type="button" id="refreshModelsBtn" class="bg-wechat-green/10 text-wechat-green px-3 py-2 rounded-lg hover:bg-wechat-green/20 transition-colors"><i class="fa fa-refresh"></i></button></div><p class="text-xs text-wechat-lightText mt-1">å¡«å†™APIåœ°å€å’ŒKeyåï¼Œç‚¹å‡»åˆ·æ–°æŒ‰é’®è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨</p></div>
<div><label for="apiTemperature" class="block text-sm font-medium text-wechat-text mb-1">æ¨¡å‹æ¸©åº¦ (Temperature)</label><input type="number" id="apiTemperature" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ä¾‹å¦‚: 0.7" value="0.7" min="0" max="2" step="0.1"><p class="text-xs text-wechat-lightText mt-1">æ§åˆ¶å›ç­”çš„éšæœºæ€§ã€‚å€¼è¶Šé«˜(å¦‚ 1.2)å›ç­”è¶Šæœ‰åˆ›æ„ï¼Œå€¼è¶Šä½(å¦‚ 0.2)å›ç­”è¶Šç¨³å®šã€‚é»˜è®¤ 0.7ã€‚</p></div><div><label class="block text-sm font-medium text-wechat-text mb-1">å•æ¬¡ä¸Šä¸‹æ–‡è½®æ¬¡ (çŸ­æœŸè®°å¿†)</label><input type="number" id="historyTurns" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ä¾‹å¦‚: 10" value="10" min="0"><p class="text-xs text-wechat-lightText mt-1">æ¯æ¬¡è¯·æ±‚APIæ—¶ï¼Œè¯»å–æœ€è¿‘çš„Nè½®å¯¹è¯ã€‚0æˆ–ç©ºè¡¨ç¤ºä¸é™åˆ¶ã€‚</p></div><div><label class="block text-sm font-medium text-wechat-text mb-1">æ—¥è®°ç”Ÿæˆé¢‘ç‡ (è½®)</label><input type="number" id="diaryGenerationTurns" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ä¾‹å¦‚: 30" value="30" min="0"><p class="text-xs text-wechat-lightText mt-1">æ¯éš”Nè½®å¯¹è¯ (Næ¬¡AIå›å¤)ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ç¯‡æ—¥è®°ã€‚0è¡¨ç¤ºç¦ç”¨ã€‚</p></div><div><label for="globalSystemPrompt" class="block text-sm font-medium text-wechat-text mb-1">å…¨å±€ç³»ç»Ÿæç¤ºè¯</label><textarea id="globalSystemPrompt" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm resize-none focus:input-focus h-48" placeholder="å®šä¹‰å…¨å±€è§„åˆ™ï¼Œå¯¹æ‰€æœ‰èŠå¤©å¯¹è±¡ç”Ÿæ•ˆ..."></textarea><p class="text-xs text-wechat-lightText mt-1">æ­¤æç¤ºè¯æ‹¥æœ‰æœ€é«˜ä¼˜å…ˆçº§ï¼Œå°†ä¸æ¯ä¸ªèŠå¤©å¯¹è±¡çš„äººè®¾æç¤ºè¯åˆå¹¶åå‘é€ç»™AIã€‚</p></div><button type="submit" class="w-full bg-wechat-green text-white py-3 rounded-lg font-medium hover:bg-wechat-green/90 transition-colors">ä¿å­˜æ‰€æœ‰è®¾ç½®</button></form></div><div class="space-y-6"><h3 class="text-base font-semibold text-wechat-text border-b border-wechat-darkGray pb-2">æ•°æ®å¤‡ä»½ä¸æ¢å¤</h3><p class="text-sm text-wechat-lightText">æ‚¨å¯ä»¥å°†å…¨éƒ¨èŠå¤©æ•°æ®ï¼ˆåŒ…å«èŠå¤©è®°å½•ã€å¯¹è±¡è®¾å®šã€æ—¥è®°ã€å…¨å±€é…ç½®å’Œå¤´åƒï¼‰å¤‡ä»½åˆ°ä¸€ä¸ªå‹ç¼©æ–‡ä»¶(`.zip`)ä¸­ã€‚</p><div class="flex gap-3"><button type="button" id="backupDataBtn" class="flex-1 bg-wechat-green/10 text-wechat-green py-3 rounded-lg font-medium hover:bg-wechat-green/20 transition-colors"><i class="fa fa-download mr-2"></i><span>å¤‡ä»½å…¨éƒ¨æ•°æ®</span></button><button type="button" id="restoreDataBtn" class="flex-1 bg-wechat-green/10 text-wechat-green py-3 rounded-lg font-medium hover:bg-wechat-green/20 transition-colors"><i class="fa fa-upload mr-2"></i><span>ä»æ–‡ä»¶æ¢å¤</span></button><input type="file" id="restoreFileInput" class="hidden" accept=".zip"></div><div class="text-xs text-wechat-lightText space-y-1"><p class="flex items-start"><i class="fa fa-info-circle mr-2 mt-0.5 flex-shrink-0"></i><span class="font-semibold">å…³äºå¤‡ä»½è·¯å¾„ï¼š</span>ç‚¹å‡»å¤‡ä»½åï¼Œæµè§ˆå™¨å°†è‡ªåŠ¨ä¸‹è½½æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶é€šå¸¸ä¼šä¿å­˜åˆ°æ‚¨æµè§ˆå™¨è®¾ç½®çš„**é»˜è®¤â€œä¸‹è½½â€æ–‡ä»¶å¤¹**ä¸­ã€‚</p><p class="flex items-start"><i class="fa fa-lightbulb-o mr-2 mt-0.5 flex-shrink-0"></i><span class="font-semibold">æ¢å¤æ“ä½œæç¤ºï¼š</span>ç‚¹å‡»æ¢å¤åï¼Œè¯·åœ¨å¼¹å‡ºçš„æ–‡ä»¶é€‰æ‹©çª—å£ä¸­ï¼Œ**æ‰‹åŠ¨å¯¼èˆªåˆ°æ‚¨çš„â€œä¸‹è½½â€æ–‡ä»¶å¤¹**æ¥æ‰¾åˆ°ä¹‹å‰çš„å¤‡ä»½æ–‡ä»¶ã€‚</p></div></div><div class="space-y-6"><h3 class="text-base font-semibold text-wechat-text border-b border-wechat-darkGray pb-2">è¯Šæ–­ä¸è°ƒè¯•</h3><p class="text-sm text-wechat-lightText">å¦‚æœé‡åˆ°åŠŸèƒ½å¼‚å¸¸ï¼Œå¯ä»¥æŸ¥çœ‹å†…éƒ¨æ—¥å¿—ä»¥å¸®åŠ©å®šä½é—®é¢˜ã€‚</p><div class="flex gap-3"><button type="button" id="viewLogsBtn" class="flex-1 bg-wechat-green/10 text-wechat-green py-3 rounded-lg font-medium hover:bg-wechat-green/20 transition-colors"><i class="fa fa-file-text-o mr-2"></i>æŸ¥çœ‹è¯Šæ–­æ—¥å¿—</button><button type="button" id="clearLogsBtn" class="flex-1 bg-wechat-red/10 text-wechat-red py-3 rounded-lg font-medium hover:bg-wechat-red/20 transition-colors"><i class="fa fa-eraser mr-2"></i>æ¸…ç©ºæ—¥å¿—</button></div></div></div></div>
    <div id="diaryListPage" class="fixed inset-0 bg-white z-20 transform translate-x-full transition-transform duration-300 ease-in-out h-full flex flex-col"><header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10"><h1 class="text-lg font-semibold">æ—¥è®°æœ¬</h1><button id="closeDiaryListPageBtn" class="text-wechat-text p-2 rounded-full hover:bg-wechat-gray transition-colors"><i class="fa fa-times"></i></button></header><div id="diaryListContainer" class="flex-1 diary-list-container bg-white"></div></div>
    <div id="diaryDetailPage" class="fixed inset-0 bg-white z-30 transform translate-x-full transition-transform duration-300 ease-in-out h-full flex flex-col"><header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10"><div class="flex items-center"><button id="backToDiaryListBtn" class="text-wechat-text p-2 mr-2"><i class="fa fa-arrow-left"></i></button><h1 id="diaryDetailPageTitle" class="text-lg font-semibold"></h1></div><div class="flex items-center gap-2"><button id="resetDiaryPtrBtn" title="å¦‚æœæ€»ç»“åŠŸèƒ½å¤±æ•ˆï¼Œè¯·å…ˆç‚¹å‡»æ­¤æŒ‰é’®" class="bg-wechat-red/10 text-wechat-red text-xs font-semibold py-1 px-3 rounded-full hover:bg-wechat-red/20 transition-colors"><i class="fa fa-history mr-1"></i>é‡ç½®æŒ‡é’ˆ</button><button id="manualDiaryBtn" class="bg-wechat-green/10 text-wechat-green text-xs font-semibold py-1 px-3 rounded-full hover:bg-wechat-green/20 transition-colors"><i class="fa fa-pencil-square-o mr-1"></i>æ‰‹åŠ¨æ€»ç»“</button></div></header><div id="diaryEntriesContainer" class="flex-1 diary-entries-container p-4 bg-diary-bg/50"></div></div>
    <div id="editDiaryEntryModal" class="fixed inset-0 bg-black/50 z-40 flex items-center justify-center hidden"><div class="bg-white rounded-lg w-[90%] max-w-lg"><div class="p-4 border-b border-wechat-darkGray flex items-center justify-between"><h2 class="text-lg font-semibold">ç¼–è¾‘æ—¥è®°</h2><button id="closeEditDiaryModalBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button></div><div class="p-4"><textarea id="editDiaryEntryText" class="w-full border border-wechat-darkGray rounded-lg p-3 text-sm focus:input-focus" rows="10"></textarea></div><div class="p-4 border-t border-wechat-darkGray flex justify-end gap-3"><button id="cancelEditDiaryBtn" class="bg-wechat-gray text-wechat-text py-2 px-4 rounded-lg text-sm">å–æ¶ˆ</button><button id="saveEditDiaryBtn" class="bg-wechat-green text-white py-2 px-4 rounded-lg text-sm">ä¿å­˜</button></div></div></div>
<!-- æ·»åŠ è¡¨æƒ…æ¨¡æ€æ¡† -->
<div id="addStickerModal" class="fixed inset-0 bg-black/50 z-40 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg w-[90%] max-w-md">
        <div class="p-4 border-b border-wechat-darkGray flex items-center justify-between">
            <h2 class="text-lg font-semibold" id="addStickerModalTitle">æ·»åŠ è¡¨æƒ…å›¾</h2>
            <button id="closeAddStickerModalBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button>
        </div>
        <div class="p-4">
            <!-- ä¸Šä¼ æ–¹å¼ -->
            <div id="stickerUploadSection" class="sticker-add-section">
                <div class="sticker-upload-preview-box" id="stickerUploadPreviewBox">
                    <span id="stickerUploadPlaceholder" style="color:#999;font-size:24px;">â•</span>
                    <img src="" alt="" id="stickerUploadPreviewImg" style="display:none;">
                </div>
                <input type="file" id="stickerFileInput" accept="image/*" style="display:none;">
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-wechat-text mb-1">è¡¨æƒ…åç§° *</label>
                        <input type="text" id="uploadStickerName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ä¾‹å¦‚ï¼šå¼€å¿ƒ">
                        <p class="text-xs text-wechat-lightText mt-1">ä½¿ç”¨ :åç§°: å³å¯å‘é€æ­¤è¡¨æƒ…</p>
                    </div>
                </div>
            </div>

            <!-- URLæ–¹å¼ -->
            <div id="stickerUrlSection" class="sticker-add-section" style="display:none;">
                <div class="sticker-upload-preview-box" id="stickerUrlPreviewBox">
                    <span id="stickerUrlPlaceholder" style="color:#999;font-size:24px;">ğŸ”—</span>
                    <img src="" alt="" id="stickerUrlPreviewImg" style="display:none;">
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-wechat-text mb-1">å›¾ç‰‡URL *</label>
                        <input type="url" id="stickerUrlInput" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="https://example.com/sticker.gif">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-wechat-text mb-1">è¡¨æƒ…åç§° *</label>
                        <input type="text" id="urlStickerName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ä¾‹å¦‚ï¼šå¼€å¿ƒ">
                        <p class="text-xs text-wechat-lightText mt-1">ä½¿ç”¨ :åç§°: å³å¯å‘é€æ­¤è¡¨æƒ…</p>
                    </div>
                </div>
            </div>

            <!-- æ‰¹é‡å¯¼å…¥æ–¹å¼ -->
            <div id="stickerImportSection" class="sticker-add-section" style="display:none;">
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-wechat-text mb-1">æ‰¹é‡å¯¼å…¥</label>
                        <textarea id="stickerImportText" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" rows="6" placeholder="æ¯è¡Œä¸€ä¸ªè¡¨æƒ…ï¼Œæ ¼å¼ï¼šåç§°:URL"></textarea>
                    </div>
                    <div class="import-format-hint">
                        <div class="import-format-hint-title">ğŸ“‹ å¯¼å…¥æ ¼å¼ç¤ºä¾‹</div>
                        <div class="import-format-hint-code">æ€¨å¿µ:https://files.catbox.moe/q72pav.gif
å¼€å¿ƒ:https://example.com/happy.gif
éš¾è¿‡:https://example.com/sad.png</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-4 border-t border-wechat-darkGray flex justify-end gap-3">
            <button id="cancelAddStickerBtn" class="bg-wechat-gray text-wechat-text py-2 px-4 rounded-lg text-sm">å–æ¶ˆ</button>
            <button id="confirmAddStickerBtn" class="bg-wechat-green text-white py-2 px-4 rounded-lg text-sm">æ·»åŠ è¡¨æƒ…</button>
        </div>
    </div>
</div>

<!-- è¡¨æƒ…å›¾ç‰‡å…¨å±é¢„è§ˆ -->
<div id="stickerFullViewModal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center cursor-zoom-out">
    <img src="" alt="" id="stickerFullViewImg" style="max-width:90%;max-height:90%;object-fit:contain;border-radius:8px;">
</div>
    <div id="addChatModal" class="fixed inset-0 bg-black/50 z-30 flex items-center justify-center hidden"><div class="bg-white rounded-lg w-[90%] max-w-md max-h-[85vh] overflow-y-auto safe-area-bottom"><div class="p-4 border-b border-wechat-darkGray flex items-center justify-between sticky top-0 bg-white z-10"><h2 class="text-lg font-semibold">æ–°å¢èŠå¤©å¯¹è±¡</h2><button id="closeAddChatModalBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button></div><div class="p-4 space-y-6 pb-10"><div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">èŠå¤©å¯¹è±¡å¤´åƒ</label><div class="flex flex-col items-center"><div class="relative mb-3"><img id="newChatAvatarPreview" class="avatar-preview" alt="å¤´åƒé¢„è§ˆ"><i id="newChatAvatarIcon" class="fa fa-robot absolute inset-0 flex items-center justify-center text-white text-xl bg-wechat-green rounded-full"></i></div><div class="flex gap-3 w-full max-w-xs"><label class="flex-1 text-center"><input type="file" id="newChatAvatarUpload" accept="image/*" class="hidden"><button type="button" class="avatar-upload-btn" onclick="document.getElementById('newChatAvatarUpload').click()"><i class="fa fa-upload mr-1"></i> æœ¬åœ°ä¸Šä¼ </button></label><button type="button" class="flex-1 avatar-upload-btn" id="newChatAvatarUrlBtn"><i class="fa fa-link mr-1"></i> è¾“å…¥URL</button></div><div id="newChatAvatarUrlContainer" class="w-full max-w-xs mt-3 hidden"><input type="url" id="newChatAvatarUrl" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="è¾“å…¥å¤´åƒå›¾ç‰‡URL"><div class="flex gap-2 mt-2"><button type="button" class="flex-1 bg-wechat-green text-white py-2 rounded-lg text-sm" id="newChatAvatarUrlConfirm">ç¡®è®¤</button><button type="button" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm" id="newChatAvatarUrlCancel">å–æ¶ˆ</button></div></div></div></div><div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">èŠå¤©å¯¹è±¡åç§°</label><input type="text" id="newChatName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ä¾‹å¦‚ï¼šç¼–ç¨‹é«˜æ‰‹" value="AIåŠ©æ‰‹"></div><div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">äººè®¾æç¤ºè¯</label><textarea id="newChatSystemPrompt" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm resize-none focus:input-focus h-32" placeholder="æè¿°AIçš„è§’è‰²ã€æ€§æ ¼ã€è¯´è¯é£æ ¼..."></textarea></div><button type="button" id="createChatBtn" class="w-full bg-wechat-green text-white py-3 rounded-lg font-medium hover:bg-wechat-green/90 transition-colors">åˆ›å»ºèŠå¤©</button></div></div></div>
    <div id="chatDetailPage" class="fixed inset-0 bg-white z-30 flex flex-col h-full transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto safe-area-bottom"><header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10"><button id="backToChatPageBtn" class="text-wechat-text p-2 mr-2"><i class="fa fa-arrow-left"></i></button><h2 class="text-lg font-semibold">èŠå¤©å¯¹è±¡è¯¦æƒ…</h2><button id="deleteChatBtn" class="text-wechat-red p-2 mr-2" title="ä»åˆ—è¡¨ç§»é™¤"><i class="fa fa-trash"></i></button></header><div class="flex-1 overflow-y-auto pb-20"><div class="chat-detail-header"><div class="relative mb-3"><img id="editChatAvatarPreview" class="avatar-preview" alt="å¤´åƒé¢„è§ˆ"><i id="editChatAvatarIcon" class="fa fa-robot absolute inset-0 flex items-center justify-center text-white text-xl bg-wechat-green rounded-full"></i></div><button type="button" id="editAvatarBtn" class="text-wechat-green text-sm"><i class="fa fa-camera mr-1"></i> æ›´æ¢å¤´åƒ</button></div><div class="p-4 space-y-6"><div id="editAvatarContainer" class="space-y-3 hidden"><div class="flex gap-3 w-full max-w-xs mx-auto"><label class="flex-1 text-center"><input type="file" id="editChatAvatarUpload" accept="image/*" class="hidden"><button type="button" class="avatar-upload-btn" onclick="document.getElementById('editChatAvatarUpload').click()"><i class="fa fa-upload mr-1"></i> æœ¬åœ°ä¸Šä¼ </button></label><button type="button" class="flex-1 avatar-upload-btn" id="editChatAvatarUrlBtn"><i class="fa fa-link mr-1"></i> è¾“å…¥URL</button></div><div id="editChatAvatarUrlContainer" class="w-full max-w-xs mx-auto hidden"><input type="url" id="editChatAvatarUrl" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="è¾“å…¥å¤´åƒå›¾ç‰‡URL"><div class="flex gap-2 mt-2"><button type="button" class="flex-1 bg-wechat-green text-white py-2 rounded-lg text-sm" id="editChatAvatarUrlConfirm">ç¡®è®¤</button><button type="button" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm" id="editChatAvatarUrlCancel">å–æ¶ˆ</button></div></div><button type="button" class="w-full max-w-xs mx-auto bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm" id="cancelEditAvatarBtn">å–æ¶ˆæ›´æ¢</button></div><div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">èŠå¤©å¯¹è±¡åç§°</label><input type="text" id="editChatName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="è¾“å…¥èŠå¤©å¯¹è±¡çš„åç§°"></div><div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">äººè®¾æç¤ºè¯</label><textarea id="editChatSystemPrompt" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm resize-none focus:input-focus h-32" placeholder="æè¿°AIçš„è§’è‰²ã€æ€§æ ¼ã€è¯´è¯é£æ ¼..."></textarea></div><button type="button" id="saveChatDetailBtn" class="w-full bg-wechat-green text-white py-3 rounded-lg font-medium hover:bg-wechat-green/90 transition-colors">ä¿å­˜ä¿®æ”¹</button></div></div></div>
    <div id="confirmDeleteModal" class="fixed inset-0 bg-black/50 z-40 flex items-center justify-center hidden"><div class="bg-white rounded-lg w-[80%] max-w-sm p-4"><h3 class="text-lg font-semibold text-center mb-4">ä»åˆ—è¡¨ç§»é™¤</h3><p class="text-center text-wechat-text mb-6">ç¡®å®šè¦ä»åˆ—è¡¨ä¸­ç§»é™¤æ­¤èŠå¤©å—ï¼Ÿæ‚¨ä¹‹åå¯ä»¥é€šè¿‡å¤‡ä»½æ–‡ä»¶æ¢å¤ã€‚</p><div class="flex gap-3"><button type="button" id="cancelDeleteBtn" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm">å–æ¶ˆ</button><button type="button" id="confirmDeleteBtn" class="flex-1 bg-wechat-red text-white py-2 rounded-lg text-sm">ç¡®è®¤ç§»é™¤</button></div></div></div>
    <div id="messageContextMenu" class="message-context-menu hidden"><button id="editMessageBtn" class="w-full text-left px-2 py-1 hover:bg-wechat-gray rounded"><i class="fa fa-pencil mr-2"></i>ä¿®æ”¹</button><button id="resendMessageBtn" class="w-full text-left px-2 py-1 hover:bg-wechat-gray rounded"><i class="fa fa-send mr-2"></i>é‡æ–°å‘é€</button><button id="regenerateMessageBtn" class="w-full text-left px-2 py-1 hover:bg-wechat-gray rounded"><i class="fa fa-refresh mr-2"></i>é‡æ–°ç”Ÿæˆ</button><button id="deleteMessageBtn" class="w-full text-left px-2 py-1 hover:bg-wechat-gray rounded text-wechat-red"><i class="fa fa-trash mr-2"></i>åˆ é™¤</button></div>
    <div id="restoreModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden"><div class="bg-white rounded-lg w-[90%] max-w-md max-h-[85vh] flex flex-col"><div class="p-4 border-b border-wechat-darkGray flex items-center justify-between sticky top-0 bg-white z-10"><h2 class="text-lg font-semibold">ä»å¤‡ä»½æ¢å¤</h2><button id="closeRestoreModalBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button></div><div class="p-4 flex-1 overflow-y-auto space-y-4"><p class="text-sm text-wechat-lightText">å·²åœ¨å¤‡ä»½æ–‡ä»¶ä¸­æ£€æµ‹åˆ°ä»¥ä¸‹èŠå¤©ï¼Œè¯·é€‰æ‹©æ‚¨å¸Œæœ›æ¢å¤çš„èŠå¤©å¯¹è±¡ã€‚æ¢å¤å°†è¦†ç›–ç°æœ‰åŒåå¯¹è±¡æˆ–æ·»åŠ æ–°å¯¹è±¡ã€‚</p><div class="space-y-2 max-h-64 overflow-y-auto border-y border-wechat-darkGray py-2" id="restoreChatList"></div><label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="restoreSelectAll" class="rounded border-gray-300 text-wechat-green focus:ring-wechat-green"><span class="text-sm">å…¨é€‰/å…¨ä¸é€‰</span></label></div><div class="p-4 border-t border-wechat-darkGray flex gap-3"><button type="button" id="cancelRestoreBtn" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm">å–æ¶ˆ</button><button type="button" id="confirmRestoreBtn" class="flex-1 bg-wechat-green text-white py-2 rounded-lg text-sm">ç¡®è®¤æ¢å¤</button></div></div></div>
    <div id="logModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center hidden p-4"><div class="bg-white rounded-lg w-full h-full max-w-4xl max-h-[90vh] flex flex-col"><div class="p-4 border-b border-wechat-darkGray flex items-center justify-between"><h2 class="text-lg font-semibold">è¯Šæ–­æ—¥å¿—</h2><button id="closeLogModalBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button></div><div class="p-4 flex-1 overflow-y-auto"><textarea id="logOutput" readonly class="w-full h-full text-xs font-mono bg-wechat-gray p-2 rounded-md border border-wechat-darkGray resize-none"></textarea></div><div class="p-4 border-t border-wechat-darkGray text-center text-xs text-wechat-lightText">è¯·å¤åˆ¶ä»¥ä¸Šæ‰€æœ‰å†…å®¹å‘é€ç»™æˆ‘ï¼Œä»¥å¸®åŠ©è¯Šæ–­é—®é¢˜ã€‚</div></div></div>
</div>

<script>
// =========================================================================
//  VERSION 4.0 (with Robust Retry & Logging)
// =========================================================================

// é»˜è®¤é…ç½®ï¼Œä½œä¸ºæ–°è®¾ç½®çš„åŸºå‡†å’Œæ—§æ•°æ®å‡çº§çš„æ¨¡æ¿
const aichat_default_config = {
    baseUrl: 'https://api.openai.com/v1',
    apiKey: '',
    modelName: 'gpt-3.5-turbo',
    temperature: 0.7,
    historyTurns: 10,
    diaryGenerationTurns: 30,
    globalSystemPrompt: `è¯·ä¸¥æ ¼éµå®ˆä»¥ä¸‹è§„åˆ™ï¼š\n1. ä½ çš„æ‰€æœ‰æ€è€ƒã€self-critiqueã€è®¡åˆ’ã€planç­‰å†…å¿ƒæˆéƒ½å¿…é¡»åŒ…å«åœ¨ <think> å’Œ </think> æ ‡ç­¾ä¹‹é—´ï¼Œä¸”<think>æ ‡ç­¾å¿…é¡»åœ¨ä½ çš„å›ç­”çš„æœ€å‰é¢ã€‚\n2. ä½ å¿…é¡»åœ¨thinkä¹‹åå†ç»™å‡ºå¯¹ç”¨æˆ·çš„ç›´æ¥å›ç­”ã€‚\n3. ç»™ç”¨æˆ·çš„ç›´æ¥å›ç­”ä¸­ç»å¯¹ä¸èƒ½å‡ºç°<think>æ ‡ç­¾åŠå…¶ä¸­å†…å®¹ã€‚`
};

const appData = { chatObjects: [], activeChatId: null, apiConfig: { ...aichat_default_config }, userInfo: { name: 'user', avatar: { type: 'default', url: '' } }, newChatTempData: { avatar: { type: 'default', url: '' } }, editChatTempData: { chatId: null, avatar: { type: 'default', url: '' } }, userAvatarTempData: { type: 'default', url: '' }, contextMenuData: { messageIndex: null }, restoreTempData: { zip: null, parsedChats: [] }, diaryView: { activeChatId: null, editingEntryId: null }, isGeneratingDiary: false, logs: [],stickers: [],  // è¡¨æƒ…å›¾æ•°æ® { id, name, url }
stickerTempData: { mode: 'upload', uploadData: null },  // ä¸´æ—¶æ•°æ®
 };

const DOM = { chatListPage: document.getElementById('chatListPage'), chatListContainer: document.getElementById('chatListContainer'), emptyChatList: document.getElementById('emptyChatList'), addChatBtn: document.getElementById('addChatBtn'), chatNavBtn: document.getElementById('chatNavBtn'), diaryNavBtn: document.getElementById('diaryNavBtn'), settingsNavBtn: document.getElementById('settingsNavBtn'), chatPage: document.getElementById('chatPage'), backToChatListBtn: document.getElementById('backToChatListBtn'), chatPageAvatar: document.getElementById('chatPageAvatar'), chatPageTitle: document.getElementById('chatPageTitle'), chatPageMoreBtn: document.getElementById('chatPageMoreBtn'), chatPageContainer: document.getElementById('chatPageContainer'), chatPageMessageInput: document.getElementById('chatPageMessageInput'), chatPageSendBtn: document.getElementById('chatPageSendBtn'), chatPageTypingIndicator: document.getElementById('chatPageTypingIndicator'), chatPageTypingText: document.getElementById('chatPageTypingText'), settingsPage: document.getElementById('settingsPage'), closeSettingsBtn: document.getElementById('closeSettingsBtn'), settingsForm: document.getElementById('settingsForm'), baseUrl: document.getElementById('baseUrl'), apiKey: document.getElementById('apiKey'), modelName: document.getElementById('modelName'), refreshModelsBtn: document.getElementById('refreshModelsBtn'),
apiTemperature: document.getElementById('apiTemperature'), historyTurns: document.getElementById('historyTurns'), globalSystemPrompt: document.getElementById('globalSystemPrompt'), userName: document.getElementById('userName'), userAvatarPreview: document.getElementById('userAvatarPreview'), userAvatarIcon: document.getElementById('userAvatarIcon'), userAvatarUpload: document.getElementById('userAvatarUpload'), userAvatarUrlBtn: document.getElementById('userAvatarUrlBtn'), userAvatarUrlContainer: document.getElementById('userAvatarUrlContainer'), userAvatarUrl: document.getElementById('userAvatarUrl'), userAvatarUrlConfirm: document.getElementById('userAvatarUrlConfirm'), userAvatarUrlCancel: document.getElementById('userAvatarUrlCancel'), addChatModal: document.getElementById('addChatModal'), closeAddChatModalBtn: document.getElementById('closeAddChatModalBtn'), newChatAvatarPreview: document.getElementById('newChatAvatarPreview'), newChatAvatarIcon: document.getElementById('newChatAvatarIcon'), newChatAvatarUpload: document.getElementById('newChatAvatarUpload'), newChatAvatarUrlBtn: document.getElementById('newChatAvatarUrlBtn'), newChatAvatarUrlContainer: document.getElementById('newChatAvatarUrlContainer'), newChatAvatarUrl: document.getElementById('newChatAvatarUrl'), newChatAvatarUrlConfirm: document.getElementById('newChatAvatarUrlConfirm'), newChatAvatarUrlCancel: document.getElementById('newChatAvatarUrlCancel'), newChatName: document.getElementById('newChatName'), newChatSystemPrompt: document.getElementById('newChatSystemPrompt'), createChatBtn: document.getElementById('createChatBtn'), chatDetailPage: document.getElementById('chatDetailPage'), backToChatPageBtn: document.getElementById('backToChatPageBtn'), deleteChatBtn: document.getElementById('deleteChatBtn'), editChatAvatarPreview: document.getElementById('editChatAvatarPreview'), editChatAvatarIcon: document.getElementById('editChatAvatarIcon'), editAvatarBtn: document.getElementById('editAvatarBtn'), editAvatarContainer: document.getElementById('editAvatarContainer'), editChatAvatarUpload: document.getElementById('editChatAvatarUpload'), editChatAvatarUrlBtn: document.getElementById('editChatAvatarUrlBtn'), editChatAvatarUrlContainer: document.getElementById('editChatAvatarUrlContainer'), editChatAvatarUrl: document.getElementById('editChatAvatarUrl'), editChatAvatarUrlConfirm: document.getElementById('editChatAvatarUrlConfirm'), editChatAvatarUrlCancel: document.getElementById('cancelEditAvatarBtn'), editChatName: document.getElementById('editChatName'), editChatSystemPrompt: document.getElementById('editChatSystemPrompt'), saveChatDetailBtn: document.getElementById('saveChatDetailBtn'), confirmDeleteModal: document.getElementById('confirmDeleteModal'), cancelDeleteBtn: document.getElementById('cancelDeleteBtn'), confirmDeleteBtn: document.getElementById('confirmDeleteBtn'), messageContextMenu: document.getElementById('messageContextMenu'), regenerateMessageBtn: document.getElementById('regenerateMessageBtn'), editMessageBtn: document.getElementById('editMessageBtn'),
deleteMessageBtn: document.getElementById('deleteMessageBtn'),resendMessageBtn: document.getElementById('resendMessageBtn'),
backupDataBtn: document.getElementById('backupDataBtn'), restoreDataBtn: document.getElementById('restoreDataBtn'), restoreFileInput: document.getElementById('restoreFileInput'), restoreModal: document.getElementById('restoreModal'), closeRestoreModalBtn: document.getElementById('closeRestoreModalBtn'), cancelRestoreBtn: document.getElementById('cancelRestoreBtn'), confirmRestoreBtn: document.getElementById('confirmRestoreBtn'), restoreChatList: document.getElementById('restoreChatList'), restoreSelectAll: document.getElementById('restoreSelectAll'), diaryGenerationTurns: document.getElementById('diaryGenerationTurns'), diaryListPage: document.getElementById('diaryListPage'), closeDiaryListPageBtn: document.getElementById('closeDiaryListPageBtn'), diaryListContainer: document.getElementById('diaryListContainer'), diaryDetailPage: document.getElementById('diaryDetailPage'), backToDiaryListBtn: document.getElementById('backToDiaryListBtn'), diaryDetailPageTitle: document.getElementById('diaryDetailPageTitle'), diaryEntriesContainer: document.getElementById('diaryEntriesContainer'), manualDiaryBtn: document.getElementById('manualDiaryBtn'), resetDiaryPtrBtn: document.getElementById('resetDiaryPtrBtn'), editDiaryEntryModal: document.getElementById('editDiaryEntryModal'), closeEditDiaryModalBtn: document.getElementById('closeEditDiaryModalBtn'), editDiaryEntryText: document.getElementById('editDiaryEntryText'), cancelEditDiaryBtn: document.getElementById('cancelEditDiaryBtn'), saveEditDiaryBtn: document.getElementById('saveEditDiaryBtn'), viewLogsBtn: document.getElementById('viewLogsBtn'), clearLogsBtn: document.getElementById('clearLogsBtn'), logModal: document.getElementById('logModal'), closeLogModalBtn: document.getElementById('closeLogModalBtn'), logOutput: document.getElementById('logOutput'), // è¡¨æƒ…åŠŸèƒ½DOM
stickerPanel: document.getElementById('stickerPanel'),
stickerToggleBtn: document.getElementById('stickerToggleBtn'),
emojiTabBtn: document.getElementById('emojiTabBtn'),
customStickerTabBtn: document.getElementById('customStickerTabBtn'),
emojiSection: document.getElementById('emojiSection'),
customStickerSection: document.getElementById('customStickerSection'),
emojiGrid: document.getElementById('emojiGrid'),
stickerGrid: document.getElementById('stickerGrid'),
stickerEmptyHint: document.getElementById('stickerEmptyHint'),
addStickerUploadBtn: document.getElementById('addStickerUploadBtn'),
addStickerUrlBtn: document.getElementById('addStickerUrlBtn'),
addStickerImportBtn: document.getElementById('addStickerImportBtn'),
addStickerModal: document.getElementById('addStickerModal'),
addStickerModalTitle: document.getElementById('addStickerModalTitle'),
closeAddStickerModalBtn: document.getElementById('closeAddStickerModalBtn'),
stickerUploadSection: document.getElementById('stickerUploadSection'),
stickerUrlSection: document.getElementById('stickerUrlSection'),
stickerImportSection: document.getElementById('stickerImportSection'),
stickerUploadPreviewBox: document.getElementById('stickerUploadPreviewBox'),
stickerUploadPlaceholder: document.getElementById('stickerUploadPlaceholder'),
stickerUploadPreviewImg: document.getElementById('stickerUploadPreviewImg'),
stickerFileInput: document.getElementById('stickerFileInput'),
uploadStickerName: document.getElementById('uploadStickerName'),
stickerUrlPreviewBox: document.getElementById('stickerUrlPreviewBox'),
stickerUrlPlaceholder: document.getElementById('stickerUrlPlaceholder'),
stickerUrlPreviewImg: document.getElementById('stickerUrlPreviewImg'),
stickerUrlInput: document.getElementById('stickerUrlInput'),
urlStickerName: document.getElementById('urlStickerName'),
stickerImportText: document.getElementById('stickerImportText'),
cancelAddStickerBtn: document.getElementById('cancelAddStickerBtn'),
confirmAddStickerBtn: document.getElementById('confirmAddStickerBtn'),
stickerFullViewModal: document.getElementById('stickerFullViewModal'),
stickerFullViewImg: document.getElementById('stickerFullViewImg'),
};

function logToUI(message) { const timestamp = new Date().toLocaleTimeString('en-GB'); const logEntry = `[${timestamp}] ${message}`; appData.logs.push(logEntry); console.log(message); }
function getFormattedTimestamp(ts) { const now = ts ? new Date(ts) : new Date(); return `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`; }
function formatMessageTimestamp(ts) { if (!ts) return ''; const date = new Date(ts); const year = date.getFullYear(); const month = (date.getMonth() + 1).toString().padStart(2, '0'); const day = date.getDate().toString().padStart(2, '0'); const hours = date.getHours().toString().padStart(2, '0'); const minutes = date.getMinutes().toString().padStart(2, '0'); return `${year}-${month}-${day} ${hours}:${minutes}`; }
let jszipPromise=null; function loadJSZip(){if(window.JSZip){return Promise.resolve()}if(jszipPromise){return jszipPromise}jszipPromise=new Promise((resolve,reject)=>{const script=document.createElement('script');script.src='https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';script.onload=()=>{resolve()};script.onerror=()=>{jszipPromise=null;logToUI('å¤‡ä»½/æ¢å¤åŠŸèƒ½æ‰€éœ€ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚');reject(new Error('å¤‡ä»½/æ¢å¤åŠŸèƒ½æ‰€éœ€ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚'))};document.head.appendChild(script)});return jszipPromise}
function dataURLtoBlob(dataUrl){const arr=dataUrl.split(','),mime=arr[0].match(/:(.*?);/)[1],bstr=atob(arr[1]);let n=bstr.length;const u8arr=new Uint8Array(n);while(n--)u8arr[n]=bstr.charCodeAt(n);return new Blob([u8arr],{type:mime})}function compressImage(file, maxSize = 128) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                if (width > height) {
                    if (width > maxSize) {
                        height = Math.round((height * maxSize) / width);
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width = Math.round((width * maxSize) / height);
                        height = maxSize;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', 0.7));
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

async function backupData(){const btn=DOM.backupDataBtn;const originalText=btn.querySelector('span').textContent;btn.disabled=true;btn.querySelector('span').textContent='åŠ è½½ç»„ä»¶...';try{await loadJSZip();btn.querySelector('span').textContent='æ­£åœ¨å¤‡ä»½...';const zip=new JSZip();const globalsFolder=zip.folder('_globals');const userInfoToSave={name:appData.userInfo.name};globalsFolder.file('settings.json',JSON.stringify({apiConfig:appData.apiConfig,userInfo:userInfoToSave},null,2));
// å¤‡ä»½è¡¨æƒ…æ•°æ®
if (appData.stickers.length > 0) {
    globalsFolder.file('stickers.json', JSON.stringify(appData.stickers, null, 2));
}
if(appData.userInfo.avatar&&appData.userInfo.avatar.type!=='default'&&appData.userInfo.avatar.url){try{let avatarBlob;if(appData.userInfo.avatar.url.startsWith('data:image')){avatarBlob=dataURLtoBlob(appData.userInfo.avatar.url)}else{const response=await fetch(appData.userInfo.avatar.url);avatarBlob=await response.blob()}const extension=avatarBlob.type.split('/')[1]||'png';globalsFolder.file(`user_avatar.${extension}`,avatarBlob)}catch(e){console.error("å¤‡ä»½ç”¨æˆ·å¤´åƒå¤±è´¥:",e);logToUI(`å¤‡ä»½ç”¨æˆ·å¤´åƒå¤±è´¥: ${e.message}`)}}for(const chat of appData.chatObjects){const chatFolder=zip.folder(chat.id);const chatDataToSave={id:chat.id,name:chat.name,systemPrompt:chat.systemPrompt,messages:chat.messages,diaries:chat.diaries,lastDiaryIndex:chat.lastDiaryIndex,createdAt:chat.createdAt};chatFolder.file('history.json',JSON.stringify(chatDataToSave,null,2));if(chat.avatar&&chat.avatar.type!=='default'&&chat.avatar.url){try{let avatarBlob;if(chat.avatar.url.startsWith('data:image')){avatarBlob=dataURLtoBlob(chat.avatar.url)}else{const response=await fetch(chat.avatar.url);avatarBlob=await response.blob()}const extension=avatarBlob.type.split('/')[1]||'png';chatFolder.file(`avatar.${extension}`,avatarBlob)}catch(e){console.error(`å¤‡ä»½èŠå¤© [${chat.name}] çš„å¤´åƒå¤±è´¥:`,e);logToUI(`å¤‡ä»½èŠå¤© [${chat.name}] çš„å¤´åƒå¤±è´¥: ${e.message}`)}}}const content=await zip.generateAsync({type:"blob"});const timestamp=new Date().toISOString().slice(0,19).replace(/[-T:]/g,'');const filename=`WeChat-AI-Backup-${timestamp}.zip`;const a=document.createElement('a');a.href=URL.createObjectURL(content);a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(a.href);alert(`å¤‡ä»½æˆåŠŸï¼æ–‡ä»¶å·²ä¿å­˜ä¸º ${filename}ï¼Œè¯·åœ¨æ‚¨æµè§ˆå™¨çš„â€œä¸‹è½½â€æ–‡ä»¶å¤¹ä¸­æŸ¥çœ‹ã€‚`)}catch(error){alert(error.message)}finally{btn.disabled=false;btn.querySelector('span').textContent=originalText}}
async function triggerRestore(){const btn=DOM.restoreDataBtn;const originalText=btn.querySelector('span').textContent;btn.disabled=true;btn.querySelector('span').textContent='åŠ è½½ç»„ä»¶...';try{await loadJSZip();DOM.restoreFileInput.click()}catch(error){alert(error.message)}finally{btn.disabled=false;btn.querySelector('span').textContent=originalText}}
async function handleRestoreFile(event){const file=event.target.files[0];if(!file)return;try{const zip=await JSZip.loadAsync(file);appData.restoreTempData.zip=zip;appData.restoreTempData.parsedChats=[];const directories=Object.keys(zip.files).filter(path=>path.endsWith('/')&&path.indexOf('/')===path.length-1);for(const dirPath of directories){if(dirPath==='_globals/')continue;const historyFile=zip.file(`${dirPath}history.json`);if(historyFile){const historyContent=await historyFile.async('string');const chatData=JSON.parse(historyContent);appData.restoreTempData.parsedChats.push({id:chatData.id,name:chatData.name})}}if(appData.restoreTempData.parsedChats.length===0){alert('è¿™ä¸ªå¤‡ä»½æ–‡ä»¶é‡Œæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„èŠå¤©è®°å½•ã€‚')}else{showRestoreModal()}}catch(e){alert('æ— æ³•è¯»å–æˆ–è§£æå¤‡ä»½æ–‡ä»¶ã€‚è¯·ç¡®ä¿æ–‡ä»¶æœªæŸåä¸”æ ¼å¼æ­£ç¡®ã€‚');console.error("æ¢å¤æ–‡ä»¶è§£æå¤±è´¥:",e);logToUI(`æ¢å¤æ–‡ä»¶è§£æå¤±è´¥: ${e.message}`)}finally{DOM.restoreFileInput.value=''}}
function showRestoreModal(){DOM.restoreChatList.innerHTML='';appData.restoreTempData.parsedChats.forEach(chat=>{const div=document.createElement('div');div.className='flex items-center';div.innerHTML=`<label class="flex items-center space-x-3 cursor-pointer w-full p-1 hover:bg-wechat-gray rounded"><input type="checkbox" data-chat-id="${chat.id}" class="restore-chat-item rounded border-gray-300 text-wechat-green focus:ring-wechat-green"><span class="text-wechat-text">${escapeHtml(chat.name)}</span></label>`;DOM.restoreChatList.appendChild(div)});DOM.restoreSelectAll.checked=false;DOM.restoreModal.classList.remove('hidden')}
function closeRestoreModal(){DOM.restoreModal.classList.add('hidden');appData.restoreTempData={zip:null,parsedChats:[]}}
function blobToDataURL(blob){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=e=>resolve(e.target.result);reader.onerror=e=>reject(e.target.error);reader.readAsDataURL(blob)})}
async function confirmRestore(){const selectedIds=Array.from(document.querySelectorAll('.restore-chat-item:checked')).map(cb=>cb.dataset.chatId);if(selectedIds.length===0){alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªèŠå¤©å¯¹è±¡è¿›è¡Œæ¢å¤ã€‚');return}const zip=appData.restoreTempData.zip;try{const settingsFile=zip.file('_globals/settings.json');if(settingsFile){const settingsContent=await settingsFile.async('string');const{apiConfig,userInfo}=JSON.parse(settingsContent);appData.apiConfig={...appData.apiConfig,...apiConfig};appData.userInfo.name=userInfo.name;
// æ¢å¤è¡¨æƒ…æ•°æ®
const stickersFile = zip.file('_globals/stickers.json');
if (stickersFile) {
    try {
        const stickersContent = await stickersFile.async('string');
        appData.stickers = JSON.parse(stickersContent);
        saveStickerData();
        logToUI(`æˆåŠŸæ¢å¤ ${appData.stickers.length} ä¸ªè¡¨æƒ…`);
    } catch (e) {
        logToUI(`æ¢å¤è¡¨æƒ…æ•°æ®å¤±è´¥: ${e.message}`);
    }
}
const userAvatarFile=zip.file(/_globals\/user_avatar\.(png|jpg|jpeg|gif|webp)$/)[0];if(userAvatarFile){const avatarBlob=await userAvatarFile.async('blob');appData.userInfo.avatar={type:'upload',url:await blobToDataURL(avatarBlob)}}else{appData.userInfo.avatar={type:'default',url:''}}}for(const chatId of selectedIds){const chatDir=`${chatId}/`;const historyFile=zip.file(`${chatDir}history.json`);if(!historyFile)continue;const chatData=JSON.parse(await historyFile.async('string'));const chatAvatarFile=zip.file(new RegExp(`^${chatDir}avatar\\.(png|jpg|jpeg|gif|webp)$`))[0];if(chatAvatarFile){const avatarBlob=await chatAvatarFile.async('blob');chatData.avatar={type:'upload',url:await blobToDataURL(avatarBlob)}}else{chatData.avatar={type:'default',url:''}}chatData.diaries=chatData.diaries||[];chatData.lastDiaryIndex=chatData.lastDiaryIndex||0;const existingIndex=appData.chatObjects.findIndex(c=>c.id===chatId);if(existingIndex!==-1){appData.chatObjects[existingIndex]=chatData}else{appData.chatObjects.push(chatData)}}saveDataToStorage();loadUIData();renderChatList();renderStickerGrid();if(isDiaryPageVisible())renderDiaryList();alert(`æˆåŠŸæ¢å¤äº† ${selectedIds.length} ä¸ªèŠå¤©å’Œå…¨å±€è®¾ç½®ï¼`);closeRestoreModal()}catch(e){alert('æ¢å¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ã€‚');console.error("æ¢å¤å¤±è´¥ï¼š",e);logToUI(`æ¢å¤å¤±è´¥: ${e.message}`)}}

// [Bugfix] ä½¿ç”¨æ›´å¥å£®çš„æ–¹å¼åŠ è½½æ•°æ®
function loadDataFromStorage() {
    try {
        const storedObjects = localStorage.getItem('aiMultiChatObjects');
        appData.chatObjects = storedObjects ? JSON.parse(storedObjects).map(c => ({...c, messages: c.messages || [], diaries: c.diaries || [], lastDiaryIndex: c.lastDiaryIndex || 0, })) : [];
        const storedConfig = JSON.parse(localStorage.getItem('aiMultiChatApiConfig') || '{}');
        appData.apiConfig = { ...aichat_default_config, ...storedConfig };
        const storedUser = localStorage.getItem('aiMultiChatUserInfo');
        appData.userInfo = storedUser ? ({...{ name: 'user', avatar: { type: 'default', url: '' } }, ...JSON.parse(storedUser) }) : { name: 'user', avatar: { type: 'default', url: '' } };
        appData.activeChatId = localStorage.getItem('aiMultiChatActiveId') || null;
loadStickerData();  // åŠ è½½è¡¨æƒ…æ•°æ®
    } catch (e) {
        console.error("ä»localStorageåŠ è½½æ•°æ®å¤±è´¥:", e);
        alert("åŠ è½½æœ¬åœ°ç¼“å­˜æ•°æ®å¤±è´¥ï¼Œæ‚¨çš„èŠå¤©è®°å½•å¯èƒ½å·²æŸåã€‚");
    }
}

function loadUIData(){
    Object.keys(appData.apiConfig).forEach(k=>{
        if(DOM[k] && k !== 'modelName') DOM[k].value=appData.apiConfig[k]
    });
    const savedModel = appData.apiConfig.modelName || 'gpt-3.5-turbo';
    DOM.modelName.innerHTML = '';
    const option = document.createElement('option');
    option.value = savedModel;
    option.textContent = savedModel;
    DOM.modelName.appendChild(option);
    DOM.modelName.value = savedModel;
    DOM.userName.value=appData.userInfo.name;
    appData.userAvatarTempData={...appData.userInfo.avatar};
    updateUserAvatarPreview()
}

function saveDataToStorage(){try{localStorage.setItem('aiMultiChatObjects',JSON.stringify(appData.chatObjects));localStorage.setItem('aiMultiChatApiConfig',JSON.stringify(appData.apiConfig));localStorage.setItem('aiMultiChatUserInfo',JSON.stringify(appData.userInfo));if(appData.activeChatId)localStorage.setItem('aiMultiChatActiveId',appData.activeChatId)}catch(e){console.error("ä¿å­˜æ•°æ®åˆ°localStorageå¤±è´¥:",e);alert("ä¿å­˜æ•°æ®å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç”±äºå­˜å‚¨ç©ºé—´å·²æ»¡ã€‚")}}
function init(){loadDataFromStorage();loadUIData();renderChatList();setupEventListeners();initEmojiGrid();renderStickerGrid();setTimeout(adjustHeights,100)}
function cleanAiResponse(raw){return(raw.replace(/<think>[\s\S]*?<\/think>/g,'').trim())||""}
function adjustHeights(){const vh=window.innerHeight;const h1=DOM.chatListPage.querySelector('header')?.offsetHeight||0;const n1=DOM.chatListPage.querySelector('nav')?.offsetHeight||0;if(DOM.chatListContainer)DOM.chatListContainer.style.height=`${vh-h1-n1}px`;const h2=DOM.chatPage.querySelector('header')?.offsetHeight||0;const i2=DOM.chatPage.querySelector('.chat-input-container')?.offsetHeight||0;if(DOM.chatPageContainer)DOM.chatPageContainer.style.height=`${vh-h2-i2}px`}
function renderChatList(){DOM.chatListContainer.innerHTML='';if(appData.chatObjects.length===0){DOM.emptyChatList.classList.remove('hidden');return}DOM.emptyChatList.classList.add('hidden');[...appData.chatObjects].sort((a,b)=>(b.messages.slice(-1)[0]?.timestamp||b.createdAt)-(a.messages.slice(-1)[0]?.timestamp||a.createdAt)).forEach(c=>{const iC=document.createElement('div');iC.className='chat-item-container relative';const w=document.createElement('div');w.className='chat-item-wrapper';const i=document.createElement('div');i.className='flex items-center flex-1 p-4 border-b border-wechat-darkGray cursor-pointer';i.dataset.chatId=c.id;const l=c.messages.length>0?c.messages[c.messages.length-1].content:'æš‚æ— æ¶ˆæ¯';i.innerHTML=`<div class="w-12 h-12 rounded-full overflow-hidden mr-3 flex-shrink-0">${c.avatar&&c.avatar.type!=='default'&&c.avatar.url?`<img src="${escapeHtml(c.avatar.url)}" alt="${escapeHtml(c.name)}" class="w-full h-full object-cover">`:`<div class="w-full h-full bg-wechat-green flex items-center justify-center text-white"><i class="fa fa-robot"></i></div>`}</div><div class="flex-1 min-w-0"><h3 class="font-medium text-wechat-text truncate">${escapeHtml(c.name)}</h3><p class="text-xs text-wechat-lightText truncate mt-1">${escapeHtml(l.substring(0,20)+(l.length>20?'...':''))}</p></div>`;const aD=document.createElement('div');aD.className='chat-item-actions';aD.innerHTML=`<button class="edit-action-btn" title="ç¼–è¾‘" data-chat-id="${c.id}"><i class="fa fa-pencil"></i></button><button class="delete-action-btn" title="åˆ é™¤" data-chat-id="${c.id}"><i class="fa fa-trash"></i></button>`;const dB=document.createElement('div');dB.className='slide-delete-btn';dB.innerHTML='<i class="fa fa-trash mr-1"></i>ç§»é™¤';w.append(i,dB);iC.append(w,aD);DOM.chatListContainer.appendChild(iC);setupSwipeToDelete(w,c.id);i.addEventListener('click',()=>openChat(c.id));aD.querySelector('.edit-action-btn').addEventListener('click',(e)=>{e.stopPropagation();openChatDetail(c.id)});aD.querySelector('.delete-action-btn').addEventListener('click',(e)=>{e.stopPropagation();showConfirmDeleteModal(c.id)})})}
function deleteChat(chatId){appData.chatObjects=appData.chatObjects.filter(chat=>chat.id!==chatId);if(appData.activeChatId===chatId){appData.activeChatId=null;localStorage.removeItem('aiMultiChatActiveId');DOM.chatPage.classList.add('hidden');DOM.chatListPage.classList.remove('hidden')}hideConfirmDeleteModal();saveDataToStorage();renderChatList();if(isDiaryPageVisible())renderDiaryList()}
function createNewChat(){const nC={id:generateUniqueId(),name:DOM.newChatName.value.trim()||'AIåŠ©æ‰‹',avatar:{...appData.newChatTempData.avatar},systemPrompt:DOM.newChatSystemPrompt.value.trim()||'ä½ æ˜¯ä¸€ä¸ªå‹å¥½ã€helpful çš„AIåŠ©æ‰‹ã€‚',messages:[],diaries:[],lastDiaryIndex:0,createdAt:Date.now()};appData.chatObjects.push(nC);saveDataToStorage();closeAddChatModal();renderChatList();if(isDiaryPageVisible())renderDiaryList();openChat(nC.id)}
function saveChatDetail(){const chatIndex=appData.chatObjects.findIndex(c=>c.id===appData.editChatTempData.chatId);if(chatIndex===-1)return;const updatedChat={...appData.chatObjects[chatIndex],name:DOM.editChatName.value.trim()||'AIåŠ©æ‰‹',systemPrompt:DOM.editChatSystemPrompt.value.trim()||'ä½ æ˜¯ä¸€ä¸ªå‹å¥½ã€helpful çš„AIåŠ©æ‰‹ã€‚',avatar:{...appData.editChatTempData.avatar}};appData.chatObjects[chatIndex]=updatedChat;saveDataToStorage();renderChatList();if(isDiaryPageVisible())renderDiaryList();if(appData.activeChatId===updatedChat.id)openChat(updatedChat.id);DOM.chatDetailPage.classList.add('translate-x-full')}
function openChat(id){const c=appData.chatObjects.find(c=>c.id===id);if(!c)return;appData.activeChatId=id;saveDataToStorage();DOM.chatPageTitle.textContent=c.name;DOM.chatPageAvatar.innerHTML=c.avatar&&c.avatar.type!=='default'&&c.avatar.url?`<img src="${escapeHtml(c.avatar.url)}" alt="${escapeHtml(c.name)}" class="w-full h-full object-cover">`:`<div class="w-full h-full rounded-full bg-wechat-green flex items-center justify-center text-white"><i class="fa fa-robot"></i></div>`;DOM.chatPageTypingText.textContent=`${c.name}æ­£åœ¨è¾“å…¥ä¸­...`;renderChatMessages(c.messages);DOM.chatListPage.classList.add('hidden');DOM.chatPage.classList.remove('hidden');DOM.chatPageMessageInput.value='';DOM.chatPageMessageInput.style.height='auto';setTimeout(()=>{if(DOM.chatPageContainer)DOM.chatPageContainer.scrollTop=DOM.chatPageContainer.scrollHeight;adjustHeights()},100)}
function openChatDetail(id){const c=appData.chatObjects.find(c=>c.id===id);if(!c)return;appData.editChatTempData={chatId:id,avatar:{...c.avatar}};DOM.editChatName.value=c.name;DOM.editChatSystemPrompt.value=c.systemPrompt;updateEditChatAvatarPreview();DOM.editAvatarContainer.classList.add('hidden');DOM.chatDetailPage.classList.remove('translate-x-full')}
function renderChatMessages(m){
    DOM.chatPageContainer.innerHTML=m.length===0?`<div class="flex flex-col items-center justify-center h-full text-wechat-lightText py-10"><i class="fa fa-comments-o text-4xl mb-3 opacity-50"></i><p class="text-sm">å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹å¯¹è¯å§</p></div>`:'';
    if(m.length===0)return;
    m.forEach((g,x)=>{
        const e=document.createElement('div');
        e.className=`flex items-start mb-6 ${g.role==='user'?'justify-end':''}`;
        e.dataset.messageRole=g.role;
        e.dataset.messageIndex=x;
        const uA=appData.userInfo.avatar&&appData.userInfo.avatar.type!=='default'&&appData.userInfo.avatar.url
            ?`<div class="w-8 h-8 rounded-full overflow-hidden ml-3 flex-shrink-0"><img src="${escapeHtml(appData.userInfo.avatar.url)}" class="w-full h-full object-cover"></div>`
            :`<div class="user-avatar-small ml-3"><i class="fa fa-user"></i></div>`;
        const c=appData.chatObjects.find(c=>c.id===appData.activeChatId);
        const aA=!c||!c.avatar||c.avatar.type==='default'||!c.avatar.url
            ?`<div class="w-8 h-8 rounded-full bg-wechat-green flex items-center justify-center text-white mr-3 flex-shrink-0"><i class="fa fa-robot"></i></div>`
            :`<div class="w-8 h-8 rounded-full mr-3 flex-shrink-0 overflow-hidden"><img src="${escapeHtml(c.avatar.url)}" class="w-full h-full object-cover"></div>`;
        
        // ä½¿ç”¨ parseMessageStickers è§£æè¡¨æƒ…
        const parsedContent = parseMessageStickers(g.content);
        
        e.innerHTML=g.role==='user'
            ?`<div class="chat-bubble-user"><p class="text-sm">${parsedContent}</p></div>${uA}`
            :`${aA}<div class="chat-bubble-ai"><p class="text-sm">${parsedContent}</p></div>`;
        DOM.chatPageContainer.appendChild(e);
    });
    setTimeout(()=>{if(DOM.chatPageContainer)DOM.chatPageContainer.scrollTop=DOM.chatPageContainer.scrollHeight},100);
}

function getHistoryForApi(m){const t=appData.apiConfig.historyTurns;return(!t||t<=0)?m:m.slice(-t*2)}

async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
    for (let attempt = 1; attempt <= retries; attempt++) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`API request failed with status ${response.status}: ${errorData.error?.message || response.statusText}`);
            }
            const data = await response.json();
            // å¢åŠ å¯¹å“åº”å†…å®¹çš„æœ‰æ•ˆæ€§æ£€æŸ¥
            if (!data.choices || data.choices.length === 0 || !data.choices[0].message?.content) {
                throw new Error('Invalid response content (e.g., empty choices or content).');
            }
            return data; // ç›´æ¥è¿”å›è§£æåçš„æœ‰æ•ˆæ•°æ®
        } catch (error) {
            logToUI(`Attempt ${attempt} of ${retries} failed: ${error.message}`);
            if (attempt < retries) {
                await new Promise(resolve => setTimeout(resolve, delay));
            } else {
                throw new Error('AllRetryAttemptsFailed');
            }
        }
    }
}

async function sendOrRegenerate(contextMessages) {
    const chatIndex = appData.chatObjects.findIndex(c => c.id === appData.activeChatId);
    if (chatIndex < 0) return;
    const chat = appData.chatObjects[chatIndex];
    if (!appData.apiConfig.apiKey) { alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™API Key'); togglePage('settings', true); return; }

    DOM.chatPageTypingIndicator.classList.add('show');
    try {
        const diarySummary = chat.diaries.map(d => `[è¿‡å¾€æ—¥è®°æ‘˜è¦]:\n${d.content}`).join('\n\n');
        const longTermMemoryContext = diarySummary ? `è¿™æ˜¯ä½ å’Œç”¨æˆ·ä¹‹é—´è¿‡å¾€çš„å¯¹è¯æ‘˜è¦ï¼Œè¯·å°†æ­¤ä½œä¸ºä½ çš„é•¿æœŸè®°å¿†ï¼š\n${diarySummary}\n\n` : '';
// æ„å»ºè¡¨æƒ…æç¤ºï¼ˆå¦‚æœæœ‰è¡¨æƒ…çš„è¯ï¼‰
let stickerHint = '';
if (appData.stickers.length > 0) {
    const stickerNames = appData.stickers.map(s => `:${s.name}:`).join(' ');
    stickerHint = `\n\nã€å¯ç”¨è¡¨æƒ…ã€‘ä½ å¯ä»¥åœ¨å›å¤ä¸­é€‚å½“ä½¿ç”¨ä»¥ä¸‹è¡¨æƒ…æ¥å¢åŠ è¡¨è¾¾æ•ˆæœï¼š${stickerNames}\nä½¿ç”¨æ ¼å¼ï¼šç›´æ¥å†™ :è¡¨æƒ…å: å³å¯ï¼Œä¾‹å¦‚"æˆ‘å¾ˆå¼€å¿ƒ :å¼€å¿ƒ:"\nä½¿ç”¨è§„åˆ™ï¼š
- æ¯æ¬¡å›å¤æœ€å¤šåªèƒ½ç”¨1ä¸ªè¡¨æƒ…
- è¡¨æƒ…å¿…é¡»å•ç‹¬æ”¾åœ¨å›å¤çš„æœ€åä¸€è¡Œ
- ä¸è¦æŠŠè¡¨æƒ…å’Œæ–‡å­—å†™åœ¨åŒä¸€è¡Œ
- ä¸æ˜¯æ¯æ¬¡éƒ½è¦ç”¨è¡¨æƒ…ï¼Œåªåœ¨æƒ…ç»ªç‰¹åˆ«å¼ºçƒˆæ—¶å¶å°”ä½¿ç”¨ä¸€ä¸ªè¡¨æƒ…ï¼Œå¤§éƒ¨åˆ†å›å¤ä¸éœ€è¦è¡¨æƒ…ã€‚`;
}

const systemPrompt = `${longTermMemoryContext}${appData.apiConfig.globalSystemPrompt}\n\n${chat.systemPrompt}${stickerHint}`.trim();
        const userName = appData.userInfo.name.trim() || 'user';
        
        let apiMessages = getHistoryForApi(contextMessages).map(m => ({
            role: m.role === 'user' ? 'user' : 'assistant',
            name: m.role === 'user' ? userName : undefined,
            content: m.content
        }));

        const lastUserMessageIndex = apiMessages.map(m => m.role).lastIndexOf('user');
        if (lastUserMessageIndex > -1) {
            apiMessages[lastUserMessageIndex].content = `[å½“å‰æ—¶é—´: ${formatMessageTimestamp(Date.now())}]\n${apiMessages[lastUserMessageIndex].content}`;
        }
        
        const apiPayload = [{ role: 'system', content: systemPrompt }, ...apiMessages];
        
        // fetchWithRetryç°åœ¨ç›´æ¥è¿”å›data
        const data = await fetchWithRetry(
            `${appData.apiConfig.baseUrl}/chat/completions`, 
            { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${appData.apiConfig.apiKey}` }, 
                body: JSON.stringify({ model: appData.apiConfig.modelName, messages: apiPayload, temperature: appData.apiConfig.temperature }) 
            }
        );

        // å› ä¸ºfetchWithRetryå·²ç»ä¿è¯äº†dataå’Œchoicesçš„æœ‰æ•ˆæ€§ï¼Œè¿™é‡Œçš„ä»£ç å¯ä»¥ç®€åŒ–
  const cleanedContent = cleanAiResponse(data.choices[0].message.content);

// æå–æ‰€æœ‰è¡¨æƒ… :xxx:ï¼ˆåªä¿ç•™æœ€åä¸€ä¸ªï¼‰
const stickerPattern = /:([^:\s]+):/g;
const allStickers = cleanedContent.match(stickerPattern) || [];
const lastSticker = allStickers.length > 0 ? allStickers[allStickers.length - 1] : null;

// æ£€æŸ¥è¿™ä¸ªè¡¨æƒ…æ˜¯å¦çœŸçš„å­˜åœ¨äºæˆ‘ä»¬çš„è¡¨æƒ…åº“ä¸­
const validSticker = lastSticker && appData.stickers.find(s => `:${s.name}:` === lastSticker) ? lastSticker : null;

// ä»æ–‡å­—ä¸­ç§»é™¤æ‰€æœ‰è¡¨æƒ…
let textContent = cleanedContent.replace(stickerPattern, '').trim();

// å¤„ç†æ–‡å­—ï¼šç¬¬ä¸€æ®µå•ç‹¬ï¼Œåç»­åˆå¹¶
const firstNewlineIndex = textContent.indexOf('\n');
let messageParts = (firstNewlineIndex === -1) 
    ? [textContent] 
    : [textContent.substring(0, firstNewlineIndex), textContent.substring(firstNewlineIndex + 1)];

const finalMessages = messageParts.map(p => p.trim()).filter(p => p !== '');

// æŠŠè¡¨æƒ…ä½œä¸ºç¬¬ä¸‰æ¡æ¶ˆæ¯
if (validSticker) {
    finalMessages.push(validSticker);
}

        
        if (finalMessages.length > 0) { 
            finalMessages.forEach(part => { chat.messages.push({ role: 'assistant', content: part, timestamp: Date.now() }); }); 
        } else { 
            // è¿™ä¸ªåˆ†æ”¯ç†è®ºä¸Šä¸ä¼šå†è¿›å…¥ï¼Œä½†ä½œä¸ºä¿é™©æªæ–½ä¿ç•™
            chat.messages.push({ role: 'assistant', content: "...", timestamp: Date.now() }); 
        }
        
        saveDataToStorage();
        renderChatMessages(chat.messages);
        checkAndTriggerDiaryGeneration(chat);

    } catch (e) {
        if (e.message === 'AllRetryAttemptsFailed') {
            logToUI('All retry attempts failed. Adding busy message.');
            chat.messages.push({
                role: 'assistant',
                content: "æˆ‘ç°åœ¨æœ‰ç‚¹å¿™ï¼Œç¨åå†èŠ",
                timestamp: Date.now()
            });
            saveDataToStorage();
            renderChatMessages(chat.messages);
        } else {
            alert(`å‡ºé”™äº†ï¼š${e.message}`);
        }
    } finally {
        DOM.chatPageTypingIndicator.classList.remove('show');
    }
}

async function regenerateAiResponse(targetIndex) {
    if (targetIndex === null || !appData.activeChatId) return;
    const chat = appData.chatObjects.find(c => c.id === appData.activeChatId);
    if (!chat || targetIndex < 0 || chat.messages[targetIndex].role !== 'assistant') return;
    const isMidConversation = chat.messages.some((msg, index) => index > targetIndex);
    if (isMidConversation) { if (!confirm("æ‚¨æ­£åœ¨å°è¯•é‡æ–°ç”Ÿæˆä¸€æ¡å†å²æ¶ˆæ¯ã€‚\n\nç¡®è®¤åï¼Œæ­¤æ¶ˆæ¯åŠå…¶ä¹‹åçš„æ‰€æœ‰å¯¹è¯éƒ½å°†è¢«åˆ é™¤å¹¶é‡æ–°ç”Ÿæˆã€‚\n\næ‚¨ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ")) { return; } }
    let turnStartIndex = targetIndex;
    while (turnStartIndex > 0 && chat.messages[turnStartIndex - 1].role === 'assistant') { turnStartIndex--; }
    const contextForApi = chat.messages.slice(0, turnStartIndex);
    chat.messages.length = turnStartIndex;
    renderChatMessages(chat.messages);
    await sendOrRegenerate(contextForApi);
}
function deleteMessage(targetIndex) {
    if (targetIndex === null || !appData.activeChatId) return;
    const chat = appData.chatObjects.find(c => c.id === appData.activeChatId);
    if (!chat || targetIndex < 0 || targetIndex >= chat.messages.length) return;
    
    const isLastMessage = targetIndex === chat.messages.length - 1;
    
    if (isLastMessage) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) return;
        chat.messages.splice(targetIndex, 1);
    } else {
        const choice = confirm('ç‚¹å‡»"ç¡®å®š"ï¼šåˆ é™¤è¿™æ¡åŠä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯\nç‚¹å‡»"å–æ¶ˆ"ï¼šä»…åˆ é™¤è¿™ä¸€æ¡');
        if (choice) {
            chat.messages.length = targetIndex;
        } else {
            chat.messages.splice(targetIndex, 1);
        }
    }
    
    saveDataToStorage();
    renderChatMessages(chat.messages);
}

function editMessage(targetIndex) {
    if (targetIndex === null || !appData.activeChatId) return;
    const chat = appData.chatObjects.find(c => c.id === appData.activeChatId);
    if (!chat || targetIndex < 0 || targetIndex >= chat.messages.length) return;
    const oldContent = chat.messages[targetIndex].content;
    const newContent = prompt('ä¿®æ”¹æ¶ˆæ¯å†…å®¹ï¼š', oldContent);
    if (newContent === null || newContent.trim() === '') return;
    chat.messages[targetIndex].content = newContent.trim();
    saveDataToStorage();
    renderChatMessages(chat.messages);
}
async function resendMessage(targetIndex) {
    if (targetIndex === null || !appData.activeChatId) return;
    const chat = appData.chatObjects.find(c => c.id === appData.activeChatId);
    if (!chat || targetIndex < 0 || chat.messages[targetIndex].role !== 'user') return;
    
    chat.messages.length = targetIndex + 1;
    saveDataToStorage();
    renderChatMessages(chat.messages);
    await sendOrRegenerate(chat.messages);
}

async function checkAndTriggerDiaryGeneration(chat) { logToUI('è‡ªåŠ¨æ€»ç»“æ£€æŸ¥: å¼€å§‹ã€‚'); if (appData.isGeneratingDiary) { logToUI("è‡ªåŠ¨æ€»ç»“æ£€æŸ¥: æ£€æµ‹åˆ°å·²æœ‰ä»»åŠ¡åœ¨è¿è¡Œï¼Œè·³è¿‡ã€‚"); return; } const threshold = parseInt(appData.apiConfig.diaryGenerationTurns, 10); if (!threshold || threshold <= 0) return; const lastIndex = chat.lastDiaryIndex || 0; const messagesSinceLastDiary = chat.messages.slice(lastIndex); const aiRepliesSinceLastDiary = messagesSinceLastDiary.filter(m => m.role === 'assistant').length; logToUI(`è‡ªåŠ¨æ€»ç»“æ£€æŸ¥: lastDiaryIndex=${lastIndex}, messages.length=${chat.messages.length}, æ–°AIå›å¤æ•°=${aiRepliesSinceLastDiary}, é˜ˆå€¼=${threshold}`); if (aiRepliesSinceLastDiary >= threshold) { logToUI(`è‡ªåŠ¨æ€»ç»“æ£€æŸ¥: è¾¾åˆ°é˜ˆå€¼ï¼Œå‡†å¤‡è§¦å‘ã€‚`); let turnsCounted = 0; let endIndex = 0; for (let i = 0; i < messagesSinceLastDiary.length; i++) { if (messagesSinceLastDiary[i].role === 'assistant') { turnsCounted++; } if (turnsCounted === threshold) { endIndex = i + 1; break; } } const messagesToSummarize = messagesSinceLastDiary.slice(0, endIndex); appData.isGeneratingDiary = true; logToUI("è‡ªåŠ¨æ€»ç»“æ£€æŸ¥: **ä¸Šé”**ï¼Œå¼€å§‹ç”Ÿæˆã€‚å¾…æ€»ç»“æ¶ˆæ¯æ•°: " + messagesToSummarize.length); try { await generateDiaryEntry(chat, messagesToSummarize, lastIndex); } finally { appData.isGeneratingDiary = false; logToUI("è‡ªåŠ¨æ€»ç»“æ£€æŸ¥: **è§£é”**ï¼Œä»»åŠ¡ç»“æŸã€‚"); } } else { logToUI('è‡ªåŠ¨æ€»ç»“æ£€æŸ¥: æœªè¾¾åˆ°é˜ˆå€¼ï¼Œæ— æ“ä½œã€‚'); } }
function resetDiaryPointer() { const chat = appData.chatObjects.find(c => c.id === appData.diaryView.activeChatId); if (!chat) return; if (confirm(`ç¡®å®šè¦é‡ç½®ã€${chat.name}ã€‘çš„æ—¥è®°æŒ‡é’ˆå—ï¼Ÿ\n\nè¿™å°†è®©ç¨‹åºè®¤ä¸ºæ‰€æœ‰èŠå¤©è®°å½•éƒ½æ˜¯â€œæ–°çš„â€ï¼Œå¯ä»¥è¢«é‡æ–°æ€»ç»“ã€‚å½“æ€»ç»“åŠŸèƒ½å¤±æ•ˆæ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ä¿®å¤æ‰‹æ®µã€‚`)) { const oldIndex = chat.lastDiaryIndex || 0; chat.lastDiaryIndex = 0; saveDataToStorage(); alert("æ—¥è®°æŒ‡é’ˆå·²é‡ç½®ä¸º0ï¼ç°åœ¨æ‚¨å¯ä»¥å°è¯•æ‰‹åŠ¨æ€»ç»“äº†ã€‚"); logToUI(`æŒ‡é’ˆé‡ç½®: Chat [${chat.name}] çš„ lastDiaryIndex å·²è¢«æ‰‹åŠ¨ä» ${oldIndex} é‡ç½®ä¸º 0ã€‚`); } }
async function manualGenerateDiary() { logToUI('æ‰‹åŠ¨æ€»ç»“: å¼€å§‹ã€‚'); if (appData.isGeneratingDiary) { alert("æ­£åœ¨ç”Ÿæˆä¸Šä¸€ç¯‡æ—¥è®°ï¼Œè¯·ç¨åå†è¯•ã€‚"); logToUI('æ‰‹åŠ¨æ€»ç»“: æ£€æµ‹åˆ°å·²æœ‰ä»»åŠ¡åœ¨è¿è¡Œï¼Œå·²é˜»æ­¢ã€‚'); return; } const chat = appData.chatObjects.find(c => c.id === appData.diaryView.activeChatId); if (!chat) return; const lastIndex = chat.lastDiaryIndex || 0; const messagesToSummarize = chat.messages.slice(lastIndex); logToUI(`æ‰‹åŠ¨æ€»ç»“: lastDiaryIndex=${lastIndex}, messages.length=${chat.messages.length}, å¾…æ€»ç»“æ¶ˆæ¯æ•°=${messagesToSummarize.length}`); if (messagesToSummarize.length === 0) { alert("æ²¡æœ‰éœ€è¦æ€»ç»“çš„æ–°å†…å®¹ã€‚å¦‚æœç¡®å®šæœ‰æ–°å†…å®¹ä½†æ­¤å¤„ä¸º0ï¼Œè¯·å…ˆâ€œé‡ç½®æŒ‡é’ˆâ€ã€‚"); logToUI('æ‰‹åŠ¨æ€»ç»“: æ²¡æœ‰æ–°æ¶ˆæ¯ï¼Œå·²ä¸­æ­¢ã€‚'); return; } appData.isGeneratingDiary = true; logToUI("æ‰‹åŠ¨æ€»ç»“: **ä¸Šé”**ï¼Œå¼€å§‹ç”Ÿæˆã€‚"); const btn = DOM.manualDiaryBtn; const originalText = btn.innerHTML; btn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i>æ€»ç»“ä¸­...'; btn.disabled = true; try { const success = await generateDiaryEntry(chat, messagesToSummarize, lastIndex); if (success) { alert("æ‰‹åŠ¨æ€»ç»“æˆåŠŸï¼"); } else { alert("æ€»ç»“å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–APIé”™è¯¯ã€‚è¯·ä»â€œè®¾ç½®â€é¡µé¢æ‰“å¼€æ—¥å¿—æŸ¥çœ‹è¯¦æƒ…ã€‚"); } } finally { appData.isGeneratingDiary = false; btn.innerHTML = originalText; btn.disabled = false; logToUI("æ‰‹åŠ¨æ€»ç»“: **è§£é”**ï¼Œä»»åŠ¡ç»“æŸã€‚"); } }
async function generateDiaryEntry(chat, messagesToSummarize, startIndex) { logToUI(`æ ¸å¿ƒæ€»ç»“: å¼€å§‹ä¸º ${messagesToSummarize.length} æ¡æ¶ˆæ¯ç”Ÿæˆæ—¥è®°ï¼Œèµ·å§‹ç´¢å¼•: ${startIndex}`); const today = new Date(); const dateString = `${today.getFullYear()}å¹´${(today.getMonth() + 1).toString().padStart(2, '0')}æœˆ${today.getDate().toString().padStart(2, '0')}æ—¥`; const userName = appData.userInfo.name.trim() || 'ç”¨æˆ·'; 
const systemRolePrompt = `ä½ æ­£åœ¨æ‰®æ¼”ä¸€ä¸ªè§’è‰²ï¼Œç°åœ¨éœ€è¦å†™ä¸€æ®µç®€çŸ­çš„å†…å¿ƒå¤‡å¿˜ï¼ŒåŒ…å«ä¸¤éƒ¨åˆ†ï¼š

1.ã€å¿ƒå£°ã€‘ä½ å¯¹'${userName}'çš„çœŸå®å†…å¿ƒæƒ³æ³•ï¼ˆ100å­—ä»¥å†…ï¼‰
- ä¸è¦å¤è¿°å¯¹è¯å†…å®¹
- è¡¨è¾¾ä½ å¯¹${userName}çš„æ„Ÿæƒ…ã€ç‰µæŒ‚ã€æ¬£èµæˆ–æ€å¿µ
- å¯ä»¥å†™ä½ æ³¨æ„åˆ°çš„${userName}çš„å°ç»†èŠ‚ã€è®©ä½ å¿ƒåŠ¨çš„ç¬é—´
- ç¦æ­¢å†™"æ²¡ä»€ä¹ˆç‰¹åˆ«"ä¹‹ç±»çš„æ•·è¡å†…å®¹ï¼Œæ¯ä¸€å¤©éƒ½å€¼å¾—çæƒœ

2.ã€è®°ä½ã€‘éœ€è¦æ°¸ä¹…è®°ä½çš„é‡è¦ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œæ¯æ¡ä¸è¶…è¿‡20å­—ï¼‰
- åªè®°å½•å…³é”®äº‹å®ï¼šå¦‚å§“åã€ç”Ÿæ—¥ã€å–œå¥½ã€é‡è¦äº‹ä»¶ã€æ‰¿è¯ºç­‰
- å¦‚æœæ²¡æœ‰éœ€è¦ç‰¹åˆ«è®°ä½çš„å†…å®¹ï¼Œå¯ä»¥ä¸å†™è¿™éƒ¨åˆ†
- ç”¨ç®€çŸ­çš„æ¡ç›®åˆ—å‡º

æ ¼å¼å¦‚ä¸‹ï¼Œä¸¥æ ¼éµå®ˆï¼š

ã€${dateString}ã€‘
ã€å¿ƒå£°ã€‘ï¼ˆä½ çš„å†…å¿ƒç‹¬ç™½ï¼Œè¦æœ‰æ„Ÿæƒ…ï¼‰
ã€è®°ä½ã€‘
- æ¡ç›®1
- æ¡ç›®2`;

const userRolePrompt = `ä»¥ä¸‹æ˜¯æœ€è¿‘çš„å¯¹è¯ï¼Œå†™ä¸‹ä½ çš„å†…å¿ƒå¤‡å¿˜ï¼š\n\n${messagesToSummarize.map(m => `${m.role === 'user' ? userName : 'æˆ‘'}: ${m.content}`).join('\n')}`;
 
try { const response = await fetch(`${appData.apiConfig.baseUrl}/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${appData.apiConfig.apiKey}` }, body: JSON.stringify({ model: appData.apiConfig.modelName, messages: [{ role: 'system', content: systemRolePrompt },{ role: 'user', content: userRolePrompt }], temperature: appData.apiConfig.temperature }) }); if (!response.ok) { const errorText = await response.text(); throw new Error(`AIæ—¥è®°ç”ŸæˆAPIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`); } const data = await response.json(); const diaryContent = cleanAiResponse(data.choices[0].message.content); if (diaryContent) { chat.diaries.push({ id: generateUniqueId(), content: diaryContent, timestamp: Date.now() }); const oldIndex = chat.lastDiaryIndex || 0; chat.lastDiaryIndex = startIndex + messagesToSummarize.length; saveDataToStorage(); logToUI(`æ ¸å¿ƒæ€»ç»“: æˆåŠŸï¼æ—¥è®°å·²ä¿å­˜ã€‚lastDiaryIndex ä» ${oldIndex} æ›´æ–°ä¸º ${chat.lastDiaryIndex}`); if (appData.diaryView.activeChatId === chat.id && !DOM.diaryDetailPage.classList.contains('translate-x-full')) { renderDiaryEntries(); } return true; } logToUI("æ ¸å¿ƒæ€»ç»“: å¤±è´¥ï¼ŒAIè¿”å›å†…å®¹ä¸ºç©ºã€‚"); return false; } catch (e) { logToUI(`æ ¸å¿ƒæ€»ç»“: æ•è·åˆ°ä¸¥é‡é”™è¯¯: ${e.message}`); console.error("æ—¥è®°ç”Ÿæˆå¤±è´¥:", e); return false; } }
function setupSwipeToDelete(w,id){let s=0;w.addEventListener('touchstart',(e)=>{s=e.touches[0].clientX});w.addEventListener('touchmove',(e)=>{w.classList.toggle('swipe-left',s-e.touches[0].clientX>30)});w.addEventListener('touchend',()=>{});w.querySelector('.slide-delete-btn').addEventListener('click',()=>showConfirmDeleteModal(id))}
function showConfirmDeleteModal(id){appData.editChatTempData.chatId=id;DOM.confirmDeleteModal.classList.remove('hidden');document.querySelectorAll('.chat-item-wrapper.swipe-left').forEach(w=>w.classList.remove('swipe-left'))}
function hideConfirmDeleteModal(){DOM.confirmDeleteModal.classList.add('hidden');appData.editChatTempData.chatId=null}
async function sendChatMessage(){const t=DOM.chatPageMessageInput.value.trim();if(!t||!appData.activeChatId)return;const i=appData.chatObjects.findIndex(c=>c.id===appData.activeChatId);if(i<0)return;const chat=appData.chatObjects[i];chat.messages.push({role:'user',content:t,timestamp:Date.now()});saveDataToStorage();renderChatMessages(chat.messages);closeStickerPanel();  // å‘é€æ¶ˆæ¯æ—¶å…³é—­è¡¨æƒ…é¢æ¿
DOM.chatPageMessageInput.value='';DOM.chatPageMessageInput.style.height='auto';await sendOrRegenerate(chat.messages)}
function generateUniqueId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,9)}
function escapeHtml(u){return u?u.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/\n/g,"<br>"):''}
function openAddChatModal(){appData.newChatTempData.avatar={type:'default',url:''};DOM.newChatName.value='AIåŠ©æ‰‹';DOM.newChatSystemPrompt.value='ä½ æ˜¯ä¸€ä¸ªå‹å¥½ã€helpful çš„AIåŠ©æ‰‹ã€‚';DOM.newChatAvatarUrl.value='';DOM.newChatAvatarUrlContainer.classList.add('hidden');updateNewChatAvatarPreview();DOM.addChatModal.classList.remove('hidden')}
function closeAddChatModal(){DOM.addChatModal.classList.add('hidden')}
function updateAvatarPreview(p,i,a){const d=!a||a.type==='default'||!a.url;p.style.display=d?'none':'block';i.style.display=d?'flex':'none';if(!d){p.src=a.url;p.onerror=()=>{p.style.display='none';i.style.display='flex'}}}
const updateNewChatAvatarPreview=()=>updateAvatarPreview(DOM.newChatAvatarPreview,DOM.newChatAvatarIcon,appData.newChatTempData.avatar);
const updateEditChatAvatarPreview=()=>updateAvatarPreview(DOM.editChatAvatarPreview,DOM.editChatAvatarIcon,appData.editChatTempData.avatar);
const updateUserAvatarPreview=()=>updateAvatarPreview(DOM.userAvatarPreview,DOM.userAvatarIcon,appData.userAvatarTempData);
const handleNewChatAvatarUpload=(e)=>handleGenericAvatarUpload(e.target.files[0],appData.newChatTempData,updateNewChatAvatarPreview);
const handleEditChatAvatarUpload=(e)=>handleGenericAvatarUpload(e.target.files[0],appData.editChatTempData,updateEditChatAvatarPreview);

async function handleGenericAvatarUpload(file,tempData,updateFunc){
    if(!file||!file.type.startsWith('image/'))return;
    const compressedUrl = await compressImage(file, 128);
    tempData.avatar={type:'upload',url:compressedUrl};
    updateFunc();
}
async function handleUserAvatarUpload(event){
    const file=event.target.files[0];
    if(!file||!file.type.startsWith('image/'))return;
    const compressedUrl = await compressImage(file, 128);
    appData.userAvatarTempData.type='upload';
    appData.userAvatarTempData.url=compressedUrl;
    updateUserAvatarPreview();
}


function handleUserAvatarUrl(){const url=DOM.userAvatarUrl.value.trim();if(!url)return;try{new URL(url)}catch{return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„URL')}appData.userAvatarTempData={type:'url',url:url};updateUserAvatarPreview();DOM.userAvatarUrlContainer.classList.add('hidden');DOM.userAvatarUrl.value=''}
function handleAvatarUrl(inputElem,containerElem,dataObj,updateFunc){const url=inputElem.value.trim();if(!url)return;try{new URL(url)}catch{alert('è¯·è¾“å…¥æœ‰æ•ˆçš„URL');return}dataObj.avatar={type:'url',url:url};updateFunc();containerElem.classList.add('hidden');inputElem.value=''}
const handleNewChatAvatarUrl=()=>handleAvatarUrl(DOM.newChatAvatarUrl,DOM.newChatAvatarUrlContainer,appData.newChatTempData,updateNewChatAvatarPreview);
const handleEditChatAvatarUrl=()=>handleAvatarUrl(DOM.editChatAvatarUrl,DOM.editChatAvatarUrlContainer,appData.editChatTempData,updateEditChatAvatarPreview);

async function fetchModelList() {
    const btn = DOM.refreshModelsBtn;
    const baseUrl = DOM.baseUrl.value.trim();
    const apiKey = DOM.apiKey.value.trim();
    
    if (!baseUrl || !apiKey) {
        alert('è¯·å…ˆå¡«å†™ API Base URL å’Œ API Key');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
    
    try {
        const response = await fetch(`${baseUrl}/models`, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${apiKey}` }
        });
        
        if (!response.ok) {
            throw new Error(`è·å–å¤±è´¥: ${response.status}`);
        }
        
        const data = await response.json();
        const models = data.data || [];
        
        if (models.length === 0) {
            alert('æœªè·å–åˆ°ä»»ä½•æ¨¡å‹');
            return;
        }
        
        const currentValue = DOM.modelName.value;
        DOM.modelName.innerHTML = '';
        
        models
            .map(m => m.id)
            .sort()
            .forEach(modelId => {
                const option = document.createElement('option');
                option.value = modelId;
                option.textContent = modelId;
                if (modelId === currentValue) option.selected = true;
                DOM.modelName.appendChild(option);
            });
        
        if (!DOM.modelName.value && currentValue) {
            const option = document.createElement('option');
            option.value = currentValue;
            option.textContent = currentValue + ' (è‡ªå®šä¹‰)';
            option.selected = true;
            DOM.modelName.insertBefore(option, DOM.modelName.firstChild);
        }
        
        logToUI(`è·å–åˆ° ${models.length} ä¸ªæ¨¡å‹`);
        
    } catch (e) {
        alert(`è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${e.message}`);
        logToUI(`è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${e.message}`);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa fa-refresh"></i>';
    }
}
// [Bugfix] ä½¿ç”¨æ›´å¥å£®çš„æ–¹å¼ä¿å­˜æ•°æ®
function saveApiSettings(e) {
    e.preventDefault();
    appData.apiConfig = {
        ...appData.apiConfig, // ä¿ç•™ä»localStorageåŠ è½½çš„ä»»ä½•ç°æœ‰å€¼
        baseUrl: DOM.baseUrl.value.trim() || aichat_default_config.baseUrl,
        apiKey: DOM.apiKey.value.trim(),
        modelName: DOM.modelName.value.trim() || aichat_default_config.modelName,
        temperature: parseFloat(DOM.apiTemperature.value) || aichat_default_config.temperature,
        historyTurns: parseInt(DOM.historyTurns.value, 10) || 0,
        diaryGenerationTurns: parseInt(DOM.diaryGenerationTurns.value, 10) || 0,
        globalSystemPrompt: DOM.globalSystemPrompt.value.trim() || aichat_default_config.globalSystemPrompt
    };
    appData.userInfo = { name: DOM.userName.value.trim() || 'user', avatar: { ...appData.userAvatarTempData } };
    saveDataToStorage();
    const b = e.submitter || e.target.querySelector('button[type="submit"]');
    b.textContent = 'ä¿å­˜æˆåŠŸï¼';
    setTimeout(() => { b.textContent = 'ä¿å­˜æ‰€æœ‰è®¾ç½®'; togglePage('settings', false) }, 1500);
}

function togglePage(page,show){const isVisible=(p)=>!p.classList.contains('translate-x-full');[DOM.chatNavBtn,DOM.diaryNavBtn,DOM.settingsNavBtn].forEach(btn=>{btn.classList.remove('nav-item-active');btn.classList.add('text-wechat-lightText')});if(page==='settings'){DOM.settingsPage.classList.toggle('translate-x-full',!show);if(show){loadUIData();DOM.settingsNavBtn.classList.add('nav-item-active');DOM.settingsNavBtn.classList.remove('text-wechat-lightText')}else{DOM.chatNavBtn.classList.add('nav-item-active');DOM.chatNavBtn.classList.remove('text-wechat-lightText')}}else if(page==='diary'){DOM.diaryListPage.classList.toggle('translate-x-full',!show);if(show){renderDiaryList();DOM.diaryNavBtn.classList.add('nav-item-active');DOM.diaryNavBtn.classList.remove('text-wechat-lightText')}else{DOM.chatNavBtn.classList.add('nav-item-active');DOM.chatNavBtn.classList.remove('text-wechat-lightText')}}else{if(isVisible(DOM.settingsPage))DOM.settingsPage.classList.add('translate-x-full');if(isVisible(DOM.diaryListPage))DOM.diaryListPage.classList.add('translate-x-full');DOM.chatNavBtn.classList.add('nav-item-active');DOM.chatNavBtn.classList.remove('text-wechat-lightText')}}
function isDiaryPageVisible(){return!DOM.diaryListPage.classList.contains('translate-x-full')}
function renderDiaryList(){DOM.diaryListContainer.innerHTML='';if(appData.chatObjects.length===0){DOM.diaryListContainer.innerHTML=`<div class="flex flex-col items-center justify-center h-full text-wechat-lightText py-10"><i class="fa fa-book text-4xl mb-3 opacity-50"></i><p class="text-sm">æš‚æ— èŠå¤©å¯¹è±¡ï¼Œæ— æ³•æŸ¥çœ‹æ—¥è®°</p></div>`;return}appData.chatObjects.forEach(chat=>{const item=document.createElement('div');item.className='flex items-center p-4 border-b border-wechat-darkGray cursor-pointer';item.dataset.chatId=chat.id;item.innerHTML=`<div class="w-12 h-12 rounded-full overflow-hidden mr-3 flex-shrink-0">${chat.avatar&&chat.avatar.type!=='default'&&chat.avatar.url?`<img src="${escapeHtml(chat.avatar.url)}" alt="${escapeHtml(chat.name)}" class="w-full h-full object-cover">`:`<div class="w-full h-full bg-wechat-green flex items-center justify-center text-white"><i class="fa fa-robot"></i></div>`}</div><div class="flex-1 min-w-0"><h3 class="font-medium text-wechat-text truncate">${escapeHtml(chat.name)}</h3><p class="text-xs text-wechat-lightText truncate mt-1">${chat.diaries.length}ç¯‡æ—¥è®°</p></div>`;item.addEventListener('click',()=>openDiaryDetail(chat.id));DOM.diaryListContainer.appendChild(item)})}
function openDiaryDetail(chatId){const chat=appData.chatObjects.find(c=>c.id===chatId);if(!chat)return;appData.diaryView.activeChatId=chatId;DOM.diaryDetailPageTitle.textContent=`${chat.name}çš„æ—¥è®°æœ¬`;renderDiaryEntries();DOM.diaryDetailPage.classList.remove('translate-x-full')}
function renderDiaryEntries(){DOM.diaryEntriesContainer.innerHTML='';const chat=appData.chatObjects.find(c=>c.id===appData.diaryView.activeChatId);if(!chat||chat.diaries.length===0){DOM.diaryEntriesContainer.innerHTML=`<div class="flex flex-col items-center justify-center h-full text-wechat-lightText py-10"><i class="fa fa-pencil-square-o text-4xl mb-3 opacity-50"></i><p class="text-sm">è¿˜æ²¡æœ‰ä»»ä½•æ—¥è®°æ¡ç›®</p><p class="text-xs mt-2">ä¸Taå¤šèŠèŠï¼Œæˆ–ç‚¹å‡»å³ä¸Šè§’æ‰‹åŠ¨æ€»ç»“</p></div>`;return}[...chat.diaries].sort((a,b)=>b.timestamp-a.timestamp).forEach(entry=>{const card=document.createElement('div');card.className='diary-entry-card relative';card.innerHTML=`<p class="text-xs text-diary-text/60 mb-2">${getFormattedTimestamp(entry.timestamp)}</p><p class="text-sm text-diary-text leading-relaxed">${escapeHtml(entry.content)}</p><div class="absolute top-2 right-2 flex gap-2"><button data-entry-id="${entry.id}" class="edit-diary-btn text-diary-text/50 hover:text-wechat-green p-1"><i class="fa fa-pencil"></i></button><button data-entry-id="${entry.id}" class="delete-diary-btn text-diary-text/50 hover:text-wechat-red p-1"><i class="fa fa-trash"></i></button></div>`;card.querySelector('.edit-diary-btn').addEventListener('click',(e)=>{e.stopPropagation();showEditDiaryModal(entry.id)});card.querySelector('.delete-diary-btn').addEventListener('click',(e)=>{e.stopPropagation();if(confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚'))deleteDiaryEntry(entry.id)});DOM.diaryEntriesContainer.appendChild(card)})}
function showEditDiaryModal(entryId){const chat=appData.chatObjects.find(c=>c.id===appData.diaryView.activeChatId);const entry=chat?.diaries.find(d=>d.id===entryId);if(!entry)return;appData.diaryView.editingEntryId=entryId;DOM.editDiaryEntryText.value=entry.content;DOM.editDiaryEntryModal.classList.remove('hidden')}
function closeEditDiaryModal(){DOM.editDiaryEntryModal.classList.add('hidden');appData.diaryView.editingEntryId=null}
function saveDiaryEntry(){const chat=appData.chatObjects.find(c=>c.id===appData.diaryView.activeChatId);const entry=chat?.diaries.find(d=>d.id===appData.diaryView.editingEntryId);if(!entry)return;entry.content=DOM.editDiaryEntryText.value;entry.timestamp=Date.now();saveDataToStorage();renderDiaryEntries();closeEditDiaryModal()}
function deleteDiaryEntry(entryId){const chatIndex=appData.chatObjects.findIndex(c=>c.id===appData.diaryView.activeChatId);if(chatIndex===-1)return;appData.chatObjects[chatIndex].diaries=appData.chatObjects[chatIndex].diaries.filter(d=>d.id!==entryId);saveDataToStorage();renderDiaryEntries()}
function showLogModal() { DOM.logOutput.value = appData.logs.join('\n'); DOM.logModal.classList.remove('hidden'); setTimeout(() => { DOM.logOutput.scrollTop = DOM.logOutput.scrollHeight; }, 100); }
function closeLogModal() { DOM.logModal.classList.add('hidden'); }
function clearLogs() { if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è¯Šæ–­æ—¥å¿—å—ï¼Ÿ')) { appData.logs = []; logToUI('æ—¥å¿—å·²æ¸…ç©ºã€‚'); if (!DOM.logModal.classList.contains('hidden')) { showLogModal(); } alert('æ—¥å¿—å·²æ¸…ç©ºï¼'); } }
// =========================================================================
//  è¡¨æƒ…åŠŸèƒ½
// =========================================================================

const MAX_STICKERS = 200;  // æœ€å¤§è¡¨æƒ…æ•°é‡é™åˆ¶
const EMOJI_LIST = [
    'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜',
    'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘',
    'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®',
    'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ˜•', 'ğŸ˜Ÿ', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜®',
    'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£', 'ğŸ˜', 'ğŸ˜“',
    'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ’€', 'â˜ ï¸', 'ğŸ’©', 'ğŸ¤¡', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ‘»',
    'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ’‹',
    'ğŸ’¯', 'ğŸ’¢', 'ğŸ’¥', 'ğŸ’«', 'ğŸ’¦', 'ğŸ’¨', 'ğŸ•³ï¸', 'ğŸ’¤', 'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤',
    'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘', 'âœŠ', 'ğŸ‘Š', 'ğŸ¤›',
    'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'âœï¸', 'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤',
    'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'â˜€ï¸', 'ğŸŒ™', 'â­', 'ğŸŒŸ', 'âœ¨'
];

// åˆå§‹åŒ–Emojiç½‘æ ¼
function initEmojiGrid() {
    if (!DOM.emojiGrid) return;
    DOM.emojiGrid.innerHTML = EMOJI_LIST.map(emoji => 
        `<button class="emoji-item" data-emoji="${emoji}">${emoji}</button>`
    ).join('');
}

// æ¸²æŸ“è¡¨æƒ…å›¾ç½‘æ ¼
function renderStickerGrid() {
    if (!DOM.stickerGrid) return;
    
    if (appData.stickers.length === 0) {
        DOM.stickerGrid.innerHTML = '';
        if (DOM.stickerEmptyHint) DOM.stickerEmptyHint.style.display = 'block';
        return;
    }
    
    if (DOM.stickerEmptyHint) DOM.stickerEmptyHint.style.display = 'none';
    
    DOM.stickerGrid.innerHTML = appData.stickers.map(s => `
        <div class="sticker-item" data-sticker-name="${escapeHtml(s.name)}">
            <img src="${escapeHtml(s.url)}" alt="${escapeHtml(s.name)}" loading="lazy" onerror="this.style.display='none'">
            <span class="sticker-name">:${escapeHtml(s.name)}:</span>
            <button class="delete-sticker-btn" data-sticker-id="${s.id}">Ã—</button>
        </div>
    `).join('');
}

// åˆ‡æ¢è¡¨æƒ…é¢æ¿æ˜¾ç¤º
function toggleStickerPanel() {
    const isShow = DOM.stickerPanel.classList.toggle('show');
    DOM.stickerToggleBtn.classList.toggle('active', isShow);
}

// å…³é—­è¡¨æƒ…é¢æ¿
function closeStickerPanel() {
    DOM.stickerPanel.classList.remove('show');
    DOM.stickerToggleBtn.classList.remove('active');
}

// åˆ‡æ¢è¡¨æƒ…é¢æ¿Tab
function switchStickerTab(tab) {
    DOM.emojiTabBtn.classList.toggle('active', tab === 'emoji');
    DOM.customStickerTabBtn.classList.toggle('active', tab === 'custom');
    DOM.emojiSection.classList.toggle('active', tab === 'emoji');
    DOM.customStickerSection.classList.toggle('active', tab === 'custom');
}

// æ’å…¥Emojiåˆ°è¾“å…¥æ¡†
function insertEmoji(emoji) {
    const input = DOM.chatPageMessageInput;
    const start = input.selectionStart;
    const end = input.selectionEnd;
    const text = input.value;
    input.value = text.substring(0, start) + emoji + text.substring(end);
    input.selectionStart = input.selectionEnd = start + emoji.length;
    input.focus();
}

// æ’å…¥è¡¨æƒ…ä»£ç åˆ°è¾“å…¥æ¡†
function insertStickerCode(name) {
    const input = DOM.chatPageMessageInput;
    const start = input.selectionStart;
    const text = input.value;
    const code = `:${name}:`;
    input.value = text.substring(0, start) + code + text.substring(start);
    input.selectionStart = input.selectionEnd = start + code.length;
    input.focus();
    closeStickerPanel();
}

// æ‰“å¼€æ·»åŠ è¡¨æƒ…æ¨¡æ€æ¡†
function openAddStickerModal(mode) {
    appData.stickerTempData = { mode, uploadData: null };
    
    // éšè—æ‰€æœ‰section
    DOM.stickerUploadSection.style.display = 'none';
    DOM.stickerUrlSection.style.display = 'none';
    DOM.stickerImportSection.style.display = 'none';
    
    // é‡ç½®è¡¨å•
    DOM.uploadStickerName.value = '';
    DOM.urlStickerName.value = '';
    DOM.stickerUrlInput.value = '';
    DOM.stickerImportText.value = '';
    DOM.stickerUploadPreviewImg.style.display = 'none';
    DOM.stickerUploadPlaceholder.style.display = 'block';
    DOM.stickerUrlPreviewImg.style.display = 'none';
    DOM.stickerUrlPlaceholder.style.display = 'block';
    DOM.stickerFileInput.value = '';
    
    // æ˜¾ç¤ºå¯¹åº”sectionå’Œæ ‡é¢˜
    const titles = { upload: 'ä¸Šä¼ è¡¨æƒ…å›¾', url: 'ä»URLæ·»åŠ è¡¨æƒ…å›¾', import: 'æ‰¹é‡å¯¼å…¥è¡¨æƒ…å›¾' };
    DOM.addStickerModalTitle.textContent = titles[mode] || 'æ·»åŠ è¡¨æƒ…å›¾';
    
    if (mode === 'upload') DOM.stickerUploadSection.style.display = 'block';
    else if (mode === 'url') DOM.stickerUrlSection.style.display = 'block';
    else if (mode === 'import') DOM.stickerImportSection.style.display = 'block';
    
    DOM.addStickerModal.classList.remove('hidden');
    closeStickerPanel();
}

// å…³é—­æ·»åŠ è¡¨æƒ…æ¨¡æ€æ¡†
function closeAddStickerModal() {
    DOM.addStickerModal.classList.add('hidden');
    appData.stickerTempData = { mode: 'upload', uploadData: null };
}

// å¤„ç†è¡¨æƒ…ä¸Šä¼ é¢„è§ˆ
async function handleStickerUpload(file) {
    if (!file || !file.type.startsWith('image/')) return;
    
    // å¯¹äºGIFä¿æŒåŸæ ·ï¼Œå…¶ä»–æ ¼å¼å‹ç¼©
    if (file.type === 'image/gif') {
        const reader = new FileReader();
        reader.onload = (e) => {
            const dataUrl = e.target.result;
            // æ£€æŸ¥å¤§å°ï¼ŒGIFå¦‚æœå¤ªå¤§æç¤ºç”¨URLæ–¹å¼
            if (dataUrl.length > 100 * 1024) {
                alert('GIFå›¾ç‰‡è¾ƒå¤§ï¼Œå»ºè®®ä½¿ç”¨URLæ–¹å¼æ·»åŠ ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´');
            }
            appData.stickerTempData.uploadData = dataUrl;
            DOM.stickerUploadPreviewImg.src = dataUrl;
            DOM.stickerUploadPreviewImg.style.display = 'block';
            DOM.stickerUploadPlaceholder.style.display = 'none';
        };
        reader.readAsDataURL(file);
    } else {
        // éGIFå‹ç¼©å¤„ç†
        const compressed = await compressImage(file, 150);
        appData.stickerTempData.uploadData = compressed;
        DOM.stickerUploadPreviewImg.src = compressed;
        DOM.stickerUploadPreviewImg.style.display = 'block';
        DOM.stickerUploadPlaceholder.style.display = 'none';
    }
}

// é¢„è§ˆURLè¡¨æƒ…
function previewStickerUrl() {
    const url = DOM.stickerUrlInput.value.trim();
    if (url) {
        DOM.stickerUrlPreviewImg.src = url;
        DOM.stickerUrlPreviewImg.style.display = 'block';
        DOM.stickerUrlPlaceholder.style.display = 'none';
        DOM.stickerUrlPreviewImg.onerror = () => {
            DOM.stickerUrlPreviewImg.style.display = 'none';
            DOM.stickerUrlPlaceholder.style.display = 'block';
        };
    } else {
        DOM.stickerUrlPreviewImg.style.display = 'none';
        DOM.stickerUrlPlaceholder.style.display = 'block';
    }
}

// ä¿å­˜è¡¨æƒ…
function saveSticker() {
    const mode = appData.stickerTempData.mode;
    
    if (appData.stickers.length >= MAX_STICKERS) {
        alert(`è¡¨æƒ…æ•°é‡å·²è¾¾ä¸Šé™ï¼ˆ${MAX_STICKERS}ä¸ªï¼‰ï¼Œè¯·å…ˆåˆ é™¤ä¸€äº›è¡¨æƒ…`);
        return;
    }
    
    if (mode === 'upload') {
        const name = DOM.uploadStickerName.value.trim();
        if (!name) { alert('è¯·è¾“å…¥è¡¨æƒ…åç§°'); return; }
        if (!appData.stickerTempData.uploadData) { alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡'); return; }
        if (appData.stickers.find(s => s.name === name)) { alert('è¯¥è¡¨æƒ…åç§°å·²å­˜åœ¨'); return; }
        
        appData.stickers.push({
            id: generateUniqueId(),
            name,
            url: appData.stickerTempData.uploadData
        });
        
    } else if (mode === 'url') {
        const name = DOM.urlStickerName.value.trim();
        const url = DOM.stickerUrlInput.value.trim();
        if (!name || !url) { alert('è¯·å¡«å†™è¡¨æƒ…åç§°å’ŒURL'); return; }
        if (appData.stickers.find(s => s.name === name)) { alert('è¯¥è¡¨æƒ…åç§°å·²å­˜åœ¨'); return; }
        
        appData.stickers.push({
            id: generateUniqueId(),
            name,
            url
        });
        
    } else if (mode === 'import') {
        const text = DOM.stickerImportText.value.trim();
        if (!text) { alert('è¯·è¾“å…¥è¦å¯¼å…¥çš„è¡¨æƒ…'); return; }
        
        const lines = text.split('\n').filter(l => l.trim());
        let added = 0, errors = [];
        
        for (const line of lines) {
            if (appData.stickers.length >= MAX_STICKERS) {
                errors.push(`å·²è¾¾ä¸Šé™ï¼Œè·³è¿‡åç»­`);
                break;
            }
            
            // æ”¯æŒ åç§°:URL æˆ– åç§°ï¼šURLï¼ˆä¸­æ–‡å†’å·ï¼‰
            const match = line.match(/^(.+?)[:ï¼š](.+)$/);
            if (match) {
                const name = match[1].trim();
                const url = match[2].trim();
                
                if (appData.stickers.find(s => s.name === name)) {
                    errors.push(`åç§°é‡å¤: ${name}`);
                    continue;
                }
                
                appData.stickers.push({
                    id: generateUniqueId() + '_' + added,
                    name,
                    url
                });
                added++;
            } else {
                errors.push(`æ ¼å¼é”™è¯¯: ${line.substring(0, 15)}...`);
            }
        }
        
        if (errors.length > 0) {
            alert(`æˆåŠŸå¯¼å…¥ ${added} ä¸ªè¡¨æƒ…\n\né—®é¢˜é¡¹:\n${errors.slice(0, 5).join('\n')}${errors.length > 5 ? '\n...' : ''}`);
        } else if (added > 0) {
            alert(`æˆåŠŸå¯¼å…¥ ${added} ä¸ªè¡¨æƒ…ï¼`);
        }
    }
    
    saveStickerData();
    renderStickerGrid();
    closeAddStickerModal();
    logToUI(`è¡¨æƒ…ä¿å­˜æˆåŠŸï¼Œå½“å‰å…± ${appData.stickers.length} ä¸ªè¡¨æƒ…`);
}

// åˆ é™¤è¡¨æƒ…
function deleteSticker(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¡¨æƒ…å—ï¼Ÿ')) return;
    appData.stickers = appData.stickers.filter(s => s.id !== id);
    saveStickerData();
    renderStickerGrid();
}

// ä¿å­˜è¡¨æƒ…æ•°æ®åˆ°localStorage
function saveStickerData() {
    try {
        localStorage.setItem('aiMultiChatStickers', JSON.stringify(appData.stickers));
    } catch (e) {
        console.error('ä¿å­˜è¡¨æƒ…æ•°æ®å¤±è´¥:', e);
        alert('ä¿å­˜è¡¨æƒ…å¤±è´¥ï¼Œå¯èƒ½å­˜å‚¨ç©ºé—´ä¸è¶³ã€‚å»ºè®®ä½¿ç”¨URLæ–¹å¼æ·»åŠ è¡¨æƒ…ã€‚');
    }
}

// åŠ è½½è¡¨æƒ…æ•°æ®
function loadStickerData() {
    try {
        const stored = localStorage.getItem('aiMultiChatStickers');
        appData.stickers = stored ? JSON.parse(stored) : [];
    } catch (e) {
        console.error('åŠ è½½è¡¨æƒ…æ•°æ®å¤±è´¥:', e);
        appData.stickers = [];
    }
}

// æ˜¾ç¤ºè¡¨æƒ…å…¨å±é¢„è§ˆ
function showStickerFullView(url) {
    DOM.stickerFullViewImg.src = url;
    DOM.stickerFullViewModal.classList.remove('hidden');
}

// å…³é—­è¡¨æƒ…å…¨å±é¢„è§ˆ
function closeStickerFullView() {
    DOM.stickerFullViewModal.classList.add('hidden');
}

// è§£ææ¶ˆæ¯å†…å®¹ä¸­çš„è¡¨æƒ…ä»£ç 
function parseMessageStickers(content) {
    if (!content) return '';
    
    // å…ˆè½¬ä¹‰HTML
    let result = escapeHtml(content);
    
    // æ›¿æ¢ :è¡¨æƒ…å: ä¸ºå›¾ç‰‡ï¼ˆåœ¨escapeHtmlä¹‹åå¤„ç†ï¼‰
    // ç”±äºescapeHtmlä¼šè½¬æ¢ç‰¹æ®Šå­—ç¬¦ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åŸå§‹contentæ¥åŒ¹é…
    const stickerPattern = /:([^:\s]+):/g;
    let match;
    
    // æ”¶é›†æ‰€æœ‰è¡¨æƒ…æ›¿æ¢
    const replacements = [];
    while ((match = stickerPattern.exec(content)) !== null) {
        const name = match[1];
        const sticker = appData.stickers.find(s => s.name === name);
        if (sticker) {
            replacements.push({
                original: `:${name}:`,
                escaped: escapeHtml(`:${name}:`),
                html: `<img class="message-sticker" src="${escapeHtml(sticker.url)}" alt=":${escapeHtml(name)}:" title=":${escapeHtml(name)}:" loading="lazy" onclick="showStickerFullView('${escapeHtml(sticker.url)}')">`
            });
        }
    }
    
    // åº”ç”¨æ›¿æ¢ï¼ˆä»åå¾€å‰æ›¿æ¢é¿å…ä½ç½®åç§»é—®é¢˜ï¼‰
    for (const r of replacements) {
        result = result.split(r.escaped).join(r.html);
    }
    
    return result;
}

function setupEventListeners(){const eMap={addChatBtn:{click:openAddChatModal},backToChatListBtn:{click:()=>{DOM.chatPage.classList.add('hidden');DOM.chatListPage.classList.remove('hidden')}},chatPageSendBtn:{click:sendChatMessage},chatPageMessageInput:{keydown:(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChatMessage()}},input:(e)=>{e.target.style.height='auto';e.target.style.height=`${Math.min(e.target.scrollHeight,120)}px`}},chatPageMoreBtn:{click:()=>{if(appData.activeChatId)openChatDetail(appData.activeChatId)}},settingsForm:{submit:saveApiSettings},refreshModelsBtn:{click:fetchModelList},
userAvatarUpload:{change:handleUserAvatarUpload},userAvatarUrlBtn:{click:()=>DOM.userAvatarUrlContainer.classList.toggle('hidden')},userAvatarUrlConfirm:{click:handleUserAvatarUrl},userAvatarUrlCancel:{click:()=>DOM.userAvatarUrlContainer.classList.add('hidden')},closeAddChatModalBtn:{click:closeAddChatModal},newChatAvatarUpload:{change:handleNewChatAvatarUpload},newChatAvatarUrlBtn:{click:()=>DOM.newChatAvatarUrlContainer.classList.toggle('hidden')},newChatAvatarUrlConfirm:{click:handleNewChatAvatarUrl},newChatAvatarUrlCancel:{click:()=>DOM.newChatAvatarUrlContainer.classList.add('hidden')},createChatBtn:{click:createNewChat},backToChatPageBtn:{click:()=>DOM.chatDetailPage.classList.add('translate-x-full')},deleteChatBtn:{click:()=>{if(appData.editChatTempData.chatId)showConfirmDeleteModal(appData.editChatTempData.chatId)}},editAvatarBtn:{click:()=>DOM.editAvatarContainer.classList.remove('hidden')},cancelEditAvatarBtn:{click:()=>DOM.editAvatarContainer.classList.add('hidden')},editChatAvatarUpload:{change:handleEditChatAvatarUpload},editChatAvatarUrlBtn:{click:()=>DOM.editChatAvatarUrlContainer.classList.toggle('hidden')},editChatAvatarUrlConfirm:{click:handleEditChatAvatarUrl},editChatAvatarUrlCancel:{click:()=>DOM.editChatAvatarUrlContainer.classList.add('hidden')},saveChatDetailBtn:{click:saveChatDetail},cancelDeleteBtn:{click:hideConfirmDeleteModal},confirmDeleteBtn:{click:()=>{if(appData.editChatTempData.chatId)deleteChat(appData.editChatTempData.chatId)}},regenerateMessageBtn:{click:()=>{if(appData.contextMenuData.messageIndex!==null)regenerateAiResponse(appData.contextMenuData.messageIndex);DOM.messageContextMenu.classList.add('hidden')}},
deleteMessageBtn:{click:()=>{deleteMessage(appData.contextMenuData.messageIndex);DOM.messageContextMenu.classList.add('hidden')}},
editMessageBtn:{click:()=>{editMessage(appData.contextMenuData.messageIndex);DOM.messageContextMenu.classList.add('hidden')}},
resendMessageBtn:{click:()=>{resendMessage(appData.contextMenuData.messageIndex);DOM.messageContextMenu.classList.add('hidden')}},
backupDataBtn:{click:backupData},restoreDataBtn:{click:triggerRestore},restoreFileInput:{change:handleRestoreFile},closeRestoreModalBtn:{click:closeRestoreModal},cancelRestoreBtn:{click:closeRestoreModal},confirmRestoreBtn:{click:confirmRestore},restoreSelectAll:{change:(e)=>document.querySelectorAll('.restore-chat-item').forEach(cb=>cb.checked=e.target.checked)},chatNavBtn:{click:()=>{togglePage('chat',true)}},diaryNavBtn:{click:()=>{togglePage('diary',true)}},settingsNavBtn:{click:()=>{togglePage('settings',true)}},closeSettingsBtn:{click:()=>{togglePage('settings',false)}},closeDiaryListPageBtn:{click:()=>{togglePage('diary',false)}},backToDiaryListBtn:{click:()=>DOM.diaryDetailPage.classList.add('translate-x-full')},manualDiaryBtn: {click: manualGenerateDiary}, resetDiaryPtrBtn: {click: resetDiaryPointer},viewLogsBtn: { click: showLogModal }, clearLogsBtn: { click: clearLogs }, closeLogModalBtn: { click: closeLogModal },closeEditDiaryModalBtn:{click:closeEditDiaryModal},cancelEditDiaryBtn:{click:closeEditDiaryModal},saveEditDiaryBtn:{click:saveDiaryEntry},
// è¡¨æƒ…åŠŸèƒ½äº‹ä»¶
stickerToggleBtn:{click:toggleStickerPanel},
emojiTabBtn:{click:()=>switchStickerTab('emoji')},
customStickerTabBtn:{click:()=>switchStickerTab('custom')},
addStickerUploadBtn:{click:()=>openAddStickerModal('upload')},
addStickerUrlBtn:{click:()=>openAddStickerModal('url')},
addStickerImportBtn:{click:()=>openAddStickerModal('import')},
closeAddStickerModalBtn:{click:closeAddStickerModal},
cancelAddStickerBtn:{click:closeAddStickerModal},
confirmAddStickerBtn:{click:saveSticker},
stickerUploadPreviewBox:{click:()=>DOM.stickerFileInput.click()},
stickerFileInput:{change:(e)=>handleStickerUpload(e.target.files[0])},
stickerUrlInput:{input:previewStickerUrl},
stickerFullViewModal:{click:closeStickerFullView}};for(const id in eMap){if(DOM[id]){for(const ev in eMap[id]){DOM[id].addEventListener(ev,eMap[id][ev])}}}[DOM.addChatModal,DOM.confirmDeleteModal,DOM.restoreModal,DOM.editDiaryEntryModal,DOM.logModal].forEach(el=>el.addEventListener('click',e=>{if(e.target===el)el.classList.add('hidden')}));[...DOM.addChatModal.children,...DOM.confirmDeleteModal.children,...DOM.restoreModal.children,...DOM.editDiaryEntryModal.children,...DOM.logModal.children,DOM.settingsPage,DOM.chatDetailPage,DOM.diaryListPage,DOM.diaryDetailPage].forEach(c=>c.addEventListener('click',e=>e.stopPropagation()));
DOM.chatPageContainer.addEventListener('contextmenu',(e)=>{
    const t=e.target.closest('[data-message-role]');
    if(t){
        e.preventDefault();
        const role = t.dataset.messageRole;
        appData.contextMenuData.messageIndex=parseInt(t.dataset.messageIndex,10);
        appData.contextMenuData.messageRole = role;
        DOM.regenerateMessageBtn.style.display = (role === 'assistant') ? 'block' : 'none';
        DOM.resendMessageBtn.style.display = (role === 'user') ? 'block' : 'none';
        DOM.messageContextMenu.style.left=`${e.clientX}px`;
        DOM.messageContextMenu.style.top=`${e.clientY}px`;
        DOM.messageContextMenu.classList.remove('hidden')
    }
});
// è¡¨æƒ…é¢æ¿äº‹ä»¶å§”æ‰˜
DOM.emojiGrid.addEventListener('click', (e) => {
    const btn = e.target.closest('.emoji-item');
    if (btn) {
        insertEmoji(btn.dataset.emoji);
    }
});

DOM.stickerGrid.addEventListener('click', (e) => {
    const item = e.target.closest('.sticker-item');
    const deleteBtn = e.target.closest('.delete-sticker-btn');
    
    if (deleteBtn) {
        e.stopPropagation();
        deleteSticker(deleteBtn.dataset.stickerId);
    } else if (item) {
        insertStickerCode(item.dataset.stickerName);
    }
});

// ç‚¹å‡»å¤–éƒ¨å…³é—­è¡¨æƒ…é¢æ¿
document.addEventListener('click', (e) => {
    if (!DOM.stickerPanel.contains(e.target) && !DOM.stickerToggleBtn.contains(e.target)) {
        closeStickerPanel();
    }
});

// æ·»åŠ è¡¨æƒ…æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­
DOM.addStickerModal.addEventListener('click', (e) => {
    if (e.target === DOM.addStickerModal) {
        closeAddStickerModal();
    }
});

document.addEventListener('click',()=>DOM.messageContextMenu.classList.add('hidden'));window.addEventListener('resize',adjustHeights)}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
