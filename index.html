<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾®ä¿¡é£æ ¼å¤šAIèŠå¤© (v5.3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"></noscript>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              wechat: { green: '#07C160', lightGreen: '#E6F4EA', gray: '#F5F5F5', darkGray: '#E5E5E5', text: '#333333', lightText: '#888888', red: '#F43530' },
              chat: { user: '#DDF4E8', ai: '#FFFFFF' },
              diary: { bg: '#FDFCF7', border: '#F0EAD6', text: '#6B4F4F' }
            },
            fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'] },
          },
        }
      }
    </script>
    <style type="text/tailwindcss">
      @layer utilities {
        .chat-bubble-user { @apply bg-chat-user rounded-2xl rounded-tr-none px-4 py-2 max-w-[80%] shadow-sm; }
        .chat-bubble-ai { @apply bg-chat-ai rounded-2xl rounded-tl-none px-4 py-2 max-w-[80%] shadow-sm border border-wechat-darkGray; }
        .nav-item-active { @apply text-wechat-green; }
        .input-focus { @apply ring-2 ring-wechat-green/30 outline-none; }
        .avatar-preview { @apply w-16 h-16 rounded-full object-cover border-2 border-wechat-green/50 cursor-pointer transition-all hover:border-wechat-green; }
        .avatar-upload-btn { @apply w-full bg-wechat-gray hover:bg-wechat-darkGray text-wechat-text py-2 rounded-lg text-sm transition-colors; }
        .typing-indicator { @apply text-center text-wechat-lightText text-sm py-2 px-4 opacity-0 pointer-events-none transition-opacity duration-300; }
        .typing-indicator.show { @apply opacity-100 pointer-events-auto; }
        .slide-delete-btn { @apply w-20 h-full bg-wechat-red text-white flex items-center justify-center transition-transform duration-300 transform translate-x-full; }
        .chat-item-wrapper { @apply flex items-center justify-between bg-white transition-transform duration-300; }
        .chat-item-wrapper.swipe-left { @apply transform -translate-x-20; }
        .chat-detail-header { @apply bg-[#ECE5DD] py-6 flex flex-col items-center; }
        .chat-item-actions { @apply absolute right-4 top-1/2 transform -translate-y-1/2 flex gap-2 opacity-0 transition-opacity duration-300; }
        .chat-item-container:hover .chat-item-actions { @apply opacity-100; }
        .delete-action-btn { @apply bg-wechat-red/10 text-wechat-red p-1.5 rounded-full hover:bg-wechat-red/20 transition-colors; }
        .edit-action-btn { @apply bg-wechat-green/10 text-wechat-green p-1.5 rounded-full hover:bg-wechat-green/20 transition-colors; }
        .user-avatar-small { @apply w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-white flex-shrink-0; }
        .message-context-menu { @apply absolute bg-white shadow-lg rounded-md p-2 z-50 text-sm; }
        .diary-entry-card { @apply bg-diary-bg border border-diary-border rounded-lg p-4 mb-4 shadow-sm break-words; }
      }
    </style>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-wechat-gray font-sans text-wechat-text">
<div class="h-screen overflow-hidden">

    <!-- ========== èŠå¤©åˆ—è¡¨é¡µ ========== -->
    <div id="chatListPage" class="h-full flex flex-col">
        <header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10">
            <h1 class="text-lg font-semibold">AIèŠå¤©åŠ©æ‰‹</h1>
            <button id="addChatBtn" class="text-wechat-text p-2 rounded-full hover:bg-wechat-gray transition-colors"><i class="fa fa-plus"></i></button>
        </header>
        <div id="chatListContainer" class="flex-1 chat-list-container bg-white">
            <div id="emptyChatList" class="flex flex-col items-center justify-center h-full text-wechat-lightText py-10">
                <i class="fa fa-comments-o text-4xl mb-3 opacity-50"></i>
                <p class="text-sm">æš‚æ— èŠå¤©å¯¹è±¡ï¼Œç‚¹å‡»å³ä¸Šè§’"+"æ·»åŠ </p>
            </div>
        </div>
        <nav class="bg-white border-t border-wechat-darkGray flex nav-safe-area">
            <button id="chatNavBtn" class="flex-1 py-3 flex flex-col items-center justify-center nav-item-active"><i class="fa fa-comments text-lg"></i><span class="text-xs mt-1">èŠå¤©</span></button>
            <!-- â˜… æ–°å¢ï¼šrelative + å°çº¢ç‚¹ -->
            <button id="momentsNavBtn" class="flex-1 py-3 flex flex-col items-center justify-center text-wechat-lightText relative"><i class="fa fa-camera-retro text-lg"></i><span class="text-xs mt-1">æœ‹å‹åœˆ</span><span id="momentsBadge" class="moments-badge" style="display:none;"></span></button>
            <button id="diaryNavBtn" class="flex-1 py-3 flex flex-col items-center justify-center text-wechat-lightText"><i class="fa fa-book text-lg"></i><span class="text-xs mt-1">æ—¥è®°</span></button>
            <button id="settingsNavBtn" class="flex-1 py-3 flex flex-col items-center justify-center text-wechat-lightText"><i class="fa fa-cog text-lg"></i><span class="text-xs mt-1">è®¾ç½®</span></button>
        </nav>
    </div>

    <!-- ========== èŠå¤©é¡µ ========== -->
    <div id="chatPage" class="chat-page hidden">
        <header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10">
            <div class="flex items-center">
                <button id="backToChatListBtn" class="text-wechat-text p-2 mr-2"><i class="fa fa-arrow-left"></i></button>
                <div class="flex items-center">
                    <div id="chatPageAvatar" class="w-8 h-8 rounded-full overflow-hidden mr-2"></div>
                    <h1 id="chatPageTitle" class="text-lg font-semibold">èŠå¤©å¯¹è±¡</h1>
                </div>
            </div>
            <button id="chatPageMoreBtn" class="text-wechat-text p-2 rounded-full hover:bg-wechat-gray transition-colors"><i class="fa fa-ellipsis-v"></i></button>
        </header>
        <main class="chat-main">
            <div id="chatPageTypingIndicator" class="typing-indicator"><span id="chatPageTypingText">æ­£åœ¨è¾“å…¥ä¸­...</span></div>
            <div id="chatPageContainer" class="chat-content p-4 bg-[#ECE5DD]"></div>
            <div class="chat-input-container bg-white border-t border-wechat-darkGray p-3 safe-area-bottom">
                <div class="flex items-center gap-2" style="position: relative;">
                    <div class="sticker-panel" id="stickerPanel">
                        <div class="sticker-tabs">
                            <button class="sticker-tab active" id="emojiTabBtn">ğŸ˜€ Emoji</button>
                            <button class="sticker-tab" id="customStickerTabBtn">ğŸ–¼ï¸ è¡¨æƒ…å›¾</button>
                        </div>
                        <div class="sticker-content">
                            <div class="sticker-section active" id="emojiSection">
                                <div class="emoji-grid" id="emojiGrid"></div>
                            </div>
                            <div class="sticker-section" id="customStickerSection">
                                <div class="sticker-grid" id="stickerGrid"></div>
                                <div class="sticker-empty-state" id="stickerEmptyHint" style="display:none;">
                                    <i class="fa fa-picture-o"></i>
                                    <p>è¿˜æ²¡æœ‰è¡¨æƒ…å›¾<br>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </p>
                                </div>
                            </div>
                        </div>
                        <div class="sticker-manage-bar">
                            <button class="sticker-manage-btn" id="addStickerUploadBtn"><i class="fa fa-upload"></i> ä¸Šä¼ </button>
                            <button class="sticker-manage-btn" id="addStickerUrlBtn"><i class="fa fa-link"></i> URL</button>
                            <button class="sticker-manage-btn" id="addStickerImportBtn"><i class="fa fa-download"></i> å¯¼å…¥</button>
                        </div>
                    </div>
                    <button class="sticker-tool-btn" id="stickerToggleBtn"><i class="fa fa-smile-o"></i></button>
                    <textarea id="chatPageMessageInput" class="flex-1 border border-wechat-darkGray rounded-full px-4 py-2 text-sm resize-none focus:input-focus transition-all" placeholder="è¾“å…¥æ¶ˆæ¯... ç”¨ :åç§°: å‘è¡¨æƒ…" rows="1"></textarea>
                    <button id="chatPageSendBtn" class="w-10 h-10 rounded-full bg-wechat-green flex items-center justify-center text-white"><i class="fa fa-paper-plane"></i></button>
                </div>
            </div>
        </main>
    </div>

    <!-- ========== è®¾ç½®é¡µ ========== -->
    <div id="settingsPage" class="fixed inset-0 bg-white z-20 transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto safe-area-bottom">
        <div class="p-4 border-b border-wechat-darkGray flex items-center justify-between sticky top-0 bg-white z-10">
            <h2 class="text-lg font-semibold">è®¾ç½®</h2>
            <button id="closeSettingsBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button>
        </div>
        <div class="p-4 space-y-8 pb-20">
            <!-- ç”¨æˆ·ä¿¡æ¯è®¾ç½® -->
            <div class="space-y-6">
                <h3 class="text-base font-semibold text-wechat-text border-b border-wechat-darkGray pb-2">ç”¨æˆ·ä¿¡æ¯è®¾ç½®</h3>
                <div class="space-y-3">
                    <label class="block text-sm font-medium text-wechat-text">ä½ çš„å¤´åƒ</label>
                    <div class="flex flex-col items-center">
                        <div class="relative mb-3">
                            <img id="userAvatarPreview" class="avatar-preview" alt="ä½ çš„å¤´åƒé¢„è§ˆ">
                            <i id="userAvatarIcon" class="fa fa-user absolute inset-0 flex items-center justify-center text-white text-xl bg-gray-400 rounded-full"></i>
                        </div>
                        <div class="flex gap-3 w-full max-w-xs">
                            <label class="flex-1 text-center">
                                <input type="file" id="userAvatarUpload" accept="image/*" class="hidden">
                                <button type="button" class="avatar-upload-btn" onclick="document.getElementById('userAvatarUpload').click()"><i class="fa fa-upload mr-1"></i> æœ¬åœ°ä¸Šä¼ </button>
                            </label>
                            <button type="button" class="flex-1 avatar-upload-btn" id="userAvatarUrlBtn"><i class="fa fa-link mr-1"></i> è¾“å…¥URL</button>
                        </div>
                        <div id="userAvatarUrlContainer" class="w-full max-w-xs mt-3 hidden">
                            <input type="url" id="userAvatarUrl" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="è¾“å…¥å¤´åƒå›¾ç‰‡URL">
                            <div class="flex gap-2 mt-2">
                                <button type="button" class="flex-1 bg-wechat-green text-white py-2 rounded-lg text-sm" id="userAvatarUrlConfirm">ç¡®è®¤</button>
                                <button type="button" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm" id="userAvatarUrlCancel">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-3">
                    <label class="block text-sm font-medium text-wechat-text">ä½ çš„åç§°<span class="text-xs text-wechat-lightText ml-1">(å‘é€ç»™APIä½¿ç”¨)</span></label>
                    <input type="text" id="userName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="è¾“å…¥ä½ çš„åç§°" value="user">
                </div>
            </div>
            <!-- APIä¸æ¨¡å‹é…ç½® -->
            <div class="space-y-6">
                <h3 class="text-base font-semibold text-wechat-text border-b border-wechat-darkGray pb-2">APIä¸æ¨¡å‹é…ç½®</h3>
                <form id="settingsForm" class="space-y-4">
                    <div><label class="block text-sm font-medium text-wechat-text mb-1">API Base URL</label><input type="url" id="baseUrl" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="https://api.openai.com/v1" value="https://api.openai.com/v1"></div>
                    <div><label class="block text-sm font-medium text-wechat-text mb-1">API Key</label><input type="password" id="apiKey" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="sk-..."></div>
                    <div><label class="block text-sm font-medium text-wechat-text mb-1">æ¨¡å‹åç§°</label><div class="flex gap-2"><select id="modelName" class="flex-1 border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus"></select><button type="button" id="refreshModelsBtn" class="bg-wechat-green/10 text-wechat-green px-3 py-2 rounded-lg hover:bg-wechat-green/20 transition-colors"><i class="fa fa-refresh"></i></button></div><p class="text-xs text-wechat-lightText mt-1">å¡«å†™APIåœ°å€å’ŒKeyåï¼Œç‚¹å‡»åˆ·æ–°æŒ‰é’®è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨</p></div>
                    <div><label for="apiTemperature" class="block text-sm font-medium text-wechat-text mb-1">æ¨¡å‹æ¸©åº¦ (Temperature)</label><input type="number" id="apiTemperature" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ä¾‹å¦‚: 0.7" value="0.7" min="0" max="2" step="0.1"><p class="text-xs text-wechat-lightText mt-1">æ§åˆ¶å›ç­”çš„éšæœºæ€§ã€‚å€¼è¶Šé«˜å›ç­”è¶Šæœ‰åˆ›æ„ï¼Œå€¼è¶Šä½å›ç­”è¶Šç¨³å®šã€‚é»˜è®¤ 0.7ã€‚</p></div>
                    <div><label class="block text-sm font-medium text-wechat-text mb-1">å•æ¬¡ä¸Šä¸‹æ–‡è½®æ¬¡ (çŸ­æœŸè®°å¿†)</label><input type="number" id="historyTurns" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ä¾‹å¦‚: 10" value="10" min="0"><p class="text-xs text-wechat-lightText mt-1">æ¯æ¬¡è¯·æ±‚APIæ—¶ï¼Œè¯»å–æœ€è¿‘çš„Nè½®å¯¹è¯ã€‚0æˆ–ç©ºè¡¨ç¤ºä¸é™åˆ¶ã€‚</p></div>
                    <div><label class="block text-sm font-medium text-wechat-text mb-1">æ—¥è®°ç”Ÿæˆé¢‘ç‡ (è½®)</label><input type="number" id="diaryGenerationTurns" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ä¾‹å¦‚: 30" value="30" min="0"><p class="text-xs text-wechat-lightText mt-1">æ¯éš”Nè½®å¯¹è¯ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ç¯‡æ—¥è®°ã€‚0è¡¨ç¤ºç¦ç”¨ã€‚</p></div>
                    <div><label for="globalSystemPrompt" class="block text-sm font-medium text-wechat-text mb-1">å…¨å±€ç³»ç»Ÿæç¤ºè¯</label><textarea id="globalSystemPrompt" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm resize-none focus:input-focus h-48" placeholder="å®šä¹‰å…¨å±€è§„åˆ™ï¼Œå¯¹æ‰€æœ‰èŠå¤©å¯¹è±¡ç”Ÿæ•ˆ..."></textarea><p class="text-xs text-wechat-lightText mt-1">æ­¤æç¤ºè¯æ‹¥æœ‰æœ€é«˜ä¼˜å…ˆçº§ï¼Œå°†ä¸æ¯ä¸ªèŠå¤©å¯¹è±¡çš„äººè®¾æç¤ºè¯åˆå¹¶åå‘é€ç»™AIã€‚</p></div>
                    
                </form>
            </div>

            <!-- â˜… æ–°å¢ï¼šå›¾ç‰‡ç”ŸæˆAPIé…ç½® -->
            <div class="space-y-6">
                <h3 class="text-base font-semibold text-wechat-text border-b border-wechat-darkGray pb-2"><i class="fa fa-picture-o mr-1"></i>å›¾ç‰‡ç”Ÿæˆé…ç½®ï¼ˆå¯é€‰ï¼‰</h3>
                <p class="text-xs text-wechat-lightText">ä¸ºæœ‹å‹åœˆåŠ¨æ€ç”Ÿæˆé…å›¾ã€‚ç•™ç©ºåˆ™ä¸ä½¿ç”¨AIç”Ÿå›¾ã€‚APIåœ°å€å’ŒKeyç•™ç©ºæ—¶å¤ç”¨ä¸»æ¨¡å‹é…ç½®ã€‚</p>
                <div class="space-y-4">
                    <div><label class="block text-sm font-medium text-wechat-text mb-1">ç”Ÿå›¾APIåœ°å€</label><input type="text" id="imageGenBaseUrl" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨ä¸»APIåœ°å€"></div>
                    <div><label class="block text-sm font-medium text-wechat-text mb-1">ç”Ÿå›¾API Key</label><input type="password" id="imageGenApiKey" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨ä¸»API Key"></div>
                    <div><label class="block text-sm font-medium text-wechat-text mb-1">ç”Ÿå›¾æ¨¡å‹å</label><input type="text" id="imageGenModelName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ä¾‹å¦‚ï¼šgemini-2.0-flash-exp"></div>
                    <div>
                        <label class="block text-sm font-medium text-wechat-text mb-1">æ¥å£ç±»å‹</label>
                        <div class="flex items-center gap-4 mt-1">
                            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="imageGenInterface" id="imageGenInterfaceChat" value="chat" checked class="text-wechat-green focus:ring-wechat-green"><span class="text-sm">/chat/completions</span></label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="imageGenInterface" id="imageGenInterfaceImages" value="images" class="text-wechat-green focus:ring-wechat-green"><span class="text-sm">/images/generations</span></label>
                        </div>
                        <p class="text-xs text-wechat-lightText mt-1">Gemini/GPT-4o é€‰ chatï¼ŒDALL-E é€‰ images</p>
                    </div>
                </div>
            </div>

            <!-- â˜… æ–°å¢ï¼šè¾…åŠ©APIé…ç½® -->
            <div class="space-y-6">
                <h3 class="text-base font-semibold text-wechat-text border-b border-wechat-darkGray pb-2"><i class="fa fa-cogs mr-1"></i>è¾…åŠ©APIé…ç½®ï¼ˆå¯é€‰ï¼‰</h3>
                <p class="text-xs text-wechat-lightText">å¤„ç†å¥½å‹è¯„è®ºã€æœç´¢è§’è‰²å…³ç³»ç­‰è½»é‡çº§ä»»åŠ¡ã€‚å…¨éƒ¨ç•™ç©ºåˆ™ä½¿ç”¨ä¸»æ¨¡å‹ã€‚</p>
                <div class="space-y-4">
                    <div><label class="block text-sm font-medium text-wechat-text mb-1">è¾…åŠ©APIåœ°å€</label><input type="text" id="auxBaseUrl" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨ä¸»APIåœ°å€"></div>
                    <div><label class="block text-sm font-medium text-wechat-text mb-1">è¾…åŠ©API Key</label><input type="password" id="auxApiKey" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨ä¸»API Key"></div>
                    <div><label class="block text-sm font-medium text-wechat-text mb-1">è¾…åŠ©æ¨¡å‹å</label><input type="text" id="auxModelName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ä¾‹å¦‚ï¼šgemini-2.0-flashã€gpt-4o-mini"></div>
                </div>
            </div>
            <!-- ä¿å­˜æŒ‰é’®ï¼ˆç§»åˆ°æ­¤å¤„ï¼‰ -->
            <button type="button" id="saveAllSettingsBtn" class="w-full bg-wechat-green text-white py-3 rounded-lg font-medium hover:bg-wechat-green/90 transition-colors"><i class="fa fa-save mr-2"></i>ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
            
            <!-- æ•°æ®å¤‡ä»½ä¸æ¢å¤ -->
            <div class="space-y-6">
                <h3 class="text-base font-semibold text-wechat-text border-b border-wechat-darkGray pb-2">æ•°æ®å¤‡ä»½ä¸æ¢å¤</h3>
                <p class="text-sm text-wechat-lightText">æ‚¨å¯ä»¥å°†å…¨éƒ¨èŠå¤©æ•°æ®å¤‡ä»½åˆ°ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ä¸­ã€‚</p>
                <div class="flex gap-3">
                    <button type="button" id="backupDataBtn" class="flex-1 bg-wechat-green/10 text-wechat-green py-3 rounded-lg font-medium hover:bg-wechat-green/20 transition-colors"><i class="fa fa-download mr-2"></i><span>å¤‡ä»½å…¨éƒ¨æ•°æ®</span></button>
                    <button type="button" id="restoreDataBtn" class="flex-1 bg-wechat-green/10 text-wechat-green py-3 rounded-lg font-medium hover:bg-wechat-green/20 transition-colors"><i class="fa fa-upload mr-2"></i><span>ä»æ–‡ä»¶æ¢å¤</span></button>
                    <input type="file" id="restoreFileInput" class="hidden" accept=".zip">
                </div>
            </div>
            <!-- è¯Šæ–­ä¸è°ƒè¯• -->
            <div class="space-y-6">
                <h3 class="text-base font-semibold text-wechat-text border-b border-wechat-darkGray pb-2">è¯Šæ–­ä¸è°ƒè¯•</h3>
                <p class="text-sm text-wechat-lightText">å¦‚æœé‡åˆ°åŠŸèƒ½å¼‚å¸¸ï¼Œå¯ä»¥æŸ¥çœ‹å†…éƒ¨æ—¥å¿—ä»¥å¸®åŠ©å®šä½é—®é¢˜ã€‚</p>
                <div class="flex gap-3">
                    <button type="button" id="viewLogsBtn" class="flex-1 bg-wechat-green/10 text-wechat-green py-3 rounded-lg font-medium"><i class="fa fa-file-text-o mr-2"></i>æŸ¥çœ‹è¯Šæ–­æ—¥å¿—</button>
                    <button type="button" id="clearLogsBtn" class="flex-1 bg-wechat-red/10 text-wechat-red py-3 rounded-lg font-medium"><i class="fa fa-eraser mr-2"></i>æ¸…ç©ºæ—¥å¿—</button>
                </div>
            </div>
        </div>
    </div>
    <!-- ========== æœ‹å‹åœˆé¡µé¢ ========== -->
    <div id="momentsPage" class="fixed inset-0 bg-white z-20 transform translate-x-full transition-transform duration-300 ease-in-out h-full flex flex-col">
        <header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10">
            <h1 class="text-lg font-semibold">æœ‹å‹åœˆ</h1>
            <div class="flex items-center gap-2">
                <select id="momentsChatSelector" class="border border-wechat-darkGray rounded-lg px-2 py-1 text-sm focus:input-focus max-w-[120px] truncate">
                    <option value="">é€‰æ‹©è§’è‰²</option>
                </select>
                <button id="npcFriendsBtn" class="text-wechat-text p-2 rounded-full hover:bg-wechat-gray transition-colors" title="å¥½å‹ç®¡ç†"><i class="fa fa-users"></i></button>
                <button id="openPublishMomentBtn" class="bg-wechat-green text-white px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-wechat-green/90 transition-colors"><i class="fa fa-pencil-square-o mr-1"></i>å‘åŠ¨æ€</button>
                <button id="closeMomentsPageBtn" class="text-wechat-text p-2 rounded-full hover:bg-wechat-gray transition-colors"><i class="fa fa-times"></i></button>
            </div>
        </header>
        <!-- â˜… æ”¹é€ ï¼šç”¨ä¸€ä¸ªæ»šåŠ¨å®¹å™¨åŒ…è£¹å°é¢+è¿›åº¦+åˆ—è¡¨ï¼Œä½¿å°é¢å¯ä»¥è¢«æ»šèµ° -->
        <div class="flex-1 overflow-y-auto">
            <div class="moments-cover">
                <div class="moments-cover-bg"></div>
                <div class="moments-user-info">
                    <span id="momentsUserName" class="moments-user-name">æˆ‘</span>
                    <div id="momentsUserAvatar" class="moments-user-avatar"><i class="fa fa-user"></i></div>
                </div>
            </div>
            <!-- å‘å¸ƒè¿›åº¦æŒ‡ç¤ºå™¨ -->
            <div id="momentsPublishingIndicator" class="hidden"></div>
            <div id="momentsListContainer" class="moments-list-container bg-white"></div>
        </div>
    </div>

    <!-- ========== æœ‹å‹åœˆåŠ¨æ€è¯¦æƒ…é¡µ ========== -->
    <div id="momentDetailPage" class="fixed inset-0 bg-white z-30 transform translate-x-full transition-transform duration-300 ease-in-out h-full flex flex-col">
        <header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10">
            <div class="flex items-center">
                <button id="backToMomentsBtn" class="text-wechat-text p-2 mr-2"><i class="fa fa-arrow-left"></i></button>
                <h1 class="text-lg font-semibold">åŠ¨æ€è¯¦æƒ…</h1>
            </div>
            <button id="deleteMomentBtn" class="text-wechat-red p-2" title="åˆ é™¤åŠ¨æ€"><i class="fa fa-trash"></i></button>
        </header>
        <div id="momentDetailContent" class="flex-1 overflow-y-auto"></div>
        <!-- â˜… æ–°å¢ï¼šå›å¤æŒ‡ç¤ºå™¨ -->
        <div class="moment-comment-input bg-white border-t border-wechat-darkGray safe-area-bottom">
            <div id="momentReplyIndicator"></div>
            <div class="p-3 flex items-center gap-2">
                <input type="text" id="momentCommentInput" class="flex-1 border border-wechat-darkGray rounded-full px-4 py-2 text-sm focus:input-focus" placeholder="å†™è¯„è®º...">
                <button id="momentCommentSendBtn" class="w-10 h-10 rounded-full bg-wechat-green flex items-center justify-center text-white"><i class="fa fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- ========== å‘å¸ƒæœ‹å‹åœˆæ¨¡æ€æ¡†ï¼ˆâ˜… æ”¹é€ ï¼šæ·»åŠ å›¾ç‰‡æ¨¡å¼é€‰æ‹©ï¼‰ ========== -->
    <div id="publishMomentModal" class="fixed inset-0 bg-black/50 z-40 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg w-[90%] max-w-md max-h-[85vh] overflow-y-auto">
            <div class="p-4 border-b border-wechat-darkGray flex items-center justify-between sticky top-0 bg-white z-10">
                <h2 class="text-lg font-semibold">è®©TAå‘æ¡æœ‹å‹åœˆ</h2>
                <button id="closePublishMomentModalBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button>
            </div>
            <div class="p-4 space-y-4">
                <div class="flex items-center gap-3 p-3 bg-wechat-gray rounded-lg">
                    <div id="publishMomentAvatar" class="w-12 h-12 rounded-full overflow-hidden flex-shrink-0 bg-wechat-green flex items-center justify-center text-white"><i class="fa fa-robot"></i></div>
                    <div>
                        <p id="publishMomentName" class="font-medium text-wechat-text">AIåŠ©æ‰‹</p>
                        <p class="text-xs text-wechat-lightText">å°†ä»¥TAçš„èº«ä»½å‘å¸ƒ</p>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-wechat-text mb-2">å‘å¸ƒæ–¹å¼</label>
                    <div class="flex gap-2">
                        <button id="publishModeAuto" class="flex-1 py-2 px-3 rounded-lg border-2 border-wechat-green bg-wechat-green/10 text-wechat-green text-sm font-medium transition-all active">
                            <i class="fa fa-magic mr-1"></i>AIè‡ªåŠ¨ç”Ÿæˆ
                        </button>
                        <button id="publishModeManual" class="flex-1 py-2 px-3 rounded-lg border-2 border-wechat-darkGray text-wechat-lightText text-sm font-medium transition-all">
                            <i class="fa fa-pencil mr-1"></i>æ‰‹åŠ¨è¾“å…¥
                        </button>
                    </div>
                </div>
                <div id="publishAutoOptions">
                    <label class="block text-sm font-medium text-wechat-text mb-2">ç”Ÿæˆä¾æ®</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="publishBasis" value="chat" checked class="text-wechat-green focus:ring-wechat-green">
                            <span class="text-sm">åŸºäºæœ€è¿‘çš„èŠå¤©å†…å®¹</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="publishBasis" value="free" class="text-wechat-green focus:ring-wechat-green">
                            <span class="text-sm">è‡ªç”±å‘æŒ¥ï¼ˆéšæœºå¿ƒæƒ…/æ—¥å¸¸ï¼‰</span>
                        </label>
                    </div>
                </div>
                <div id="publishManualOptions" class="hidden">
                    <label class="block text-sm font-medium text-wechat-text mb-2">åŠ¨æ€å†…å®¹</label>
                    <textarea id="publishMomentContent" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus h-24" placeholder="å†™ç‚¹ä»€ä¹ˆ..."></textarea>
                </div>

                <!-- â˜… æ–°å¢ï¼šé…å›¾æ–¹å¼é€‰æ‹© -->
                <div>
                    <label class="block text-sm font-medium text-wechat-text mb-2">é…å›¾æ–¹å¼</label>
                    <div class="flex gap-2">
                        <button id="publishImageModeAI" class="flex-1 border-2 rounded-lg py-2 text-xs cursor-pointer img-mode-btn active" onclick="setImageMode('ai')">
                            <i class="fa fa-magic"></i> AIç”Ÿå›¾
                        </button>
                        <button id="publishImageModeUrl" class="flex-1 border-2 rounded-lg py-2 text-xs cursor-pointer img-mode-btn" onclick="setImageMode('url')">
                            <i class="fa fa-link"></i> æ‰‹åŠ¨URL
                        </button>
                        <button id="publishImageModeNone" class="flex-1 border-2 rounded-lg py-2 text-xs cursor-pointer img-mode-btn" onclick="setImageMode('none')">
                            <i class="fa fa-ban"></i> æ— å›¾
                        </button>
                    </div>
                </div>

                <!-- â˜… æ–°å¢ï¼šAIç”Ÿå›¾æç¤º -->
                <div id="publishImageAIArea">
                    <p class="text-xs text-wechat-lightText"><i class="fa fa-info-circle"></i> å°†æ ¹æ®æ–‡æ¡ˆè‡ªåŠ¨ç”Ÿæˆé…å›¾ï¼ˆéœ€é…ç½®ç”Ÿå›¾APIï¼‰<br>70%æ¦‚ç‡ç”Ÿæˆé…å›¾ï¼Œæ¨¡æ‹ŸçœŸå®æœ‹å‹åœˆ</p>
                </div>

                <!-- â˜… æ”¹é€ ï¼šæ‰‹åŠ¨URLè¾“å…¥åŒºåŸŸï¼ˆç”¨divåŒ…è£¹ï¼Œé»˜è®¤hiddenï¼‰ -->
                <div id="publishImageUrlArea" class="hidden">
                    <label class="block text-sm font-medium text-wechat-text mb-2">é…å›¾URLï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œæœ€å¤š9å¼ ï¼‰</label>
                    <textarea id="publishMomentImages" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus h-16" placeholder="https://example.com/image.jpg"></textarea>
                </div>

                <button id="confirmPublishMomentBtn" class="w-full bg-wechat-green text-white py-3 rounded-lg font-medium hover:bg-wechat-green/90 transition-colors">
                    <i class="fa fa-send mr-2"></i>å‘å¸ƒåˆ°æœ‹å‹åœˆ
                </button>
            </div>
        </div>
    </div>

    <!-- ========== æ—¥è®°åˆ—è¡¨é¡µ ========== -->
    <div id="diaryListPage" class="fixed inset-0 bg-white z-20 transform translate-x-full transition-transform duration-300 ease-in-out h-full flex flex-col">
        <header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10">
            <h1 class="text-lg font-semibold">æ—¥è®°æœ¬</h1>
            <button id="closeDiaryListPageBtn" class="text-wechat-text p-2 rounded-full hover:bg-wechat-gray transition-colors"><i class="fa fa-times"></i></button>
        </header>
        <div id="diaryListContainer" class="flex-1 diary-list-container bg-white"></div>
    </div>

    <!-- ========== æ—¥è®°è¯¦æƒ…é¡µ ========== -->
    <div id="diaryDetailPage" class="fixed inset-0 bg-white z-30 transform translate-x-full transition-transform duration-300 ease-in-out h-full flex flex-col">
        <header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10">
            <div class="flex items-center">
                <button id="backToDiaryListBtn" class="text-wechat-text p-2 mr-2"><i class="fa fa-arrow-left"></i></button>
                <h1 id="diaryDetailPageTitle" class="text-lg font-semibold"></h1>
            </div>
            <div class="flex items-center gap-2">
                <button id="resetDiaryPtrBtn" title="é‡ç½®æŒ‡é’ˆ" class="bg-wechat-red/10 text-wechat-red text-xs font-semibold py-1 px-3 rounded-full hover:bg-wechat-red/20 transition-colors"><i class="fa fa-history mr-1"></i>é‡ç½®æŒ‡é’ˆ</button>
                <button id="manualDiaryBtn" class="bg-wechat-green/10 text-wechat-green text-xs font-semibold py-1 px-3 rounded-full hover:bg-wechat-green/20 transition-colors"><i class="fa fa-pencil-square-o mr-1"></i>æ‰‹åŠ¨æ€»ç»“</button>
            </div>
        </header>
        <div id="diaryEntriesContainer" class="flex-1 diary-entries-container p-4 bg-diary-bg/50"></div>
    </div>

    <!-- ========== ç¼–è¾‘æ—¥è®°æ¨¡æ€æ¡† ========== -->
    <div id="editDiaryEntryModal" class="fixed inset-0 bg-black/50 z-40 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg w-[90%] max-w-lg">
            <div class="p-4 border-b border-wechat-darkGray flex items-center justify-between">
                <h2 class="text-lg font-semibold">ç¼–è¾‘æ—¥è®°</h2>
                <button id="closeEditDiaryModalBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button>
            </div>
            <div class="p-4"><textarea id="editDiaryEntryText" class="w-full border border-wechat-darkGray rounded-lg p-3 text-sm focus:input-focus" rows="10"></textarea></div>
            <div class="p-4 border-t border-wechat-darkGray flex justify-end gap-3">
                <button id="cancelEditDiaryBtn" class="bg-wechat-gray text-wechat-text py-2 px-4 rounded-lg text-sm">å–æ¶ˆ</button>
                <button id="saveEditDiaryBtn" class="bg-wechat-green text-white py-2 px-4 rounded-lg text-sm">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ========== æ·»åŠ è¡¨æƒ…æ¨¡æ€æ¡† ========== -->
    <div id="addStickerModal" class="fixed inset-0 bg-black/50 z-40 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg w-[90%] max-w-md">
            <div class="p-4 border-b border-wechat-darkGray flex items-center justify-between">
                <h2 class="text-lg font-semibold" id="addStickerModalTitle">æ·»åŠ è¡¨æƒ…å›¾</h2>
                <button id="closeAddStickerModalBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button>
            </div>
            <div class="p-4">
                <div id="stickerUploadSection" class="sticker-add-section">
                    <div class="sticker-upload-preview-box" id="stickerUploadPreviewBox">
                        <span id="stickerUploadPlaceholder" style="color:#999;font-size:24px;">â•</span>
                        <img src="" alt="" id="stickerUploadPreviewImg" style="display:none;">
                    </div>
                    <input type="file" id="stickerFileInput" accept="image/*" style="display:none;">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-wechat-text mb-1">è¡¨æƒ…åç§° *</label>
                            <input type="text" id="uploadStickerName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ä¾‹å¦‚ï¼šå¼€å¿ƒ">
                            <p class="text-xs text-wechat-lightText mt-1">ä½¿ç”¨ :åç§°: å³å¯å‘é€æ­¤è¡¨æƒ…</p>
                        </div>
                    </div>
                </div>
                <div id="stickerUrlSection" class="sticker-add-section" style="display:none;">
                    <div class="sticker-upload-preview-box" id="stickerUrlPreviewBox">
                        <span id="stickerUrlPlaceholder" style="color:#999;font-size:24px;">ğŸ”—</span>
                        <img src="" alt="" id="stickerUrlPreviewImg" style="display:none;">
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-wechat-text mb-1">å›¾ç‰‡URL *</label>
                            <input type="url" id="stickerUrlInput" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="https://example.com/sticker.gif">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-wechat-text mb-1">è¡¨æƒ…åç§° *</label>
                            <input type="text" id="urlStickerName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ä¾‹å¦‚ï¼šå¼€å¿ƒ">
                        </div>
                    </div>
                </div>
                <div id="stickerImportSection" class="sticker-add-section" style="display:none;">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-wechat-text mb-1">æ‰¹é‡å¯¼å…¥</label>
                            <textarea id="stickerImportText" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" rows="6" placeholder="æ¯è¡Œä¸€ä¸ªè¡¨æƒ…ï¼Œæ ¼å¼ï¼šåç§°:URL"></textarea>
                        </div>
                        <div class="import-format-hint">
                            <div class="import-format-hint-title">ğŸ“‹ å¯¼å…¥æ ¼å¼ç¤ºä¾‹</div>
                            <div class="import-format-hint-code">æ€¨å¿µ:https://files.catbox.moe/q72pav.gif
å¼€å¿ƒ:https://example.com/happy.gif</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-wechat-darkGray flex justify-end gap-3">
                <button id="cancelAddStickerBtn" class="bg-wechat-gray text-wechat-text py-2 px-4 rounded-lg text-sm">å–æ¶ˆ</button>
                <button id="confirmAddStickerBtn" class="bg-wechat-green text-white py-2 px-4 rounded-lg text-sm">æ·»åŠ è¡¨æƒ…</button>
            </div>
        </div>
    </div>

    <!-- ========== è¡¨æƒ…å…¨å±é¢„è§ˆ ========== -->
    <div id="stickerFullViewModal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center cursor-zoom-out">
        <img src="" alt="" id="stickerFullViewImg" style="max-width:90%;max-height:90%;object-fit:contain;border-radius:8px;">
    </div>
     <!-- ========== æ–°å¢èŠå¤©å¯¹è±¡æ¨¡æ€æ¡† ========== -->
    <div id="addChatModal" class="fixed inset-0 bg-black/50 z-30 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg w-[90%] max-w-md max-h-[85vh] overflow-y-auto safe-area-bottom">
            <div class="p-4 border-b border-wechat-darkGray flex items-center justify-between sticky top-0 bg-white z-10">
                <h2 class="text-lg font-semibold">æ–°å¢èŠå¤©å¯¹è±¡</h2>
                <button id="closeAddChatModalBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button>
            </div>
            <div class="p-4 space-y-6 pb-10">
                <div class="space-y-3">
                    <label class="block text-sm font-medium text-wechat-text">èŠå¤©å¯¹è±¡å¤´åƒ</label>
                    <div class="flex flex-col items-center">
                        <div class="relative mb-3">
                            <img id="newChatAvatarPreview" class="avatar-preview" alt="å¤´åƒé¢„è§ˆ">
                            <i id="newChatAvatarIcon" class="fa fa-robot absolute inset-0 flex items-center justify-center text-white text-xl bg-wechat-green rounded-full"></i>
                        </div>
                        <div class="flex gap-3 w-full max-w-xs">
                            <label class="flex-1 text-center">
                                <input type="file" id="newChatAvatarUpload" accept="image/*" class="hidden">
                                <button type="button" class="avatar-upload-btn" onclick="document.getElementById('newChatAvatarUpload').click()"><i class="fa fa-upload mr-1"></i> æœ¬åœ°ä¸Šä¼ </button>
                            </label>
                            <button type="button" class="flex-1 avatar-upload-btn" id="newChatAvatarUrlBtn"><i class="fa fa-link mr-1"></i> è¾“å…¥URL</button>
                        </div>
                        <div id="newChatAvatarUrlContainer" class="w-full max-w-xs mt-3 hidden">
                            <input type="url" id="newChatAvatarUrl" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="è¾“å…¥å¤´åƒå›¾ç‰‡URL">
                            <div class="flex gap-2 mt-2">
                                <button type="button" class="flex-1 bg-wechat-green text-white py-2 rounded-lg text-sm" id="newChatAvatarUrlConfirm">ç¡®è®¤</button>
                                <button type="button" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm" id="newChatAvatarUrlCancel">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">èŠå¤©å¯¹è±¡åç§°</label><input type="text" id="newChatName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ä¾‹å¦‚ï¼šç¼–ç¨‹é«˜æ‰‹" value="AIåŠ©æ‰‹"></div>
                <div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">äººè®¾æç¤ºè¯</label><textarea id="newChatSystemPrompt" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm resize-none focus:input-focus h-32" placeholder="æè¿°AIçš„è§’è‰²ã€æ€§æ ¼ã€è¯´è¯é£æ ¼..."></textarea></div>
                <button type="button" id="createChatBtn" class="w-full bg-wechat-green text-white py-3 rounded-lg font-medium hover:bg-wechat-green/90 transition-colors">åˆ›å»ºèŠå¤©</button>
            </div>
        </div>
    </div>

    <!-- ========== èŠå¤©å¯¹è±¡è¯¦æƒ…é¡µ ========== -->
    <div id="chatDetailPage" class="fixed inset-0 bg-white z-30 flex flex-col h-full transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto safe-area-bottom">
        <header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10">
            <button id="backToChatPageBtn" class="text-wechat-text p-2 mr-2"><i class="fa fa-arrow-left"></i></button>
            <h2 class="text-lg font-semibold">èŠå¤©å¯¹è±¡è¯¦æƒ…</h2>
            <button id="deleteChatBtn" class="text-wechat-red p-2 mr-2" title="ä»åˆ—è¡¨ç§»é™¤"><i class="fa fa-trash"></i></button>
        </header>
        <div class="flex-1 overflow-y-auto pb-20">
            <div class="chat-detail-header">
                <div class="relative mb-3">
                    <img id="editChatAvatarPreview" class="avatar-preview" alt="å¤´åƒé¢„è§ˆ">
                    <i id="editChatAvatarIcon" class="fa fa-robot absolute inset-0 flex items-center justify-center text-white text-xl bg-wechat-green rounded-full"></i>
                </div>
                <button type="button" id="editAvatarBtn" class="text-wechat-green text-sm"><i class="fa fa-camera mr-1"></i> æ›´æ¢å¤´åƒ</button>
            </div>
            <div class="p-4 space-y-6">
                <div id="editAvatarContainer" class="space-y-3 hidden">
                    <div class="flex gap-3 w-full max-w-xs mx-auto">
                        <label class="flex-1 text-center">
                            <input type="file" id="editChatAvatarUpload" accept="image/*" class="hidden">
                            <button type="button" class="avatar-upload-btn" onclick="document.getElementById('editChatAvatarUpload').click()"><i class="fa fa-upload mr-1"></i> æœ¬åœ°ä¸Šä¼ </button>
                        </label>
                        <button type="button" class="flex-1 avatar-upload-btn" id="editChatAvatarUrlBtn"><i class="fa fa-link mr-1"></i> è¾“å…¥URL</button>
                    </div>
                    <div id="editChatAvatarUrlContainer" class="w-full max-w-xs mx-auto hidden">
                        <input type="url" id="editChatAvatarUrl" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="è¾“å…¥å¤´åƒå›¾ç‰‡URL">
                        <div class="flex gap-2 mt-2">
                            <button type="button" class="flex-1 bg-wechat-green text-white py-2 rounded-lg text-sm" id="editChatAvatarUrlConfirm">ç¡®è®¤</button>
                            <button type="button" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm" id="editChatAvatarUrlCancel">å–æ¶ˆ</button>
                        </div>
                    </div>
                    <button type="button" class="w-full max-w-xs mx-auto bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm" id="cancelEditAvatarBtn">å–æ¶ˆæ›´æ¢</button>
                </div>
                <div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">èŠå¤©å¯¹è±¡åç§°</label><input type="text" id="editChatName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="è¾“å…¥èŠå¤©å¯¹è±¡çš„åç§°"></div>
                <div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">äººè®¾æç¤ºè¯</label><textarea id="editChatSystemPrompt" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm resize-none focus:input-focus h-32" placeholder="æè¿°AIçš„è§’è‰²ã€æ€§æ ¼ã€è¯´è¯é£æ ¼..."></textarea></div>
                <button type="button" id="saveChatDetailBtn" class="w-full bg-wechat-green text-white py-3 rounded-lg font-medium hover:bg-wechat-green/90 transition-colors">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <!-- ========== ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† ========== -->
    <div id="confirmDeleteModal" class="fixed inset-0 bg-black/50 z-40 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg w-[80%] max-w-sm p-4">
            <h3 class="text-lg font-semibold text-center mb-4">ä»åˆ—è¡¨ç§»é™¤</h3>
            <p class="text-center text-wechat-text mb-6">ç¡®å®šè¦ä»åˆ—è¡¨ä¸­ç§»é™¤æ­¤èŠå¤©å—ï¼Ÿ</p>
            <div class="flex gap-3">
                <button type="button" id="cancelDeleteBtn" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm">å–æ¶ˆ</button>
                <button type="button" id="confirmDeleteBtn" class="flex-1 bg-wechat-red text-white py-2 rounded-lg text-sm">ç¡®è®¤ç§»é™¤</button>
            </div>
        </div>
    </div>

    <!-- ========== æ¶ˆæ¯å³é”®èœå• ========== -->
    <div id="messageContextMenu" class="message-context-menu hidden">
        <button id="editMessageBtn" class="w-full text-left px-2 py-1 hover:bg-wechat-gray rounded"><i class="fa fa-pencil mr-2"></i>ä¿®æ”¹</button>
        <button id="resendMessageBtn" class="w-full text-left px-2 py-1 hover:bg-wechat-gray rounded"><i class="fa fa-send mr-2"></i>é‡æ–°å‘é€</button>
        <button id="regenerateMessageBtn" class="w-full text-left px-2 py-1 hover:bg-wechat-gray rounded"><i class="fa fa-refresh mr-2"></i>é‡æ–°ç”Ÿæˆ</button>
        <button id="deleteMessageBtn" class="w-full text-left px-2 py-1 hover:bg-wechat-gray rounded text-wechat-red"><i class="fa fa-trash mr-2"></i>åˆ é™¤</button>
    </div>

    <!-- ========== æ¢å¤é€‰æ‹©æ¨¡æ€æ¡† ========== -->
    <div id="restoreModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg w-[90%] max-w-md max-h-[85vh] flex flex-col">
            <div class="p-4 border-b border-wechat-darkGray flex items-center justify-between sticky top-0 bg-white z-10">
                <h2 class="text-lg font-semibold">ä»å¤‡ä»½æ¢å¤</h2>
                <button id="closeRestoreModalBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto space-y-4">
                <p class="text-sm text-wechat-lightText">é€‰æ‹©è¦æ¢å¤çš„èŠå¤©å¯¹è±¡ï¼š</p>
                <div class="space-y-2 max-h-64 overflow-y-auto border-y border-wechat-darkGray py-2" id="restoreChatList"></div>
                <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="restoreSelectAll" class="rounded border-gray-300 text-wechat-green focus:ring-wechat-green"><span class="text-sm">å…¨é€‰/å…¨ä¸é€‰</span></label>
            </div>
            <div class="p-4 border-t border-wechat-darkGray flex gap-3">
                <button type="button" id="cancelRestoreBtn" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm">å–æ¶ˆ</button>
                <button type="button" id="confirmRestoreBtn" class="flex-1 bg-wechat-green text-white py-2 rounded-lg text-sm">ç¡®è®¤æ¢å¤</button>
            </div>
        </div>
    </div>

    <!-- ========== æ—¥å¿—æ¨¡æ€æ¡† ========== -->
    <div id="logModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-white rounded-lg w-full h-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-wechat-darkGray flex items-center justify-between">
                <h2 class="text-lg font-semibold">è¯Šæ–­æ—¥å¿—</h2>
                <button id="closeLogModalBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto"><textarea id="logOutput" readonly class="w-full h-full text-xs font-mono bg-wechat-gray p-2 rounded-md border border-wechat-darkGray resize-none"></textarea></div>
            <div class="p-4 border-t border-wechat-darkGray text-center text-xs text-wechat-lightText">è¯·å¤åˆ¶ä»¥ä¸Šæ‰€æœ‰å†…å®¹å‘é€ç»™å¼€å‘è€…</div>
        </div>
    </div>

    <!-- â˜… æ–°å¢ï¼šNPCå¥½å‹ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="npcFriendsModal" class="fixed inset-0 bg-black/50 z-40 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg w-[90%] max-w-md max-h-[85vh] overflow-y-auto">
            <div class="p-4 border-b border-wechat-darkGray flex items-center justify-between sticky top-0 bg-white z-10">
                <h2 class="text-lg font-semibold">å¥½å‹ç®¡ç†</h2>
                <button onclick="closeNpcFriendsModal()" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button>
            </div>
            <div class="p-4 space-y-4">
                <!-- å¥½å‹åˆ—è¡¨ -->
                <div id="npcFriendsListContainer" class="space-y-2 max-h-40 overflow-y-auto"></div>
<!-- æ·»åŠ å¥½å‹è¡¨å• -->
<div class="border-t border-wechat-darkGray pt-4 space-y-3">
    <h4 class="text-sm font-semibold text-wechat-lightText" id="npcFriendFormTitle">æ‰‹åŠ¨æ·»åŠ å¥½å‹</h4>
    <input type="text" id="npcFriendName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="å¥½å‹åç§°">
    <input type="text" id="npcFriendRelation" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="ä¸è§’è‰²çš„å…³ç³»ï¼ˆå¦‚ï¼šé—ºèœœã€åŒäº‹ï¼‰">
    <input type="text" id="npcFriendPersonality" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="æ€§æ ¼ç‰¹ç‚¹ï¼ˆå¦‚ï¼šæ´»æ³¼å¼€æœ—ï¼‰">
    <select id="npcFriendBindChat" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus">
        <option value="">ä¸ç»‘å®šï¼ˆæ‰€æœ‰äººå…±äº«ï¼‰</option>
    </select>
    <div class="flex gap-2">
        <button onclick="addNpcFriend()" id="npcFriendAddBtn" class="flex-1 bg-wechat-green text-white py-2 rounded-lg text-sm hover:bg-wechat-green/90"><i class="fa fa-plus mr-1"></i> <span>æ·»åŠ </span></button>
        <button onclick="cancelEditNpcFriend()" id="npcFriendCancelEditBtn" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm" style="display:none;"><i class="fa fa-times mr-1"></i> å–æ¶ˆç¼–è¾‘</button>
        <button onclick="openAiSuggestModal()" id="npcFriendAiBtn" class="flex-1 bg-wechat-green/10 text-wechat-green py-2 rounded-lg text-sm hover:bg-wechat-green/20"><i class="fa fa-magic mr-1"></i> AIæ¨è</button>
    </div>
</div>
            </div>
        </div>
    </div>

    <!-- â˜… æ–°å¢ï¼šAIæ¨èå¥½å‹æ¨¡æ€æ¡† -->
    <div id="aiSuggestFriendsModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg w-[90%] max-w-md max-h-[85vh] overflow-y-auto">
            <div class="p-4 border-b border-wechat-darkGray flex items-center justify-between sticky top-0 bg-white z-10">
                <h2 class="text-lg font-semibold">AIæ¨èå¥½å‹</h2>
                <button onclick="closeAiSuggestModal()" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button>
            </div>
            <div class="p-4 space-y-4">
                <p class="text-xs text-wechat-lightText">é€‰æ‹©ä¸€ä¸ªè§’è‰²ï¼ŒAIä¼šåˆ†æå…¶äººè®¾å¹¶æ¨èåˆç†çš„å¥½å‹è§’è‰²</p>
                <select id="aiSuggestTargetChat" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus">
                    <option value="">é€‰æ‹©è§’è‰²</option>
                </select>
                <button id="startAiSuggestBtn" onclick="startAiSuggest()" class="w-full bg-wechat-green text-white py-2 rounded-lg text-sm hover:bg-wechat-green/90">
                    <i class="fa fa-search mr-1"></i> å¼€å§‹æ¨è
                </button>
                <div id="aiSuggestResults" class="space-y-2 max-h-60 overflow-y-auto"></div>
            </div>
        </div>
    </div>

</div>

<!-- JS æ–‡ä»¶å¼•å…¥ -->
<script src="js/utils.js"></script>
<script src="js/storage.js"></script>
<script src="js/stickers.js"></script>
<script src="js/chat.js"></script>
<script src="js/diary.js"></script>
<script src="js/moments.js"></script>
<script src="js/app.js"></script>
</body>
</html>   