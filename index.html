<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>微信风格多AI聊天 (v4.0)</title>
    <!-- Head and Style sections remain the same -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"></noscript>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              wechat: { green: '#07C160', lightGreen: '#E6F4EA', gray: '#F5F5F5', darkGray: '#E5E5E5', text: '#333333', lightText: '#888888', red: '#F43530' },
              chat: { user: '#DDF4E8', ai: '#FFFFFF' },
              diary: { bg: '#FDFCF7', border: '#F0EAD6', text: '#6B4F4F' }
            },
            fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'] },
          },
        }
      }
    </script>
    <style type="text/tailwindcss">
      @layer utilities {
        .chat-bubble-user { @apply bg-chat-user rounded-2xl rounded-tr-none px-4 py-2 max-w-[80%] shadow-sm; }
        .chat-bubble-ai { @apply bg-chat-ai rounded-2xl rounded-tl-none px-4 py-2 max-w-[80%] shadow-sm border border-wechat-darkGray; }
        .nav-item-active { @apply text-wechat-green; }
        .input-focus { @apply ring-2 ring-wechat-green/30 outline-none; }
        .avatar-preview { @apply w-16 h-16 rounded-full object-cover border-2 border-wechat-green/50 cursor-pointer transition-all hover:border-wechat-green; }
        .avatar-upload-btn { @apply w-full bg-wechat-gray hover:bg-wechat-darkGray text-wechat-text py-2 rounded-lg text-sm transition-colors; }
        .typing-indicator { @apply text-center text-wechat-lightText text-sm py-2 px-4 opacity-0 pointer-events-none transition-opacity duration-300; }
        .typing-indicator.show { @apply opacity-100 pointer-events-auto; }
        .slide-delete-btn { @apply w-20 h-full bg-wechat-red text-white flex items-center justify-center transition-transform duration-300 transform translate-x-full; }
        .chat-item-wrapper { @apply flex items-center justify-between bg-white transition-transform duration-300; }
        .chat-item-wrapper.swipe-left { @apply transform -translate-x-20; }
        .chat-detail-header { @apply bg-[#ECE5DD] py-6 flex flex-col items-center; }
        .chat-item-actions { @apply absolute right-4 top-1/2 transform -translate-y-1/2 flex gap-2 opacity-0 transition-opacity duration-300; }
        .chat-item-container:hover .chat-item-actions { @apply opacity-100; }
        .delete-action-btn { @apply bg-wechat-red/10 text-wechat-red p-1.5 rounded-full hover:bg-wechat-red/20 transition-colors; }
        .edit-action-btn { @apply bg-wechat-green/10 text-wechat-green p-1.5 rounded-full hover:bg-wechat-green/20 transition-colors; }
        .user-avatar-small { @apply w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-white flex-shrink-0; }
        .message-context-menu { @apply absolute bg-white shadow-lg rounded-md p-2 z-50 text-sm; }
        .diary-entry-card { @apply bg-diary-bg border border-diary-border rounded-lg p-4 mb-4 shadow-sm break-words; }
      }
    </style>
    <style>
      html, body { height: 100%; overflow: hidden; -webkit-overflow-scrolling: touch; }
      @supports (padding-bottom: constant(safe-area-inset-bottom)) or (padding-bottom: env(safe-area-inset-bottom)) {
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .nav-safe-area { padding-bottom: calc(0.5rem + env(safe-area-inset-bottom)); }
      }
      .chat-input-container { position: fixed; bottom: 0; left: 0; right: 0; z-index: 10; }
      .chat-content, .chat-list-container, .diary-list-container, .diary-entries-container { overflow-y: auto; -webkit-overflow-scrolling: touch; }
      .chat-page { display: flex; flex-direction: column; height: 100vh; }
      .chat-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
      input[type="checkbox"] { flex-shrink: 0; }
      button:disabled { opacity: 0.7; cursor: not-allowed; }
    </style>
</head>
<body class="bg-wechat-gray font-sans text-wechat-text">
<div class="h-screen overflow-hidden">
    <!-- HTML structure remains identical -->
    <div id="chatListPage" class="h-full flex flex-col"><header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10"><h1 class="text-lg font-semibold">AI聊天助手</h1><button id="addChatBtn" class="text-wechat-text p-2 rounded-full hover:bg-wechat-gray transition-colors"><i class="fa fa-plus"></i></button></header><div id="chatListContainer" class="flex-1 chat-list-container bg-white"><div id="emptyChatList" class="flex flex-col items-center justify-center h-full text-wechat-lightText py-10"><i class="fa fa-comments-o text-4xl mb-3 opacity-50"></i><p class="text-sm">暂无聊天对象，点击右上角"+"添加</p></div></div><nav class="bg-white border-t border-wechat-darkGray flex nav-safe-area"><button id="chatNavBtn" class="flex-1 py-3 flex flex-col items-center justify-center nav-item-active"><i class="fa fa-comments text-lg"></i><span class="text-xs mt-1">聊天</span></button><button id="diaryNavBtn" class="flex-1 py-3 flex flex-col items-center justify-center text-wechat-lightText"><i class="fa fa-book text-lg"></i><span class="text-xs mt-1">日记</span></button><button id="settingsNavBtn" class="flex-1 py-3 flex flex-col items-center justify-center text-wechat-lightText"><i class="fa fa-cog text-lg"></i><span class="text-xs mt-1">设置</span></button></nav></div>
    <div id="chatPage" class="chat-page hidden"><header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10"><div class="flex items-center"><button id="backToChatListBtn" class="text-wechat-text p-2 mr-2"><i class="fa fa-arrow-left"></i></button><div class="flex items-center"><div id="chatPageAvatar" class="w-8 h-8 rounded-full overflow-hidden mr-2"></div><h1 id="chatPageTitle" class="text-lg font-semibold">聊天对象</h1></div></div><button id="chatPageMoreBtn" class="text-wechat-text p-2 rounded-full hover:bg-wechat-gray transition-colors"><i class="fa fa-ellipsis-v"></i></button></header><main class="chat-main"><div id="chatPageTypingIndicator" class="typing-indicator"><span id="chatPageTypingText">正在输入中...</span></div><div id="chatPageContainer" class="chat-content p-4 bg-[#ECE5DD]"></div><div class="chat-input-container bg-white border-t border-wechat-darkGray p-3 safe-area-bottom"><div class="flex items-center gap-2"><textarea id="chatPageMessageInput" class="flex-1 border border-wechat-darkGray rounded-full px-4 py-2 text-sm resize-none focus:input-focus transition-all" placeholder="输入消息..." rows="1"></textarea><button id="chatPageSendBtn" class="w-10 h-10 rounded-full bg-wechat-green flex items-center justify-center text-white"><i class="fa fa-paper-plane"></i></button></div></div></main></div>
    <div id="settingsPage" class="fixed inset-0 bg-white z-20 transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto safe-area-bottom"><div class="p-4 border-b border-wechat-darkGray flex items-center justify-between sticky top-0 bg-white z-10"><h2 class="text-lg font-semibold">设置</h2><button id="closeSettingsBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button></div><div class="p-4 space-y-8 pb-20"><div class="space-y-6"><h3 class="text-base font-semibold text-wechat-text border-b border-wechat-darkGray pb-2">用户信息设置</h3><div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">你的头像</label><div class="flex flex-col items-center"><div class="relative mb-3"><img id="userAvatarPreview" class="avatar-preview" alt="你的头像预览"><i id="userAvatarIcon" class="fa fa-user absolute inset-0 flex items-center justify-center text-white text-xl bg-gray-400 rounded-full"></i></div><div class="flex gap-3 w-full max-w-xs"><label class="flex-1 text-center"><input type="file" id="userAvatarUpload" accept="image/*" class="hidden"><button type="button" class="avatar-upload-btn" onclick="document.getElementById('userAvatarUpload').click()"><i class="fa fa-upload mr-1"></i> 本地上传</button></label><button type="button" class="flex-1 avatar-upload-btn" id="userAvatarUrlBtn"><i class="fa fa-link mr-1"></i> 输入URL</button></div><div id="userAvatarUrlContainer" class="w-full max-w-xs mt-3 hidden"><input type="url" id="userAvatarUrl" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="输入头像图片URL"><div class="flex gap-2 mt-2"><button type="button" class="flex-1 bg-wechat-green text-white py-2 rounded-lg text-sm" id="userAvatarUrlConfirm">确认</button><button type="button" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm" id="userAvatarUrlCancel">取消</button></div></div></div></div><div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">你的名称<span class="text-xs text-wechat-lightText ml-1">(发送给API使用)</span></label><input type="text" id="userName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="输入你的名称" value="user"></div></div><div class="space-y-6"><h3 class="text-base font-semibold text-wechat-text border-b border-wechat-darkGray pb-2">API与模型配置</h3><form id="settingsForm" class="space-y-4"><div><label class="block text-sm font-medium text-wechat-text mb-1">API Base URL</label><input type="url" id="baseUrl" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="https://api.openai.com/v1" value="https://api.openai.com/v1"></div><div><label class="block text-sm font-medium text-wechat-text mb-1">API Key</label><input type="password" id="apiKey" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="sk-..."></div><div><label class="block text-sm font-medium text-wechat-text mb-1">模型名称</label><input type="text" id="modelName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="gpt-3.5-turbo" value="gpt-3.5-turbo"></div><div><label for="apiTemperature" class="block text-sm font-medium text-wechat-text mb-1">模型温度 (Temperature)</label><input type="number" id="apiTemperature" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="例如: 0.7" value="0.7" min="0" max="2" step="0.1"><p class="text-xs text-wechat-lightText mt-1">控制回答的随机性。值越高(如 1.2)回答越有创意，值越低(如 0.2)回答越稳定。默认 0.7。</p></div><div><label class="block text-sm font-medium text-wechat-text mb-1">单次上下文轮次 (短期记忆)</label><input type="number" id="historyTurns" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="例如: 10" value="10" min="0"><p class="text-xs text-wechat-lightText mt-1">每次请求API时，读取最近的N轮对话。0或空表示不限制。</p></div><div><label class="block text-sm font-medium text-wechat-text mb-1">日记生成频率 (轮)</label><input type="number" id="diaryGenerationTurns" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="例如: 30" value="30" min="0"><p class="text-xs text-wechat-lightText mt-1">每隔N轮对话 (N次AI回复)，自动生成一篇日记。0表示禁用。</p></div><div><label for="globalSystemPrompt" class="block text-sm font-medium text-wechat-text mb-1">全局系统提示词</label><textarea id="globalSystemPrompt" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm resize-none focus:input-focus h-48" placeholder="定义全局规则，对所有聊天对象生效..."></textarea><p class="text-xs text-wechat-lightText mt-1">此提示词拥有最高优先级，将与每个聊天对象的人设提示词合并后发送给AI。</p></div><button type="submit" class="w-full bg-wechat-green text-white py-3 rounded-lg font-medium hover:bg-wechat-green/90 transition-colors">保存所有设置</button></form></div><div class="space-y-6"><h3 class="text-base font-semibold text-wechat-text border-b border-wechat-darkGray pb-2">数据备份与恢复</h3><p class="text-sm text-wechat-lightText">您可以将全部聊天数据（包含聊天记录、对象设定、日记、全局配置和头像）备份到一个压缩文件(`.zip`)中。</p><div class="flex gap-3"><button type="button" id="backupDataBtn" class="flex-1 bg-wechat-green/10 text-wechat-green py-3 rounded-lg font-medium hover:bg-wechat-green/20 transition-colors"><i class="fa fa-download mr-2"></i><span>备份全部数据</span></button><button type="button" id="restoreDataBtn" class="flex-1 bg-wechat-green/10 text-wechat-green py-3 rounded-lg font-medium hover:bg-wechat-green/20 transition-colors"><i class="fa fa-upload mr-2"></i><span>从文件恢复</span></button><input type="file" id="restoreFileInput" class="hidden" accept=".zip"></div><div class="text-xs text-wechat-lightText space-y-1"><p class="flex items-start"><i class="fa fa-info-circle mr-2 mt-0.5 flex-shrink-0"></i><span class="font-semibold">关于备份路径：</span>点击备份后，浏览器将自动下载文件。该文件通常会保存到您浏览器设置的**默认“下载”文件夹**中。</p><p class="flex items-start"><i class="fa fa-lightbulb-o mr-2 mt-0.5 flex-shrink-0"></i><span class="font-semibold">恢复操作提示：</span>点击恢复后，请在弹出的文件选择窗口中，**手动导航到您的“下载”文件夹**来找到之前的备份文件。</p></div></div><div class="space-y-6"><h3 class="text-base font-semibold text-wechat-text border-b border-wechat-darkGray pb-2">诊断与调试</h3><p class="text-sm text-wechat-lightText">如果遇到功能异常，可以查看内部日志以帮助定位问题。</p><div class="flex gap-3"><button type="button" id="viewLogsBtn" class="flex-1 bg-wechat-green/10 text-wechat-green py-3 rounded-lg font-medium hover:bg-wechat-green/20 transition-colors"><i class="fa fa-file-text-o mr-2"></i>查看诊断日志</button><button type="button" id="clearLogsBtn" class="flex-1 bg-wechat-red/10 text-wechat-red py-3 rounded-lg font-medium hover:bg-wechat-red/20 transition-colors"><i class="fa fa-eraser mr-2"></i>清空日志</button></div></div></div></div>
    <div id="diaryListPage" class="fixed inset-0 bg-white z-20 transform translate-x-full transition-transform duration-300 ease-in-out h-full flex flex-col"><header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10"><h1 class="text-lg font-semibold">日记本</h1><button id="closeDiaryListPageBtn" class="text-wechat-text p-2 rounded-full hover:bg-wechat-gray transition-colors"><i class="fa fa-times"></i></button></header><div id="diaryListContainer" class="flex-1 diary-list-container bg-white"></div></div>
    <div id="diaryDetailPage" class="fixed inset-0 bg-white z-30 transform translate-x-full transition-transform duration-300 ease-in-out h-full flex flex-col"><header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10"><div class="flex items-center"><button id="backToDiaryListBtn" class="text-wechat-text p-2 mr-2"><i class="fa fa-arrow-left"></i></button><h1 id="diaryDetailPageTitle" class="text-lg font-semibold"></h1></div><div class="flex items-center gap-2"><button id="resetDiaryPtrBtn" title="如果总结功能失效，请先点击此按钮" class="bg-wechat-red/10 text-wechat-red text-xs font-semibold py-1 px-3 rounded-full hover:bg-wechat-red/20 transition-colors"><i class="fa fa-history mr-1"></i>重置指针</button><button id="manualDiaryBtn" class="bg-wechat-green/10 text-wechat-green text-xs font-semibold py-1 px-3 rounded-full hover:bg-wechat-green/20 transition-colors"><i class="fa fa-pencil-square-o mr-1"></i>手动总结</button></div></header><div id="diaryEntriesContainer" class="flex-1 diary-entries-container p-4 bg-diary-bg/50"></div></div>
    <div id="editDiaryEntryModal" class="fixed inset-0 bg-black/50 z-40 flex items-center justify-center hidden"><div class="bg-white rounded-lg w-[90%] max-w-lg"><div class="p-4 border-b border-wechat-darkGray flex items-center justify-between"><h2 class="text-lg font-semibold">编辑日记</h2><button id="closeEditDiaryModalBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button></div><div class="p-4"><textarea id="editDiaryEntryText" class="w-full border border-wechat-darkGray rounded-lg p-3 text-sm focus:input-focus" rows="10"></textarea></div><div class="p-4 border-t border-wechat-darkGray flex justify-end gap-3"><button id="cancelEditDiaryBtn" class="bg-wechat-gray text-wechat-text py-2 px-4 rounded-lg text-sm">取消</button><button id="saveEditDiaryBtn" class="bg-wechat-green text-white py-2 px-4 rounded-lg text-sm">保存</button></div></div></div>
    <div id="addChatModal" class="fixed inset-0 bg-black/50 z-30 flex items-center justify-center hidden"><div class="bg-white rounded-lg w-[90%] max-w-md max-h-[85vh] overflow-y-auto safe-area-bottom"><div class="p-4 border-b border-wechat-darkGray flex items-center justify-between sticky top-0 bg-white z-10"><h2 class="text-lg font-semibold">新增聊天对象</h2><button id="closeAddChatModalBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button></div><div class="p-4 space-y-6 pb-10"><div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">聊天对象头像</label><div class="flex flex-col items-center"><div class="relative mb-3"><img id="newChatAvatarPreview" class="avatar-preview" alt="头像预览"><i id="newChatAvatarIcon" class="fa fa-robot absolute inset-0 flex items-center justify-center text-white text-xl bg-wechat-green rounded-full"></i></div><div class="flex gap-3 w-full max-w-xs"><label class="flex-1 text-center"><input type="file" id="newChatAvatarUpload" accept="image/*" class="hidden"><button type="button" class="avatar-upload-btn" onclick="document.getElementById('newChatAvatarUpload').click()"><i class="fa fa-upload mr-1"></i> 本地上传</button></label><button type="button" class="flex-1 avatar-upload-btn" id="newChatAvatarUrlBtn"><i class="fa fa-link mr-1"></i> 输入URL</button></div><div id="newChatAvatarUrlContainer" class="w-full max-w-xs mt-3 hidden"><input type="url" id="newChatAvatarUrl" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="输入头像图片URL"><div class="flex gap-2 mt-2"><button type="button" class="flex-1 bg-wechat-green text-white py-2 rounded-lg text-sm" id="newChatAvatarUrlConfirm">确认</button><button type="button" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm" id="newChatAvatarUrlCancel">取消</button></div></div></div></div><div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">聊天对象名称</label><input type="text" id="newChatName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="例如：编程高手" value="AI助手"></div><div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">人设提示词</label><textarea id="newChatSystemPrompt" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm resize-none focus:input-focus h-32" placeholder="描述AI的角色、性格、说话风格..."></textarea></div><button type="button" id="createChatBtn" class="w-full bg-wechat-green text-white py-3 rounded-lg font-medium hover:bg-wechat-green/90 transition-colors">创建聊天</button></div></div></div>
    <div id="chatDetailPage" class="fixed inset-0 bg-white z-30 flex flex-col h-full transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto safe-area-bottom"><header class="bg-white border-b border-wechat-darkGray py-3 px-4 flex items-center justify-between shadow-sm z-10"><button id="backToChatPageBtn" class="text-wechat-text p-2 mr-2"><i class="fa fa-arrow-left"></i></button><h2 class="text-lg font-semibold">聊天对象详情</h2><button id="deleteChatBtn" class="text-wechat-red p-2 mr-2" title="从列表移除"><i class="fa fa-trash"></i></button></header><div class="flex-1 overflow-y-auto pb-20"><div class="chat-detail-header"><div class="relative mb-3"><img id="editChatAvatarPreview" class="avatar-preview" alt="头像预览"><i id="editChatAvatarIcon" class="fa fa-robot absolute inset-0 flex items-center justify-center text-white text-xl bg-wechat-green rounded-full"></i></div><button type="button" id="editAvatarBtn" class="text-wechat-green text-sm"><i class="fa fa-camera mr-1"></i> 更换头像</button></div><div class="p-4 space-y-6"><div id="editAvatarContainer" class="space-y-3 hidden"><div class="flex gap-3 w-full max-w-xs mx-auto"><label class="flex-1 text-center"><input type="file" id="editChatAvatarUpload" accept="image/*" class="hidden"><button type="button" class="avatar-upload-btn" onclick="document.getElementById('editChatAvatarUpload').click()"><i class="fa fa-upload mr-1"></i> 本地上传</button></label><button type="button" class="flex-1 avatar-upload-btn" id="editChatAvatarUrlBtn"><i class="fa fa-link mr-1"></i> 输入URL</button></div><div id="editChatAvatarUrlContainer" class="w-full max-w-xs mx-auto hidden"><input type="url" id="editChatAvatarUrl" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="输入头像图片URL"><div class="flex gap-2 mt-2"><button type="button" class="flex-1 bg-wechat-green text-white py-2 rounded-lg text-sm" id="editChatAvatarUrlConfirm">确认</button><button type="button" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm" id="editChatAvatarUrlCancel">取消</button></div></div><button type="button" class="w-full max-w-xs mx-auto bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm" id="cancelEditAvatarBtn">取消更换</button></div><div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">聊天对象名称</label><input type="text" id="editChatName" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm focus:input-focus" placeholder="输入聊天对象的名称"></div><div class="space-y-3"><label class="block text-sm font-medium text-wechat-text">人设提示词</label><textarea id="editChatSystemPrompt" class="w-full border border-wechat-darkGray rounded-lg px-3 py-2 text-sm resize-none focus:input-focus h-32" placeholder="描述AI的角色、性格、说话风格..."></textarea></div><button type="button" id="saveChatDetailBtn" class="w-full bg-wechat-green text-white py-3 rounded-lg font-medium hover:bg-wechat-green/90 transition-colors">保存修改</button></div></div></div>
    <div id="confirmDeleteModal" class="fixed inset-0 bg-black/50 z-40 flex items-center justify-center hidden"><div class="bg-white rounded-lg w-[80%] max-w-sm p-4"><h3 class="text-lg font-semibold text-center mb-4">从列表移除</h3><p class="text-center text-wechat-text mb-6">确定要从列表中移除此聊天吗？您之后可以通过备份文件恢复。</p><div class="flex gap-3"><button type="button" id="cancelDeleteBtn" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm">取消</button><button type="button" id="confirmDeleteBtn" class="flex-1 bg-wechat-red text-white py-2 rounded-lg text-sm">确认移除</button></div></div></div>
    <div id="messageContextMenu" class="message-context-menu hidden"><button id="regenerateMessageBtn" class="w-full text-left px-2 py-1 hover:bg-wechat-gray rounded"><i class="fa fa-refresh mr-2"></i>重新生成</button></div>
    <div id="restoreModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden"><div class="bg-white rounded-lg w-[90%] max-w-md max-h-[85vh] flex flex-col"><div class="p-4 border-b border-wechat-darkGray flex items-center justify-between sticky top-0 bg-white z-10"><h2 class="text-lg font-semibold">从备份恢复</h2><button id="closeRestoreModalBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button></div><div class="p-4 flex-1 overflow-y-auto space-y-4"><p class="text-sm text-wechat-lightText">已在备份文件中检测到以下聊天，请选择您希望恢复的聊天对象。恢复将覆盖现有同名对象或添加新对象。</p><div class="space-y-2 max-h-64 overflow-y-auto border-y border-wechat-darkGray py-2" id="restoreChatList"></div><label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="restoreSelectAll" class="rounded border-gray-300 text-wechat-green focus:ring-wechat-green"><span class="text-sm">全选/全不选</span></label></div><div class="p-4 border-t border-wechat-darkGray flex gap-3"><button type="button" id="cancelRestoreBtn" class="flex-1 bg-wechat-gray text-wechat-text py-2 rounded-lg text-sm">取消</button><button type="button" id="confirmRestoreBtn" class="flex-1 bg-wechat-green text-white py-2 rounded-lg text-sm">确认恢复</button></div></div></div>
    <div id="logModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center hidden p-4"><div class="bg-white rounded-lg w-full h-full max-w-4xl max-h-[90vh] flex flex-col"><div class="p-4 border-b border-wechat-darkGray flex items-center justify-between"><h2 class="text-lg font-semibold">诊断日志</h2><button id="closeLogModalBtn" class="p-2 text-wechat-text"><i class="fa fa-times text-xl"></i></button></div><div class="p-4 flex-1 overflow-y-auto"><textarea id="logOutput" readonly class="w-full h-full text-xs font-mono bg-wechat-gray p-2 rounded-md border border-wechat-darkGray resize-none"></textarea></div><div class="p-4 border-t border-wechat-darkGray text-center text-xs text-wechat-lightText">请复制以上所有内容发送给我，以帮助诊断问题。</div></div></div>
</div>

<script>
// =========================================================================
//  VERSION 4.0 (with Robust Retry & Logging)
// =========================================================================

// 默认配置，作为新设置的基准和旧数据升级的模板
const aichat_default_config = {
    baseUrl: 'https://api.openai.com/v1',
    apiKey: '',
    modelName: 'gpt-3.5-turbo',
    temperature: 0.7,
    historyTurns: 10,
    diaryGenerationTurns: 30,
    globalSystemPrompt: `请严格遵守以下规则：\n1. 你的所有思考、self-critique、计划、plan等内心戏都必须包含在 <think> 和 </think> 标签之间，且<think>标签必须在你的回答的最前面。\n2. 你必须在think之后再给出对用户的直接回答。\n3. 给用户的直接回答中绝对不能出现<think>标签及其中内容。`
};

const appData = { chatObjects: [], activeChatId: null, apiConfig: { ...aichat_default_config }, userInfo: { name: 'user', avatar: { type: 'default', url: '' } }, newChatTempData: { avatar: { type: 'default', url: '' } }, editChatTempData: { chatId: null, avatar: { type: 'default', url: '' } }, userAvatarTempData: { type: 'default', url: '' }, contextMenuData: { messageIndex: null }, restoreTempData: { zip: null, parsedChats: [] }, diaryView: { activeChatId: null, editingEntryId: null }, isGeneratingDiary: false, logs: [], };
const DOM = { chatListPage: document.getElementById('chatListPage'), chatListContainer: document.getElementById('chatListContainer'), emptyChatList: document.getElementById('emptyChatList'), addChatBtn: document.getElementById('addChatBtn'), chatNavBtn: document.getElementById('chatNavBtn'), diaryNavBtn: document.getElementById('diaryNavBtn'), settingsNavBtn: document.getElementById('settingsNavBtn'), chatPage: document.getElementById('chatPage'), backToChatListBtn: document.getElementById('backToChatListBtn'), chatPageAvatar: document.getElementById('chatPageAvatar'), chatPageTitle: document.getElementById('chatPageTitle'), chatPageMoreBtn: document.getElementById('chatPageMoreBtn'), chatPageContainer: document.getElementById('chatPageContainer'), chatPageMessageInput: document.getElementById('chatPageMessageInput'), chatPageSendBtn: document.getElementById('chatPageSendBtn'), chatPageTypingIndicator: document.getElementById('chatPageTypingIndicator'), chatPageTypingText: document.getElementById('chatPageTypingText'), settingsPage: document.getElementById('settingsPage'), closeSettingsBtn: document.getElementById('closeSettingsBtn'), settingsForm: document.getElementById('settingsForm'), baseUrl: document.getElementById('baseUrl'), apiKey: document.getElementById('apiKey'), modelName: document.getElementById('modelName'), apiTemperature: document.getElementById('apiTemperature'), historyTurns: document.getElementById('historyTurns'), globalSystemPrompt: document.getElementById('globalSystemPrompt'), userName: document.getElementById('userName'), userAvatarPreview: document.getElementById('userAvatarPreview'), userAvatarIcon: document.getElementById('userAvatarIcon'), userAvatarUpload: document.getElementById('userAvatarUpload'), userAvatarUrlBtn: document.getElementById('userAvatarUrlBtn'), userAvatarUrlContainer: document.getElementById('userAvatarUrlContainer'), userAvatarUrl: document.getElementById('userAvatarUrl'), userAvatarUrlConfirm: document.getElementById('userAvatarUrlConfirm'), userAvatarUrlCancel: document.getElementById('userAvatarUrlCancel'), addChatModal: document.getElementById('addChatModal'), closeAddChatModalBtn: document.getElementById('closeAddChatModalBtn'), newChatAvatarPreview: document.getElementById('newChatAvatarPreview'), newChatAvatarIcon: document.getElementById('newChatAvatarIcon'), newChatAvatarUpload: document.getElementById('newChatAvatarUpload'), newChatAvatarUrlBtn: document.getElementById('newChatAvatarUrlBtn'), newChatAvatarUrlContainer: document.getElementById('newChatAvatarUrlContainer'), newChatAvatarUrl: document.getElementById('newChatAvatarUrl'), newChatAvatarUrlConfirm: document.getElementById('newChatAvatarUrlConfirm'), newChatAvatarUrlCancel: document.getElementById('newChatAvatarUrlCancel'), newChatName: document.getElementById('newChatName'), newChatSystemPrompt: document.getElementById('newChatSystemPrompt'), createChatBtn: document.getElementById('createChatBtn'), chatDetailPage: document.getElementById('chatDetailPage'), backToChatPageBtn: document.getElementById('backToChatPageBtn'), deleteChatBtn: document.getElementById('deleteChatBtn'), editChatAvatarPreview: document.getElementById('editChatAvatarPreview'), editChatAvatarIcon: document.getElementById('editChatAvatarIcon'), editAvatarBtn: document.getElementById('editAvatarBtn'), editAvatarContainer: document.getElementById('editAvatarContainer'), editChatAvatarUpload: document.getElementById('editChatAvatarUpload'), editChatAvatarUrlBtn: document.getElementById('editChatAvatarUrlBtn'), editChatAvatarUrlContainer: document.getElementById('editChatAvatarUrlContainer'), editChatAvatarUrl: document.getElementById('editChatAvatarUrl'), editChatAvatarUrlConfirm: document.getElementById('editChatAvatarUrlConfirm'), editChatAvatarUrlCancel: document.getElementById('cancelEditAvatarBtn'), editChatName: document.getElementById('editChatName'), editChatSystemPrompt: document.getElementById('editChatSystemPrompt'), saveChatDetailBtn: document.getElementById('saveChatDetailBtn'), confirmDeleteModal: document.getElementById('confirmDeleteModal'), cancelDeleteBtn: document.getElementById('cancelDeleteBtn'), confirmDeleteBtn: document.getElementById('confirmDeleteBtn'), messageContextMenu: document.getElementById('messageContextMenu'), regenerateMessageBtn: document.getElementById('regenerateMessageBtn'), backupDataBtn: document.getElementById('backupDataBtn'), restoreDataBtn: document.getElementById('restoreDataBtn'), restoreFileInput: document.getElementById('restoreFileInput'), restoreModal: document.getElementById('restoreModal'), closeRestoreModalBtn: document.getElementById('closeRestoreModalBtn'), cancelRestoreBtn: document.getElementById('cancelRestoreBtn'), confirmRestoreBtn: document.getElementById('confirmRestoreBtn'), restoreChatList: document.getElementById('restoreChatList'), restoreSelectAll: document.getElementById('restoreSelectAll'), diaryGenerationTurns: document.getElementById('diaryGenerationTurns'), diaryListPage: document.getElementById('diaryListPage'), closeDiaryListPageBtn: document.getElementById('closeDiaryListPageBtn'), diaryListContainer: document.getElementById('diaryListContainer'), diaryDetailPage: document.getElementById('diaryDetailPage'), backToDiaryListBtn: document.getElementById('backToDiaryListBtn'), diaryDetailPageTitle: document.getElementById('diaryDetailPageTitle'), diaryEntriesContainer: document.getElementById('diaryEntriesContainer'), manualDiaryBtn: document.getElementById('manualDiaryBtn'), resetDiaryPtrBtn: document.getElementById('resetDiaryPtrBtn'), editDiaryEntryModal: document.getElementById('editDiaryEntryModal'), closeEditDiaryModalBtn: document.getElementById('closeEditDiaryModalBtn'), editDiaryEntryText: document.getElementById('editDiaryEntryText'), cancelEditDiaryBtn: document.getElementById('cancelEditDiaryBtn'), saveEditDiaryBtn: document.getElementById('saveEditDiaryBtn'), viewLogsBtn: document.getElementById('viewLogsBtn'), clearLogsBtn: document.getElementById('clearLogsBtn'), logModal: document.getElementById('logModal'), closeLogModalBtn: document.getElementById('closeLogModalBtn'), logOutput: document.getElementById('logOutput'), };

function logToUI(message) { const timestamp = new Date().toLocaleTimeString('en-GB'); const logEntry = `[${timestamp}] ${message}`; appData.logs.push(logEntry); console.log(message); }
function getFormattedTimestamp(ts) { const now = ts ? new Date(ts) : new Date(); return `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`; }
function formatMessageTimestamp(ts) { if (!ts) return ''; const date = new Date(ts); const year = date.getFullYear(); const month = (date.getMonth() + 1).toString().padStart(2, '0'); const day = date.getDate().toString().padStart(2, '0'); const hours = date.getHours().toString().padStart(2, '0'); const minutes = date.getMinutes().toString().padStart(2, '0'); return `${year}-${month}-${day} ${hours}:${minutes}`; }
let jszipPromise=null; function loadJSZip(){if(window.JSZip){return Promise.resolve()}if(jszipPromise){return jszipPromise}jszipPromise=new Promise((resolve,reject)=>{const script=document.createElement('script');script.src='https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';script.onload=()=>{resolve()};script.onerror=()=>{jszipPromise=null;logToUI('备份/恢复功能所需组件加载失败，请检查网络连接后重试。');reject(new Error('备份/恢复功能所需组件加载失败，请检查网络连接后重试。'))};document.head.appendChild(script)});return jszipPromise}
function dataURLtoBlob(dataUrl){const arr=dataUrl.split(','),mime=arr[0].match(/:(.*?);/)[1],bstr=atob(arr[1]);let n=bstr.length;const u8arr=new Uint8Array(n);while(n--)u8arr[n]=bstr.charCodeAt(n);return new Blob([u8arr],{type:mime})}
async function backupData(){const btn=DOM.backupDataBtn;const originalText=btn.querySelector('span').textContent;btn.disabled=true;btn.querySelector('span').textContent='加载组件...';try{await loadJSZip();btn.querySelector('span').textContent='正在备份...';const zip=new JSZip();const globalsFolder=zip.folder('_globals');const userInfoToSave={name:appData.userInfo.name};globalsFolder.file('settings.json',JSON.stringify({apiConfig:appData.apiConfig,userInfo:userInfoToSave},null,2));if(appData.userInfo.avatar&&appData.userInfo.avatar.type!=='default'&&appData.userInfo.avatar.url){try{let avatarBlob;if(appData.userInfo.avatar.url.startsWith('data:image')){avatarBlob=dataURLtoBlob(appData.userInfo.avatar.url)}else{const response=await fetch(appData.userInfo.avatar.url);avatarBlob=await response.blob()}const extension=avatarBlob.type.split('/')[1]||'png';globalsFolder.file(`user_avatar.${extension}`,avatarBlob)}catch(e){console.error("备份用户头像失败:",e);logToUI(`备份用户头像失败: ${e.message}`)}}for(const chat of appData.chatObjects){const chatFolder=zip.folder(chat.id);const chatDataToSave={id:chat.id,name:chat.name,systemPrompt:chat.systemPrompt,messages:chat.messages,diaries:chat.diaries,lastDiaryIndex:chat.lastDiaryIndex,createdAt:chat.createdAt};chatFolder.file('history.json',JSON.stringify(chatDataToSave,null,2));if(chat.avatar&&chat.avatar.type!=='default'&&chat.avatar.url){try{let avatarBlob;if(chat.avatar.url.startsWith('data:image')){avatarBlob=dataURLtoBlob(chat.avatar.url)}else{const response=await fetch(chat.avatar.url);avatarBlob=await response.blob()}const extension=avatarBlob.type.split('/')[1]||'png';chatFolder.file(`avatar.${extension}`,avatarBlob)}catch(e){console.error(`备份聊天 [${chat.name}] 的头像失败:`,e);logToUI(`备份聊天 [${chat.name}] 的头像失败: ${e.message}`)}}}const content=await zip.generateAsync({type:"blob"});const timestamp=new Date().toISOString().slice(0,19).replace(/[-T:]/g,'');const filename=`WeChat-AI-Backup-${timestamp}.zip`;const a=document.createElement('a');a.href=URL.createObjectURL(content);a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(a.href);alert(`备份成功！文件已保存为 ${filename}，请在您浏览器的“下载”文件夹中查看。`)}catch(error){alert(error.message)}finally{btn.disabled=false;btn.querySelector('span').textContent=originalText}}
async function triggerRestore(){const btn=DOM.restoreDataBtn;const originalText=btn.querySelector('span').textContent;btn.disabled=true;btn.querySelector('span').textContent='加载组件...';try{await loadJSZip();DOM.restoreFileInput.click()}catch(error){alert(error.message)}finally{btn.disabled=false;btn.querySelector('span').textContent=originalText}}
async function handleRestoreFile(event){const file=event.target.files[0];if(!file)return;try{const zip=await JSZip.loadAsync(file);appData.restoreTempData.zip=zip;appData.restoreTempData.parsedChats=[];const directories=Object.keys(zip.files).filter(path=>path.endsWith('/')&&path.indexOf('/')===path.length-1);for(const dirPath of directories){if(dirPath==='_globals/')continue;const historyFile=zip.file(`${dirPath}history.json`);if(historyFile){const historyContent=await historyFile.async('string');const chatData=JSON.parse(historyContent);appData.restoreTempData.parsedChats.push({id:chatData.id,name:chatData.name})}}if(appData.restoreTempData.parsedChats.length===0){alert('这个备份文件里没有找到有效的聊天记录。')}else{showRestoreModal()}}catch(e){alert('无法读取或解析备份文件。请确保文件未损坏且格式正确。');console.error("恢复文件解析失败:",e);logToUI(`恢复文件解析失败: ${e.message}`)}finally{DOM.restoreFileInput.value=''}}
function showRestoreModal(){DOM.restoreChatList.innerHTML='';appData.restoreTempData.parsedChats.forEach(chat=>{const div=document.createElement('div');div.className='flex items-center';div.innerHTML=`<label class="flex items-center space-x-3 cursor-pointer w-full p-1 hover:bg-wechat-gray rounded"><input type="checkbox" data-chat-id="${chat.id}" class="restore-chat-item rounded border-gray-300 text-wechat-green focus:ring-wechat-green"><span class="text-wechat-text">${escapeHtml(chat.name)}</span></label>`;DOM.restoreChatList.appendChild(div)});DOM.restoreSelectAll.checked=false;DOM.restoreModal.classList.remove('hidden')}
function closeRestoreModal(){DOM.restoreModal.classList.add('hidden');appData.restoreTempData={zip:null,parsedChats:[]}}
function blobToDataURL(blob){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=e=>resolve(e.target.result);reader.onerror=e=>reject(e.target.error);reader.readAsDataURL(blob)})}
async function confirmRestore(){const selectedIds=Array.from(document.querySelectorAll('.restore-chat-item:checked')).map(cb=>cb.dataset.chatId);if(selectedIds.length===0){alert('请至少选择一个聊天对象进行恢复。');return}const zip=appData.restoreTempData.zip;try{const settingsFile=zip.file('_globals/settings.json');if(settingsFile){const settingsContent=await settingsFile.async('string');const{apiConfig,userInfo}=JSON.parse(settingsContent);appData.apiConfig={...appData.apiConfig,...apiConfig};appData.userInfo.name=userInfo.name;const userAvatarFile=zip.file(/_globals\/user_avatar\.(png|jpg|jpeg|gif|webp)$/)[0];if(userAvatarFile){const avatarBlob=await userAvatarFile.async('blob');appData.userInfo.avatar={type:'upload',url:await blobToDataURL(avatarBlob)}}else{appData.userInfo.avatar={type:'default',url:''}}}for(const chatId of selectedIds){const chatDir=`${chatId}/`;const historyFile=zip.file(`${chatDir}history.json`);if(!historyFile)continue;const chatData=JSON.parse(await historyFile.async('string'));const chatAvatarFile=zip.file(new RegExp(`^${chatDir}avatar\\.(png|jpg|jpeg|gif|webp)$`))[0];if(chatAvatarFile){const avatarBlob=await chatAvatarFile.async('blob');chatData.avatar={type:'upload',url:await blobToDataURL(avatarBlob)}}else{chatData.avatar={type:'default',url:''}}chatData.diaries=chatData.diaries||[];chatData.lastDiaryIndex=chatData.lastDiaryIndex||0;const existingIndex=appData.chatObjects.findIndex(c=>c.id===chatId);if(existingIndex!==-1){appData.chatObjects[existingIndex]=chatData}else{appData.chatObjects.push(chatData)}}saveDataToStorage();loadUIData();renderChatList();if(isDiaryPageVisible())renderDiaryList();alert(`成功恢复了 ${selectedIds.length} 个聊天和全局设置！`);closeRestoreModal()}catch(e){alert('恢复过程中发生错误。');console.error("恢复失败：",e);logToUI(`恢复失败: ${e.message}`)}}

// [Bugfix] 使用更健壮的方式加载数据
function loadDataFromStorage() {
    try {
        const storedObjects = localStorage.getItem('aiMultiChatObjects');
        appData.chatObjects = storedObjects ? JSON.parse(storedObjects).map(c => ({...c, messages: c.messages || [], diaries: c.diaries || [], lastDiaryIndex: c.lastDiaryIndex || 0, })) : [];
        const storedConfig = JSON.parse(localStorage.getItem('aiMultiChatApiConfig') || '{}');
        appData.apiConfig = { ...aichat_default_config, ...storedConfig };
        const storedUser = localStorage.getItem('aiMultiChatUserInfo');
        appData.userInfo = storedUser ? ({...{ name: 'user', avatar: { type: 'default', url: '' } }, ...JSON.parse(storedUser) }) : { name: 'user', avatar: { type: 'default', url: '' } };
        appData.activeChatId = localStorage.getItem('aiMultiChatActiveId') || null;
    } catch (e) {
        console.error("从localStorage加载数据失败:", e);
        alert("加载本地缓存数据失败，您的聊天记录可能已损坏。");
    }
}

function loadUIData(){Object.keys(appData.apiConfig).forEach(k=>{if(DOM[k])DOM[k].value=appData.apiConfig[k]});DOM.userName.value=appData.userInfo.name;appData.userAvatarTempData={...appData.userInfo.avatar};updateUserAvatarPreview()}
function saveDataToStorage(){try{localStorage.setItem('aiMultiChatObjects',JSON.stringify(appData.chatObjects));localStorage.setItem('aiMultiChatApiConfig',JSON.stringify(appData.apiConfig));localStorage.setItem('aiMultiChatUserInfo',JSON.stringify(appData.userInfo));if(appData.activeChatId)localStorage.setItem('aiMultiChatActiveId',appData.activeChatId)}catch(e){console.error("保存数据到localStorage失败:",e);alert("保存数据失败，可能是由于存储空间已满。")}}
function init(){loadDataFromStorage();loadUIData();renderChatList();setupEventListeners();setTimeout(adjustHeights,100)}
function cleanAiResponse(raw){return(raw.replace(/<think>[\s\S]*?<\/think>/g,'').trim())||""}
function adjustHeights(){const vh=window.innerHeight;const h1=DOM.chatListPage.querySelector('header')?.offsetHeight||0;const n1=DOM.chatListPage.querySelector('nav')?.offsetHeight||0;if(DOM.chatListContainer)DOM.chatListContainer.style.height=`${vh-h1-n1}px`;const h2=DOM.chatPage.querySelector('header')?.offsetHeight||0;const i2=DOM.chatPage.querySelector('.chat-input-container')?.offsetHeight||0;if(DOM.chatPageContainer)DOM.chatPageContainer.style.height=`${vh-h2-i2}px`}
function renderChatList(){DOM.chatListContainer.innerHTML='';if(appData.chatObjects.length===0){DOM.emptyChatList.classList.remove('hidden');return}DOM.emptyChatList.classList.add('hidden');[...appData.chatObjects].sort((a,b)=>(b.messages.slice(-1)[0]?.timestamp||b.createdAt)-(a.messages.slice(-1)[0]?.timestamp||a.createdAt)).forEach(c=>{const iC=document.createElement('div');iC.className='chat-item-container relative';const w=document.createElement('div');w.className='chat-item-wrapper';const i=document.createElement('div');i.className='flex items-center flex-1 p-4 border-b border-wechat-darkGray cursor-pointer';i.dataset.chatId=c.id;const l=c.messages.length>0?c.messages[c.messages.length-1].content:'暂无消息';i.innerHTML=`<div class="w-12 h-12 rounded-full overflow-hidden mr-3 flex-shrink-0">${c.avatar&&c.avatar.type!=='default'&&c.avatar.url?`<img src="${escapeHtml(c.avatar.url)}" alt="${escapeHtml(c.name)}" class="w-full h-full object-cover">`:`<div class="w-full h-full bg-wechat-green flex items-center justify-center text-white"><i class="fa fa-robot"></i></div>`}</div><div class="flex-1 min-w-0"><h3 class="font-medium text-wechat-text truncate">${escapeHtml(c.name)}</h3><p class="text-xs text-wechat-lightText truncate mt-1">${escapeHtml(l.substring(0,20)+(l.length>20?'...':''))}</p></div>`;const aD=document.createElement('div');aD.className='chat-item-actions';aD.innerHTML=`<button class="edit-action-btn" title="编辑" data-chat-id="${c.id}"><i class="fa fa-pencil"></i></button><button class="delete-action-btn" title="删除" data-chat-id="${c.id}"><i class="fa fa-trash"></i></button>`;const dB=document.createElement('div');dB.className='slide-delete-btn';dB.innerHTML='<i class="fa fa-trash mr-1"></i>移除';w.append(i,dB);iC.append(w,aD);DOM.chatListContainer.appendChild(iC);setupSwipeToDelete(w,c.id);i.addEventListener('click',()=>openChat(c.id));aD.querySelector('.edit-action-btn').addEventListener('click',(e)=>{e.stopPropagation();openChatDetail(c.id)});aD.querySelector('.delete-action-btn').addEventListener('click',(e)=>{e.stopPropagation();showConfirmDeleteModal(c.id)})})}
function deleteChat(chatId){appData.chatObjects=appData.chatObjects.filter(chat=>chat.id!==chatId);if(appData.activeChatId===chatId){appData.activeChatId=null;localStorage.removeItem('aiMultiChatActiveId');DOM.chatPage.classList.add('hidden');DOM.chatListPage.classList.remove('hidden')}hideConfirmDeleteModal();saveDataToStorage();renderChatList();if(isDiaryPageVisible())renderDiaryList()}
function createNewChat(){const nC={id:generateUniqueId(),name:DOM.newChatName.value.trim()||'AI助手',avatar:{...appData.newChatTempData.avatar},systemPrompt:DOM.newChatSystemPrompt.value.trim()||'你是一个友好、helpful 的AI助手。',messages:[],diaries:[],lastDiaryIndex:0,createdAt:Date.now()};appData.chatObjects.push(nC);saveDataToStorage();closeAddChatModal();renderChatList();if(isDiaryPageVisible())renderDiaryList();openChat(nC.id)}
function saveChatDetail(){const chatIndex=appData.chatObjects.findIndex(c=>c.id===appData.editChatTempData.chatId);if(chatIndex===-1)return;const updatedChat={...appData.chatObjects[chatIndex],name:DOM.editChatName.value.trim()||'AI助手',systemPrompt:DOM.editChatSystemPrompt.value.trim()||'你是一个友好、helpful 的AI助手。',avatar:{...appData.editChatTempData.avatar}};appData.chatObjects[chatIndex]=updatedChat;saveDataToStorage();renderChatList();if(isDiaryPageVisible())renderDiaryList();if(appData.activeChatId===updatedChat.id)openChat(updatedChat.id);DOM.chatDetailPage.classList.add('translate-x-full')}
function openChat(id){const c=appData.chatObjects.find(c=>c.id===id);if(!c)return;appData.activeChatId=id;saveDataToStorage();DOM.chatPageTitle.textContent=c.name;DOM.chatPageAvatar.innerHTML=c.avatar&&c.avatar.type!=='default'&&c.avatar.url?`<img src="${escapeHtml(c.avatar.url)}" alt="${escapeHtml(c.name)}" class="w-full h-full object-cover">`:`<div class="w-full h-full rounded-full bg-wechat-green flex items-center justify-center text-white"><i class="fa fa-robot"></i></div>`;DOM.chatPageTypingText.textContent=`${c.name}正在输入中...`;renderChatMessages(c.messages);DOM.chatListPage.classList.add('hidden');DOM.chatPage.classList.remove('hidden');DOM.chatPageMessageInput.value='';DOM.chatPageMessageInput.style.height='auto';setTimeout(()=>{if(DOM.chatPageContainer)DOM.chatPageContainer.scrollTop=DOM.chatPageContainer.scrollHeight;adjustHeights()},100)}
function openChatDetail(id){const c=appData.chatObjects.find(c=>c.id===id);if(!c)return;appData.editChatTempData={chatId:id,avatar:{...c.avatar}};DOM.editChatName.value=c.name;DOM.editChatSystemPrompt.value=c.systemPrompt;updateEditChatAvatarPreview();DOM.editAvatarContainer.classList.add('hidden');DOM.chatDetailPage.classList.remove('translate-x-full')}
function renderChatMessages(m){DOM.chatPageContainer.innerHTML=m.length===0?`<div class="flex flex-col items-center justify-center h-full text-wechat-lightText py-10"><i class="fa fa-comments-o text-4xl mb-3 opacity-50"></i><p class="text-sm">发送第一条消息开始对话吧</p></div>`:'';if(m.length===0)return;m.forEach((g,x)=>{const e=document.createElement('div');e.className=`flex items-start mb-6 ${g.role==='user'?'justify-end':''}`;e.dataset.messageRole=g.role;e.dataset.messageIndex=x;const uA=appData.userInfo.avatar&&appData.userInfo.avatar.type!=='default'&&appData.userInfo.avatar.url?`<div class="w-8 h-8 rounded-full overflow-hidden ml-3 flex-shrink-0"><img src="${escapeHtml(appData.userInfo.avatar.url)}" class="w-full h-full object-cover"></div>`:`<div class="user-avatar-small"><i class="fa fa-user"></i></div>`;const c=appData.chatObjects.find(c=>c.id===appData.activeChatId);const aA=!c||!c.avatar||c.avatar.type==='default'||!c.avatar.url?`<div class="w-8 h-8 rounded-full bg-wechat-green flex items-center justify-center text-white mr-3 flex-shrink-0"><i class="fa fa-robot"></i></div>`:`<div class="w-8 h-8 rounded-full mr-3 flex-shrink-0 overflow-hidden"><img src="${escapeHtml(c.avatar.url)}" class="w-full h-full object-cover"></div>`;e.innerHTML=g.role==='user'?`<div class="chat-bubble-user"><p class="text-sm">${escapeHtml(g.content)}</p></div>${uA}`:`${aA}<div class="chat-bubble-ai"><p class="text-sm">${escapeHtml(g.content)}</p></div>`;DOM.chatPageContainer.appendChild(e)});setTimeout(()=>{if(DOM.chatPageContainer)DOM.chatPageContainer.scrollTop=DOM.chatPageContainer.scrollHeight},100)}
function getHistoryForApi(m){const t=appData.apiConfig.historyTurns;return(!t||t<=0)?m:m.slice(-t*2)}

async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
    for (let attempt = 1; attempt <= retries; attempt++) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`API request failed with status ${response.status}: ${errorData.error?.message || response.statusText}`);
            }
            const data = await response.json();
            // 增加对响应内容的有效性检查
            if (!data.choices || data.choices.length === 0 || !data.choices[0].message?.content) {
                throw new Error('Invalid response content (e.g., empty choices or content).');
            }
            return data; // 直接返回解析后的有效数据
        } catch (error) {
            logToUI(`Attempt ${attempt} of ${retries} failed: ${error.message}`);
            if (attempt < retries) {
                await new Promise(resolve => setTimeout(resolve, delay));
            } else {
                throw new Error('AllRetryAttemptsFailed');
            }
        }
    }
}

async function sendOrRegenerate(contextMessages) {
    const chatIndex = appData.chatObjects.findIndex(c => c.id === appData.activeChatId);
    if (chatIndex < 0) return;
    const chat = appData.chatObjects[chatIndex];
    if (!appData.apiConfig.apiKey) { alert('请先在设置中填写API Key'); togglePage('settings', true); return; }

    DOM.chatPageTypingIndicator.classList.add('show');
    try {
        const diarySummary = chat.diaries.map(d => `[过往日记摘要]:\n${d.content}`).join('\n\n');
        const longTermMemoryContext = diarySummary ? `这是你和用户之间过往的对话摘要，请将此作为你的长期记忆：\n${diarySummary}\n\n` : '';
        const systemPrompt = `${longTermMemoryContext}${appData.apiConfig.globalSystemPrompt}\n\n${chat.systemPrompt}`.trim();
        const userName = appData.userInfo.name.trim() || 'user';
        
        let apiMessages = getHistoryForApi(contextMessages).map(m => ({
            role: m.role === 'user' ? 'user' : 'assistant',
            name: m.role === 'user' ? userName : undefined,
            content: m.content
        }));

        const lastUserMessageIndex = apiMessages.map(m => m.role).lastIndexOf('user');
        if (lastUserMessageIndex > -1) {
            apiMessages[lastUserMessageIndex].content = `[当前时间: ${formatMessageTimestamp(Date.now())}]\n${apiMessages[lastUserMessageIndex].content}`;
        }
        
        const apiPayload = [{ role: 'system', content: systemPrompt }, ...apiMessages];
        
        // fetchWithRetry现在直接返回data
        const data = await fetchWithRetry(
            `${appData.apiConfig.baseUrl}/chat/completions`, 
            { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${appData.apiConfig.apiKey}` }, 
                body: JSON.stringify({ model: appData.apiConfig.modelName, messages: apiPayload, temperature: appData.apiConfig.temperature }) 
            }
        );

        // 因为fetchWithRetry已经保证了data和choices的有效性，这里的代码可以简化
        const cleanedContent = cleanAiResponse(data.choices[0].message.content);
        const firstNewlineIndex = cleanedContent.indexOf('\n');
        let messageParts = (firstNewlineIndex === -1) ? [cleanedContent] : [cleanedContent.substring(0, firstNewlineIndex), cleanedContent.substring(firstNewlineIndex + 1)];
        const finalMessages = messageParts.map(p => p.trim()).filter(p => p !== '');
        
        if (finalMessages.length > 0) { 
            finalMessages.forEach(part => { chat.messages.push({ role: 'assistant', content: part, timestamp: Date.now() }); }); 
        } else { 
            // 这个分支理论上不会再进入，但作为保险措施保留
            chat.messages.push({ role: 'assistant', content: "...", timestamp: Date.now() }); 
        }
        
        saveDataToStorage();
        renderChatMessages(chat.messages);
        checkAndTriggerDiaryGeneration(chat);

    } catch (e) {
        if (e.message === 'AllRetryAttemptsFailed') {
            logToUI('All retry attempts failed. Adding busy message.');
            chat.messages.push({
                role: 'assistant',
                content: "我现在有点忙，稍后再聊",
                timestamp: Date.now()
            });
            saveDataToStorage();
            renderChatMessages(chat.messages);
        } else {
            alert(`出错了：${e.message}`);
        }
    } finally {
        DOM.chatPageTypingIndicator.classList.remove('show');
    }
}

async function regenerateAiResponse(targetIndex) {
    if (targetIndex === null || !appData.activeChatId) return;
    const chat = appData.chatObjects.find(c => c.id === appData.activeChatId);
    if (!chat || targetIndex < 0 || chat.messages[targetIndex].role !== 'assistant') return;
    const isMidConversation = chat.messages.some((msg, index) => index > targetIndex);
    if (isMidConversation) { if (!confirm("您正在尝试重新生成一条历史消息。\n\n确认后，此消息及其之后的所有对话都将被删除并重新生成。\n\n您确定要继续吗？")) { return; } }
    let turnStartIndex = targetIndex;
    while (turnStartIndex > 0 && chat.messages[turnStartIndex - 1].role === 'assistant') { turnStartIndex--; }
    const contextForApi = chat.messages.slice(0, turnStartIndex);
    chat.messages.length = turnStartIndex;
    renderChatMessages(chat.messages);
    await sendOrRegenerate(contextForApi);
}
async function checkAndTriggerDiaryGeneration(chat) { logToUI('自动总结检查: 开始。'); if (appData.isGeneratingDiary) { logToUI("自动总结检查: 检测到已有任务在运行，跳过。"); return; } const threshold = parseInt(appData.apiConfig.diaryGenerationTurns, 10); if (!threshold || threshold <= 0) return; const lastIndex = chat.lastDiaryIndex || 0; const messagesSinceLastDiary = chat.messages.slice(lastIndex); const aiRepliesSinceLastDiary = messagesSinceLastDiary.filter(m => m.role === 'assistant').length; logToUI(`自动总结检查: lastDiaryIndex=${lastIndex}, messages.length=${chat.messages.length}, 新AI回复数=${aiRepliesSinceLastDiary}, 阈值=${threshold}`); if (aiRepliesSinceLastDiary >= threshold) { logToUI(`自动总结检查: 达到阈值，准备触发。`); let turnsCounted = 0; let endIndex = 0; for (let i = 0; i < messagesSinceLastDiary.length; i++) { if (messagesSinceLastDiary[i].role === 'assistant') { turnsCounted++; } if (turnsCounted === threshold) { endIndex = i + 1; break; } } const messagesToSummarize = messagesSinceLastDiary.slice(0, endIndex); appData.isGeneratingDiary = true; logToUI("自动总结检查: **上锁**，开始生成。待总结消息数: " + messagesToSummarize.length); try { await generateDiaryEntry(chat, messagesToSummarize, lastIndex); } finally { appData.isGeneratingDiary = false; logToUI("自动总结检查: **解锁**，任务结束。"); } } else { logToUI('自动总结检查: 未达到阈值，无操作。'); } }
function resetDiaryPointer() { const chat = appData.chatObjects.find(c => c.id === appData.diaryView.activeChatId); if (!chat) return; if (confirm(`确定要重置【${chat.name}】的日记指针吗？\n\n这将让程序认为所有聊天记录都是“新的”，可以被重新总结。当总结功能失效时，这是一个有效的修复手段。`)) { const oldIndex = chat.lastDiaryIndex || 0; chat.lastDiaryIndex = 0; saveDataToStorage(); alert("日记指针已重置为0！现在您可以尝试手动总结了。"); logToUI(`指针重置: Chat [${chat.name}] 的 lastDiaryIndex 已被手动从 ${oldIndex} 重置为 0。`); } }
async function manualGenerateDiary() { logToUI('手动总结: 开始。'); if (appData.isGeneratingDiary) { alert("正在生成上一篇日记，请稍后再试。"); logToUI('手动总结: 检测到已有任务在运行，已阻止。'); return; } const chat = appData.chatObjects.find(c => c.id === appData.diaryView.activeChatId); if (!chat) return; const lastIndex = chat.lastDiaryIndex || 0; const messagesToSummarize = chat.messages.slice(lastIndex); logToUI(`手动总结: lastDiaryIndex=${lastIndex}, messages.length=${chat.messages.length}, 待总结消息数=${messagesToSummarize.length}`); if (messagesToSummarize.length === 0) { alert("没有需要总结的新内容。如果确定有新内容但此处为0，请先“重置指针”。"); logToUI('手动总结: 没有新消息，已中止。'); return; } appData.isGeneratingDiary = true; logToUI("手动总结: **上锁**，开始生成。"); const btn = DOM.manualDiaryBtn; const originalText = btn.innerHTML; btn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i>总结中...'; btn.disabled = true; try { const success = await generateDiaryEntry(chat, messagesToSummarize, lastIndex); if (success) { alert("手动总结成功！"); } else { alert("总结失败，可能是网络问题或API错误。请从“设置”页面打开日志查看详情。"); } } finally { appData.isGeneratingDiary = false; btn.innerHTML = originalText; btn.disabled = false; logToUI("手动总结: **解锁**，任务结束。"); } }
async function generateDiaryEntry(chat, messagesToSummarize, startIndex) { logToUI(`核心总结: 开始为 ${messagesToSummarize.length} 条消息生成日记，起始索引: ${startIndex}`); const today = new Date(); const dateString = `${today.getFullYear()}年${(today.getMonth() + 1).toString().padStart(2, '0')}月${today.getDate().toString().padStart(2, '0')}日`; const userName = appData.userInfo.name.trim() || '用户'; const systemRolePrompt = `你是一名日记作者，你的任务是根据你和特定用户之间的对话，撰写一篇你的个人日记。用户的名字是：'${userName}'。在日记正文中，你必须用这个名字来称呼他/她，或者用你的人设提示词中对用户的称呼。严格遵守以下规则：\n1. 你必须以第一人称（“我”）来书写【正文】。\n2. 你的输出必须且只能包含以下几个部分，每一部分都必须独占一行，并使用指定的标签：\n- 【日期】${dateString}\n- 【天气】（根据对话内容和氛围，推测一个天气，如：晴、阴、雨、多云...）【心情】（根据对话内容和氛围，推测你的心情，如：开心、平静、困惑、激动...）\n- 【正文】（以“我”的视角，记录今天和'${userName}'的对话要点、我的想法和感受。）\n3. 提供给你的对话内容中，每一条消息都以 [YYYY-MM-DD HH:mm] 格式的时间戳开头。你必须密切关注这些时间戳，以理解对话的真实时间顺序和可能存在的时间间隔（例如，跨越了午夜或者间隔了数小时）。你的日记正文需要能体现出对这种时间跨度的理解。\n4. 不要在最终输出中添加任何额外的解释、开场白或结束语，严格按照格式输出。\n下面是一个优秀的输出范例：\n【日期】${dateString}\n【天气】晴    【心情】开心\n【正文】昨天深夜和${userName}聊得很愉快，我们简单讨论了...。今天早上我们又继续了这个话题，我了解到...`; const userRolePrompt = `这是我们今天的对话内容，请根据这些内容，为我生成一篇符合上述所有规则的日记：\n\n${messagesToSummarize.map(m => `[${formatMessageTimestamp(m.timestamp)}] ${m.role === 'user' ? userName : '我'}: ${m.content}`).join('\n')}`; try { const response = await fetch(`${appData.apiConfig.baseUrl}/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${appData.apiConfig.apiKey}` }, body: JSON.stringify({ model: appData.apiConfig.modelName, messages: [{ role: 'system', content: systemRolePrompt },{ role: 'user', content: userRolePrompt }], temperature: appData.apiConfig.temperature }) }); if (!response.ok) { const errorText = await response.text(); throw new Error(`AI日记生成API请求失败 (${response.status}): ${errorText}`); } const data = await response.json(); const diaryContent = cleanAiResponse(data.choices[0].message.content); if (diaryContent) { chat.diaries.push({ id: generateUniqueId(), content: diaryContent, timestamp: Date.now() }); const oldIndex = chat.lastDiaryIndex || 0; chat.lastDiaryIndex = startIndex + messagesToSummarize.length; saveDataToStorage(); logToUI(`核心总结: 成功！日记已保存。lastDiaryIndex 从 ${oldIndex} 更新为 ${chat.lastDiaryIndex}`); if (appData.diaryView.activeChatId === chat.id && !DOM.diaryDetailPage.classList.contains('translate-x-full')) { renderDiaryEntries(); } return true; } logToUI("核心总结: 失败，AI返回内容为空。"); return false; } catch (e) { logToUI(`核心总结: 捕获到严重错误: ${e.message}`); console.error("日记生成失败:", e); return false; } }
function setupSwipeToDelete(w,id){let s=0;w.addEventListener('touchstart',(e)=>{s=e.touches[0].clientX});w.addEventListener('touchmove',(e)=>{w.classList.toggle('swipe-left',s-e.touches[0].clientX>30)});w.addEventListener('touchend',()=>{});w.querySelector('.slide-delete-btn').addEventListener('click',()=>showConfirmDeleteModal(id))}
function showConfirmDeleteModal(id){appData.editChatTempData.chatId=id;DOM.confirmDeleteModal.classList.remove('hidden');document.querySelectorAll('.chat-item-wrapper.swipe-left').forEach(w=>w.classList.remove('swipe-left'))}
function hideConfirmDeleteModal(){DOM.confirmDeleteModal.classList.add('hidden');appData.editChatTempData.chatId=null}
async function sendChatMessage(){const t=DOM.chatPageMessageInput.value.trim();if(!t||!appData.activeChatId)return;const i=appData.chatObjects.findIndex(c=>c.id===appData.activeChatId);if(i<0)return;const chat=appData.chatObjects[i];chat.messages.push({role:'user',content:t,timestamp:Date.now()});saveDataToStorage();renderChatMessages(chat.messages);DOM.chatPageMessageInput.value='';DOM.chatPageMessageInput.style.height='auto';await sendOrRegenerate(chat.messages)}
function generateUniqueId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,9)}
function escapeHtml(u){return u?u.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/\n/g,"<br>"):''}
function openAddChatModal(){appData.newChatTempData.avatar={type:'default',url:''};DOM.newChatName.value='AI助手';DOM.newChatSystemPrompt.value='你是一个友好、helpful 的AI助手。';DOM.newChatAvatarUrl.value='';DOM.newChatAvatarUrlContainer.classList.add('hidden');updateNewChatAvatarPreview();DOM.addChatModal.classList.remove('hidden')}
function closeAddChatModal(){DOM.addChatModal.classList.add('hidden')}
function updateAvatarPreview(p,i,a){const d=!a||a.type==='default'||!a.url;p.style.display=d?'none':'block';i.style.display=d?'flex':'none';if(!d){p.src=a.url;p.onerror=()=>{p.style.display='none';i.style.display='flex'}}}
const updateNewChatAvatarPreview=()=>updateAvatarPreview(DOM.newChatAvatarPreview,DOM.newChatAvatarIcon,appData.newChatTempData.avatar);
const updateEditChatAvatarPreview=()=>updateAvatarPreview(DOM.editChatAvatarPreview,DOM.editChatAvatarIcon,appData.editChatTempData.avatar);
const updateUserAvatarPreview=()=>updateAvatarPreview(DOM.userAvatarPreview,DOM.userAvatarIcon,appData.userAvatarTempData);
const handleNewChatAvatarUpload=(e)=>handleGenericAvatarUpload(e.target.files[0],appData.newChatTempData,updateNewChatAvatarPreview);
const handleEditChatAvatarUpload=(e)=>handleGenericAvatarUpload(e.target.files[0],appData.editChatTempData,updateEditChatAvatarPreview);
function handleGenericAvatarUpload(file,tempData,updateFunc){if(!file||!file.type.startsWith('image/'))return;const reader=new FileReader();reader.onload=(e)=>{tempData.avatar={type:'upload',url:e.target.result};updateFunc()};reader.readAsDataURL(file)}
function handleUserAvatarUpload(event){const file=event.target.files[0];if(!file||!file.type.startsWith('image/'))return;const reader=new FileReader();reader.onload=(e)=>{appData.userAvatarTempData.type='upload';appData.userAvatarTempData.url=e.target.result;updateUserAvatarPreview()};reader.readAsDataURL(file)}
function handleUserAvatarUrl(){const url=DOM.userAvatarUrl.value.trim();if(!url)return;try{new URL(url)}catch{return alert('请输入有效的URL')}appData.userAvatarTempData={type:'url',url:url};updateUserAvatarPreview();DOM.userAvatarUrlContainer.classList.add('hidden');DOM.userAvatarUrl.value=''}
function handleAvatarUrl(inputElem,containerElem,dataObj,updateFunc){const url=inputElem.value.trim();if(!url)return;try{new URL(url)}catch{alert('请输入有效的URL');return}dataObj.avatar={type:'url',url:url};updateFunc();containerElem.classList.add('hidden');inputElem.value=''}
const handleNewChatAvatarUrl=()=>handleAvatarUrl(DOM.newChatAvatarUrl,DOM.newChatAvatarUrlContainer,appData.newChatTempData,updateNewChatAvatarPreview);
const handleEditChatAvatarUrl=()=>handleAvatarUrl(DOM.editChatAvatarUrl,DOM.editChatAvatarUrlContainer,appData.editChatTempData,updateEditChatAvatarPreview);

// [Bugfix] 使用更健壮的方式保存数据
function saveApiSettings(e) {
    e.preventDefault();
    appData.apiConfig = {
        ...appData.apiConfig, // 保留从localStorage加载的任何现有值
        baseUrl: DOM.baseUrl.value.trim() || aichat_default_config.baseUrl,
        apiKey: DOM.apiKey.value.trim(),
        modelName: DOM.modelName.value.trim() || aichat_default_config.modelName,
        temperature: parseFloat(DOM.apiTemperature.value) || aichat_default_config.temperature,
        historyTurns: parseInt(DOM.historyTurns.value, 10) || 0,
        diaryGenerationTurns: parseInt(DOM.diaryGenerationTurns.value, 10) || 0,
        globalSystemPrompt: DOM.globalSystemPrompt.value.trim() || aichat_default_config.globalSystemPrompt
    };
    appData.userInfo = { name: DOM.userName.value.trim() || 'user', avatar: { ...appData.userAvatarTempData } };
    saveDataToStorage();
    const b = e.submitter || e.target.querySelector('button[type="submit"]');
    b.textContent = '保存成功！';
    setTimeout(() => { b.textContent = '保存所有设置'; togglePage('settings', false) }, 1500);
}

function togglePage(page,show){const isVisible=(p)=>!p.classList.contains('translate-x-full');[DOM.chatNavBtn,DOM.diaryNavBtn,DOM.settingsNavBtn].forEach(btn=>{btn.classList.remove('nav-item-active');btn.classList.add('text-wechat-lightText')});if(page==='settings'){DOM.settingsPage.classList.toggle('translate-x-full',!show);if(show){loadUIData();DOM.settingsNavBtn.classList.add('nav-item-active');DOM.settingsNavBtn.classList.remove('text-wechat-lightText')}else{DOM.chatNavBtn.classList.add('nav-item-active');DOM.chatNavBtn.classList.remove('text-wechat-lightText')}}else if(page==='diary'){DOM.diaryListPage.classList.toggle('translate-x-full',!show);if(show){renderDiaryList();DOM.diaryNavBtn.classList.add('nav-item-active');DOM.diaryNavBtn.classList.remove('text-wechat-lightText')}else{DOM.chatNavBtn.classList.add('nav-item-active');DOM.chatNavBtn.classList.remove('text-wechat-lightText')}}else{if(isVisible(DOM.settingsPage))DOM.settingsPage.classList.add('translate-x-full');if(isVisible(DOM.diaryListPage))DOM.diaryListPage.classList.add('translate-x-full');DOM.chatNavBtn.classList.add('nav-item-active');DOM.chatNavBtn.classList.remove('text-wechat-lightText')}}
function isDiaryPageVisible(){return!DOM.diaryListPage.classList.contains('translate-x-full')}
function renderDiaryList(){DOM.diaryListContainer.innerHTML='';if(appData.chatObjects.length===0){DOM.diaryListContainer.innerHTML=`<div class="flex flex-col items-center justify-center h-full text-wechat-lightText py-10"><i class="fa fa-book text-4xl mb-3 opacity-50"></i><p class="text-sm">暂无聊天对象，无法查看日记</p></div>`;return}appData.chatObjects.forEach(chat=>{const item=document.createElement('div');item.className='flex items-center p-4 border-b border-wechat-darkGray cursor-pointer';item.dataset.chatId=chat.id;item.innerHTML=`<div class="w-12 h-12 rounded-full overflow-hidden mr-3 flex-shrink-0">${chat.avatar&&chat.avatar.type!=='default'&&chat.avatar.url?`<img src="${escapeHtml(chat.avatar.url)}" alt="${escapeHtml(chat.name)}" class="w-full h-full object-cover">`:`<div class="w-full h-full bg-wechat-green flex items-center justify-center text-white"><i class="fa fa-robot"></i></div>`}</div><div class="flex-1 min-w-0"><h3 class="font-medium text-wechat-text truncate">${escapeHtml(chat.name)}</h3><p class="text-xs text-wechat-lightText truncate mt-1">${chat.diaries.length}篇日记</p></div>`;item.addEventListener('click',()=>openDiaryDetail(chat.id));DOM.diaryListContainer.appendChild(item)})}
function openDiaryDetail(chatId){const chat=appData.chatObjects.find(c=>c.id===chatId);if(!chat)return;appData.diaryView.activeChatId=chatId;DOM.diaryDetailPageTitle.textContent=`${chat.name}的日记本`;renderDiaryEntries();DOM.diaryDetailPage.classList.remove('translate-x-full')}
function renderDiaryEntries(){DOM.diaryEntriesContainer.innerHTML='';const chat=appData.chatObjects.find(c=>c.id===appData.diaryView.activeChatId);if(!chat||chat.diaries.length===0){DOM.diaryEntriesContainer.innerHTML=`<div class="flex flex-col items-center justify-center h-full text-wechat-lightText py-10"><i class="fa fa-pencil-square-o text-4xl mb-3 opacity-50"></i><p class="text-sm">还没有任何日记条目</p><p class="text-xs mt-2">与Ta多聊聊，或点击右上角手动总结</p></div>`;return}[...chat.diaries].sort((a,b)=>b.timestamp-a.timestamp).forEach(entry=>{const card=document.createElement('div');card.className='diary-entry-card relative';card.innerHTML=`<p class="text-xs text-diary-text/60 mb-2">${getFormattedTimestamp(entry.timestamp)}</p><p class="text-sm text-diary-text leading-relaxed">${escapeHtml(entry.content)}</p><div class="absolute top-2 right-2 flex gap-2"><button data-entry-id="${entry.id}" class="edit-diary-btn text-diary-text/50 hover:text-wechat-green p-1"><i class="fa fa-pencil"></i></button><button data-entry-id="${entry.id}" class="delete-diary-btn text-diary-text/50 hover:text-wechat-red p-1"><i class="fa fa-trash"></i></button></div>`;card.querySelector('.edit-diary-btn').addEventListener('click',(e)=>{e.stopPropagation();showEditDiaryModal(entry.id)});card.querySelector('.delete-diary-btn').addEventListener('click',(e)=>{e.stopPropagation();if(confirm('确定要删除这篇日记吗？此操作不可恢复。'))deleteDiaryEntry(entry.id)});DOM.diaryEntriesContainer.appendChild(card)})}
function showEditDiaryModal(entryId){const chat=appData.chatObjects.find(c=>c.id===appData.diaryView.activeChatId);const entry=chat?.diaries.find(d=>d.id===entryId);if(!entry)return;appData.diaryView.editingEntryId=entryId;DOM.editDiaryEntryText.value=entry.content;DOM.editDiaryEntryModal.classList.remove('hidden')}
function closeEditDiaryModal(){DOM.editDiaryEntryModal.classList.add('hidden');appData.diaryView.editingEntryId=null}
function saveDiaryEntry(){const chat=appData.chatObjects.find(c=>c.id===appData.diaryView.activeChatId);const entry=chat?.diaries.find(d=>d.id===appData.diaryView.editingEntryId);if(!entry)return;entry.content=DOM.editDiaryEntryText.value;entry.timestamp=Date.now();saveDataToStorage();renderDiaryEntries();closeEditDiaryModal()}
function deleteDiaryEntry(entryId){const chatIndex=appData.chatObjects.findIndex(c=>c.id===appData.diaryView.activeChatId);if(chatIndex===-1)return;appData.chatObjects[chatIndex].diaries=appData.chatObjects[chatIndex].diaries.filter(d=>d.id!==entryId);saveDataToStorage();renderDiaryEntries()}
function showLogModal() { DOM.logOutput.value = appData.logs.join('\n'); DOM.logModal.classList.remove('hidden'); setTimeout(() => { DOM.logOutput.scrollTop = DOM.logOutput.scrollHeight; }, 100); }
function closeLogModal() { DOM.logModal.classList.add('hidden'); }
function clearLogs() { if (confirm('确定要清空所有诊断日志吗？')) { appData.logs = []; logToUI('日志已清空。'); if (!DOM.logModal.classList.contains('hidden')) { showLogModal(); } alert('日志已清空！'); } }
function setupEventListeners(){const eMap={addChatBtn:{click:openAddChatModal},backToChatListBtn:{click:()=>{DOM.chatPage.classList.add('hidden');DOM.chatListPage.classList.remove('hidden')}},chatPageSendBtn:{click:sendChatMessage},chatPageMessageInput:{keydown:(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChatMessage()}},input:(e)=>{e.target.style.height='auto';e.target.style.height=`${Math.min(e.target.scrollHeight,120)}px`}},chatPageMoreBtn:{click:()=>{if(appData.activeChatId)openChatDetail(appData.activeChatId)}},settingsForm:{submit:saveApiSettings},userAvatarUpload:{change:handleUserAvatarUpload},userAvatarUrlBtn:{click:()=>DOM.userAvatarUrlContainer.classList.toggle('hidden')},userAvatarUrlConfirm:{click:handleUserAvatarUrl},userAvatarUrlCancel:{click:()=>DOM.userAvatarUrlContainer.classList.add('hidden')},closeAddChatModalBtn:{click:closeAddChatModal},newChatAvatarUpload:{change:handleNewChatAvatarUpload},newChatAvatarUrlBtn:{click:()=>DOM.newChatAvatarUrlContainer.classList.toggle('hidden')},newChatAvatarUrlConfirm:{click:handleNewChatAvatarUrl},newChatAvatarUrlCancel:{click:()=>DOM.newChatAvatarUrlContainer.classList.add('hidden')},createChatBtn:{click:createNewChat},backToChatPageBtn:{click:()=>DOM.chatDetailPage.classList.add('translate-x-full')},deleteChatBtn:{click:()=>{if(appData.editChatTempData.chatId)showConfirmDeleteModal(appData.editChatTempData.chatId)}},editAvatarBtn:{click:()=>DOM.editAvatarContainer.classList.remove('hidden')},cancelEditAvatarBtn:{click:()=>DOM.editAvatarContainer.classList.add('hidden')},editChatAvatarUpload:{change:handleEditChatAvatarUpload},editChatAvatarUrlBtn:{click:()=>DOM.editChatAvatarUrlContainer.classList.toggle('hidden')},editChatAvatarUrlConfirm:{click:handleEditChatAvatarUrl},editChatAvatarUrlCancel:{click:()=>DOM.editChatAvatarUrlContainer.classList.add('hidden')},saveChatDetailBtn:{click:saveChatDetail},cancelDeleteBtn:{click:hideConfirmDeleteModal},confirmDeleteBtn:{click:()=>{if(appData.editChatTempData.chatId)deleteChat(appData.editChatTempData.chatId)}},regenerateMessageBtn:{click:()=>{if(appData.contextMenuData.messageIndex!==null)regenerateAiResponse(appData.contextMenuData.messageIndex);DOM.messageContextMenu.classList.add('hidden')}},backupDataBtn:{click:backupData},restoreDataBtn:{click:triggerRestore},restoreFileInput:{change:handleRestoreFile},closeRestoreModalBtn:{click:closeRestoreModal},cancelRestoreBtn:{click:closeRestoreModal},confirmRestoreBtn:{click:confirmRestore},restoreSelectAll:{change:(e)=>document.querySelectorAll('.restore-chat-item').forEach(cb=>cb.checked=e.target.checked)},chatNavBtn:{click:()=>{togglePage('chat',true)}},diaryNavBtn:{click:()=>{togglePage('diary',true)}},settingsNavBtn:{click:()=>{togglePage('settings',true)}},closeSettingsBtn:{click:()=>{togglePage('settings',false)}},closeDiaryListPageBtn:{click:()=>{togglePage('diary',false)}},backToDiaryListBtn:{click:()=>DOM.diaryDetailPage.classList.add('translate-x-full')},manualDiaryBtn: {click: manualGenerateDiary}, resetDiaryPtrBtn: {click: resetDiaryPointer},viewLogsBtn: { click: showLogModal }, clearLogsBtn: { click: clearLogs }, closeLogModalBtn: { click: closeLogModal },closeEditDiaryModalBtn:{click:closeEditDiaryModal},cancelEditDiaryBtn:{click:closeEditDiaryModal},saveEditDiaryBtn:{click:saveDiaryEntry}};for(const id in eMap){if(DOM[id]){for(const ev in eMap[id]){DOM[id].addEventListener(ev,eMap[id][ev])}}}[DOM.addChatModal,DOM.confirmDeleteModal,DOM.restoreModal,DOM.editDiaryEntryModal,DOM.logModal].forEach(el=>el.addEventListener('click',e=>{if(e.target===el)el.classList.add('hidden')}));[...DOM.addChatModal.children,...DOM.confirmDeleteModal.children,...DOM.restoreModal.children,...DOM.editDiaryEntryModal.children,...DOM.logModal.children,DOM.settingsPage,DOM.chatDetailPage,DOM.diaryListPage,DOM.diaryDetailPage].forEach(c=>c.addEventListener('click',e=>e.stopPropagation()));DOM.chatPageContainer.addEventListener('contextmenu',(e)=>{const t=e.target.closest('[data-message-role="assistant"]');if(t){e.preventDefault();appData.contextMenuData.messageIndex=parseInt(t.dataset.messageIndex,10);DOM.messageContextMenu.style.left=`${e.clientX}px`;DOM.messageContextMenu.style.top=`${e.clientY}px`;DOM.messageContextMenu.classList.remove('hidden')}});document.addEventListener('click',()=>DOM.messageContextMenu.classList.add('hidden'));window.addEventListener('resize',adjustHeights)}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
