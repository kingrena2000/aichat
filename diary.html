<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>日记本</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fff; color: #333; min-height: 100vh;
        }
        .diary-header {
            position: sticky; top: 0; z-index: 10;
            background: #fff; border-bottom: 1px solid #e5e5e5;
            display: flex; align-items: center; padding: 12px 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .diary-back {
            width: 36px; height: 36px; border-radius: 50%;
            border: none; background: none; color: #333;
            font-size: 16px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; margin-right: 8px;
        }
        .diary-back:hover { background: #f5f5f5; }
        .diary-title { font-size: 18px; font-weight: 600; color: #333; flex: 1; }
        .diary-body { padding: 0; }
        .diary-empty {
            text-align: center; padding: 60px 20px; color: #bbb;
        }
        .diary-empty i { font-size: 48px; display: block; margin-bottom: 12px; opacity: 0.4; }
        .diary-chat-item {
            display: flex; align-items: center; gap: 12px;
            padding: 14px 16px;
            border-bottom: 1px solid #e5e5e5;
            cursor: pointer; transition: background 0.15s;
        }
        .diary-chat-item:hover { background: #f5f5f5; }
        .diary-chat-item:active { background: #ececec; }
        .diary-chat-avatar {
            width: 48px; height: 48px; border-radius: 50%;
            background: #07C160; display: flex; align-items: center;
            justify-content: center; color: #fff; font-size: 18px;
            flex-shrink: 0; overflow: hidden;
        }
        .diary-chat-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .diary-chat-info { flex: 1; min-width: 0; }
        .diary-chat-name { font-size: 15px; font-weight: 500; color: #333; }
        .diary-chat-count { font-size: 12px; color: #999; margin-top: 3px; }
        .diary-detail-page {
            position: fixed; inset: 0; z-index: 20;
            background: #fff; display: flex; flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .diary-detail-page.open { transform: translateX(0); }
        .diary-detail-header {
            position: sticky; top: 0; z-index: 10;
            background: #fff; border-bottom: 1px solid #e5e5e5;
            display: flex; align-items: center; padding: 10px 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            gap: 6px;
        }
        .diary-detail-header .diary-title { font-size: 16px; }
        .diary-header-actions { display: flex; gap: 6px; flex-shrink: 0; }
        .diary-action-btn {
            padding: 5px 10px; border-radius: 16px; border: none;
            font-size: 11px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 4px; transition: all 0.15s;
        }
        .diary-action-btn:active { transform: scale(0.95); }
        .diary-action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-green { background: rgba(7,193,96,0.1); color: #07C160; }
        .btn-green:hover { background: rgba(7,193,96,0.2); }
        .btn-red { background: rgba(244,53,48,0.1); color: #F43530; }
        .btn-red:hover { background: rgba(244,53,48,0.2); }
        .diary-detail-body {
            flex: 1; padding: 16px; width: 100%;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .diary-entry-card {
            background: #fff; border: 1px solid #e5e5e5;
            border-radius: 12px; padding: 16px; margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            position: relative;
        }
        .diary-entry-date {
            font-size: 12px; color: #999; margin-bottom: 10px;
            display: flex; align-items: center; gap: 6px; font-weight: 500;
        }
        .diary-entry-text {
            font-size: 14px; line-height: 1.8; color: #333;
            white-space: pre-wrap; word-break: break-word;
        }
        .diary-entry-actions {
            position: absolute; top: 10px; right: 10px;
            display: flex; gap: 8px;
        }
        .diary-entry-action {
            background: none; border: none; cursor: pointer;
            color: #ccc; font-size: 13px; padding: 4px;
            transition: color 0.15s;
        }
        .diary-entry-action:hover { color: #07C160; }
        .diary-entry-action.delete:hover { color: #F43530; }
        .diary-detail-empty {
            text-align: center; padding: 60px 20px; color: #999;
        }
        .diary-detail-empty i { font-size: 40px; display: block; margin-bottom: 12px; opacity: 0.5; }
        .diary-detail-empty p { font-size: 13px; line-height: 1.6; }
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 40; display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-box {
            background: #fff; border-radius: 14px; width: 90%;
            max-width: 460px; overflow: hidden;
        }
        .modal-header {
            padding: 16px; border-bottom: 1px solid #e5e5e5;
            display: flex; align-items: center; justify-content: space-between;
        }
        .modal-header h3 { font-size: 16px; font-weight: 600; }
        .modal-close {
            background: none; border: none; font-size: 18px;
            cursor: pointer; color: #999; padding: 4px;
        }
        .modal-body { padding: 16px; }
        .modal-body textarea {
            width: 100%; border: 1px solid #e5e5e5; border-radius: 8px;
            padding: 12px; font-size: 14px; line-height: 1.7;
            resize: vertical; min-height: 200px; outline: none;
            font-family: inherit; color: #333;
        }
        .modal-body textarea:focus { border-color: #07C160; }
        .modal-footer {
            padding: 12px 16px; border-top: 1px solid #e5e5e5;
            display: flex; justify-content: flex-end; gap: 8px;
        }
        .modal-btn {
            padding: 8px 20px; border-radius: 8px; border: none;
            font-size: 14px; cursor: pointer; transition: all 0.15s;
        }
        .modal-btn:active { transform: scale(0.97); }
        .modal-btn-cancel { background: #f5f5f5; color: #666; }
        .modal-btn-save { background: #07C160; color: #fff; }
        .toast {
            position: fixed; bottom: 80px; left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: rgba(0,0,0,0.75); color: #fff;
            padding: 10px 24px; border-radius: 20px;
            font-size: 14px; opacity: 0; transition: all 0.3s;
            pointer-events: none; z-index: 100; white-space: nowrap;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }@keyframes spin { to { transform: rotate(360deg); } }
        .fa-spin { animation: spin 1s linear infinite; }</style>
</head>
<body>

<div id="diaryListView">
    <div class="diary-header">
        <button class="diary-back" onclick="window.location.href='index.html'"><i class="fa fa-arrow-left"></i></button>
        <span class="diary-title">日记本</span>
    </div>
    <div class="diary-body" id="diaryListContainer"></div>
</div>

<div class="diary-detail-page" id="diaryDetailPage">
    <div class="diary-detail-header">
        <button class="diary-back" onclick="closeDiaryDetail()"><i class="fa fa-arrow-left"></i></button>
        <span class="diary-title" id="diaryDetailTitle">日记详情</span>
        <div class="diary-header-actions">
            <button class="diary-action-btn btn-red" id="resetPtrBtn" title="重置指针">
                <i class="fa fa-history"></i><span>重置指针</span>
            </button>
            <button class="diary-action-btn btn-green" id="manualDiaryBtn" title="手动总结">
                <i class="fa fa-pencil-square-o"></i><span>手动总结</span>
            </button>
        </div>
    </div>
    <div class="diary-detail-body" id="diaryDetailBody"></div>
</div>

<div class="modal-overlay" id="editModal">
    <div class="modal-box">
        <div class="modal-header">
            <h3>编辑日记</h3>
            <button class="modal-close" onclick="closeEditModal()"><i class="fa fa-times"></i></button>
        </div>
        <div class="modal-body">
            <textarea id="editTextarea"></textarea>
        </div>
        <div class="modal-footer">
            <button class="modal-btn modal-btn-cancel" onclick="closeEditModal()">取消</button>
            <button class="modal-btn modal-btn-save" onclick="saveEditDiary()">保存</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
var STORAGE_KEY = 'aiMultiChatObjects';
var activeChatId = null;
var editingEntryId = null;
var isGeneratingDiary = false;

function escHtml(str) {
    var div = document.createElement('div');
    div.textContent = str || '';
    return div.innerHTML;
}

function toast(t) {
    var el = document.getElementById('toast');
    el.textContent = t; el.classList.add('show');
    setTimeout(function() { el.classList.remove('show'); }, 2500);
}

function generateUniqueId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
}

function formatTime(ts) {
    var d = new Date(ts);
    var now = new Date();
    var M = (d.getMonth() + 1);
    var day = d.getDate();
    var h = d.getHours().toString(); if (h.length < 2) h = '0' + h;
    var m = d.getMinutes().toString(); if (m.length < 2) m = '0' + m;
    if (d.getFullYear() === now.getFullYear()) {
        return M + '月' + day + '日 ' + h + ':' + m;
    }
    return d.getFullYear() + '年' + M + '月' + day + '日 ' + h + ':' + m;
}

function cleanAiResponse(text) {
    if (!text) return '';
    return text.replace(/```[\s\S]*?```/g, '').replace(/\*\*/g, '').trim();
}

function loadChats() {
    try {
        var raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        var arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
    } catch (e) { return []; }
}

function saveChats(chats) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(chats));
}

function getApiConfig() {
    try {
        var raw = localStorage.getItem('aiMultiChatApiConfig');
        return raw ? JSON.parse(raw) : {};
    } catch (e) { return {}; }
}

function getUserInfo() {
    try {
        var raw = localStorage.getItem('aiMultiChatUserInfo');
        return raw ? JSON.parse(raw) : {};
    } catch (e) { return {}; }
}

function renderDiaryList() {
    var chats = loadChats();
    var container = document.getElementById('diaryListContainer');
    container.innerHTML = '';
    if (chats.length === 0) {
        container.innerHTML =
            '<div class="diary-empty">' +
            '<i class="fa fa-book"></i>' +
            '<p>暂无聊天对象</p>' +
            '<p style="font-size:12px;margin-top:8px;">先在微信中添加聊天对象吧</p>' +
            '</div>';
        return;
    }
    for (var i = 0; i < chats.length; i++) {
        (function(chat) {
            var diaries = chat.diaries || [];
            var avatarHtml = '';
            if (chat.avatar && chat.avatar.type !== 'default' && chat.avatar.url) {
                avatarHtml = '<div class="diary-chat-avatar"><img src="' + escHtml(chat.avatar.url) + '" alt=""></div>';
            } else {
                avatarHtml = '<div class="diary-chat-avatar"><i class="fa fa-user"></i></div>';
            }
            var div = document.createElement('div');
            div.className = 'diary-chat-item';
            div.innerHTML =
                avatarHtml +
                '<div class="diary-chat-info">' +
                '<div class="diary-chat-name">' + escHtml(chat.name || '未命名') + '</div>' +
                '<div class="diary-chat-count">' + diaries.length + '篇日记</div>' +
                '</div>';
            div.addEventListener('click', function() { openDiaryDetail(chat.id); });
            container.appendChild(div);
        })(chats[i]);
    }
}

function openDiaryDetail(chatId) {
    activeChatId = chatId;
    renderDiaryEntries();
    document.getElementById('diaryDetailPage').classList.add('open');
}

function closeDiaryDetail() {
    document.getElementById('diaryDetailPage').classList.remove('open');
    activeChatId = null;
}

function renderDiaryEntries() {
    var chats = loadChats();
    var chat = null;
    for (var i = 0; i < chats.length; i++) {
        if (chats[i].id === activeChatId) { chat = chats[i]; break; }
    }
    if (!chat) return;
    document.getElementById('diaryDetailTitle').textContent = (chat.name || '未命名') + '的日记本';
    var body = document.getElementById('diaryDetailBody');
    body.innerHTML = '';
    var diaries = chat.diaries || [];
    if (diaries.length === 0) {
        body.innerHTML =
            '<div class="diary-detail-empty">' +
            '<i class="fa fa-pencil-square-o"></i>' +
            '<p>还没有任何日记条目</p>' +
            '<p style="margin-top:6px;">与Ta多聊聊，系统会自动生成日记<br>或点击右上角「手动总结」</p>' +
            '</div>';
        return;
    }
    var sorted = diaries.slice().sort(function(a, b) {
        return (b.timestamp || 0) - (a.timestamp || 0);
    });
    for (var i = 0; i < sorted.length; i++) {
        (function(entry) {
            var card = document.createElement('div');
            card.className = 'diary-entry-card';
            var date = entry.timestamp ? formatTime(entry.timestamp) : '未知时间';
            card.innerHTML =
                '<div class="diary-entry-actions">' +
                '<button class="diary-entry-action edit" title="编辑"><i class="fa fa-pencil"></i></button>' +
                '<button class="diary-entry-action delete" title="删除"><i class="fa fa-trash"></i></button>' +
                '</div>' +
                '<div class="diary-entry-date"><i class="fa fa-calendar-o"></i> ' + date + '</div>' +
                '<div class="diary-entry-text">' + escHtml(entry.content || '') + '</div>';
            card.querySelector('.edit').addEventListener('click', function(e) {
                e.stopPropagation();
                openEditModal(entry.id);
            });
            card.querySelector('.delete').addEventListener('click', function(e) {
                e.stopPropagation();
                if (confirm('确定要删除这篇日记吗？此操作不可恢复。')) {
                    deleteDiaryEntry(entry.id);
                }
            });
            body.appendChild(card);
        })(sorted[i]);
    }
}

function openEditModal(entryId) {
    var chats = loadChats();
    var chat = null;
    for (var i = 0; i < chats.length; i++) {
        if (chats[i].id === activeChatId) { chat = chats[i]; break; }
    }
    if (!chat) return;
    var entry = null;
    var diaries = chat.diaries || [];
    for (var i = 0; i < diaries.length; i++) {
        if (diaries[i].id === entryId) { entry = diaries[i]; break; }
    }
    if (!entry) return;
    editingEntryId = entryId;
    document.getElementById('editTextarea').value = entry.content || '';
    document.getElementById('editModal').classList.add('show');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
    editingEntryId = null;
}

function saveEditDiary() {
    if (!editingEntryId) return;
    var chats = loadChats();
    for (var i = 0; i < chats.length; i++) {
        if (chats[i].id === activeChatId) {
            var diaries = chats[i].diaries || [];
            for (var j = 0; j < diaries.length; j++) {
                if (diaries[j].id === editingEntryId) {
                    diaries[j].content = document.getElementById('editTextarea').value;
                    diaries[j].timestamp = Date.now();
                    break;
                }
            }
            break;
        }
    }
    saveChats(chats);
    closeEditModal();
    renderDiaryEntries();toast('日记已保存');
}

function deleteDiaryEntry(entryId) {
    var chats = loadChats();
    for (var i = 0; i < chats.length; i++) {
        if (chats[i].id === activeChatId) {
            chats[i].diaries = (chats[i].diaries || []).filter(function(d) {
                return d.id !== entryId;
            });
            break;
        }
    }
    saveChats(chats);
    renderDiaryEntries();
    toast('日记已删除');
}

function resetDiaryPointer() {
    var chats = loadChats();
    var chat = null;
    for (var i = 0; i < chats.length; i++) {
        if (chats[i].id === activeChatId) { chat = chats[i]; break; }
    }
    if (!chat) return;
    if (confirm('确定要重置【' + (chat.name || '未命名') + '】的日记指针吗？\n\n这将让程序认为所有聊天记录都是"新的"，可以被重新总结。')) {
        var oldIndex = chat.lastDiaryIndex || 0;
        for (var i = 0; i < chats.length; i++) {
            if (chats[i].id === activeChatId) {
                chats[i].lastDiaryIndex = 0;
                break;
            }
        }
        saveChats(chats);
        toast('指针已重置（' + oldIndex + ' → 0）');
    }
}

async function manualGenerateDiary() {
    if (isGeneratingDiary) {
        toast('正在生成中，请稍候…');
        return;
    }
    var chats = loadChats();
    var chat = null;
    for (var i = 0; i < chats.length; i++) {
        if (chats[i].id === activeChatId) { chat = chats[i]; break; }
    }
    if (!chat) return;
    var messages = chat.messages || [];
    var lastIndex = chat.lastDiaryIndex || 0;
    var messagesToSummarize = messages.slice(lastIndex);
    if (messagesToSummarize.length === 0) {
        toast('没有需要总结的新内容');
        return;
    }
    var config = getApiConfig();
    if (!config.baseUrl || !config.apiKey || !config.modelName) {
        toast('请先在设置中配置API');
        return;
    }
    isGeneratingDiary = true;
    var btn = document.getElementById('manualDiaryBtn');
    var originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i><span>总结中…</span>';
    btn.disabled = true;
    try {
        var success = await generateDiaryEntry(chat, messagesToSummarize, lastIndex, config);
        if (success) {
            toast('总结成功！');
            renderDiaryEntries();
        } else {
            toast('总结失败，请检查API配置');
        }
    } catch (e) {
        console.error('手动总结出错:', e);
        toast('总结出错: ' + e.message);
    } finally {
        isGeneratingDiary = false;
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
}

async function generateDiaryEntry(chat, messagesToSummarize, startIndex, config) {
    var today = new Date();
    var dateString = today.getFullYear() + '年' +
        (today.getMonth() + 1).toString().padStart(2, '0') + '月' +
        today.getDate().toString().padStart(2, '0') + '日';
    var userInfo = getUserInfo();
    var userName = (userInfo.name || 'user').trim() || '用户';
    var systemRolePrompt =
        '你正在扮演一个角色，现在需要写一段简短的内心备忘，包含两部分：\n\n' +
        '1.【心声】你对\'' + userName + '\'的真实内心想法（100字以内）\n' +
        '- 不要复述对话内容\n' +
        '- 表达你对' + userName + '的感情、牵挂、欣赏或思念\n' +
        '- 可以写你注意到的' + userName + '的小细节、让你心动的瞬间\n' +
        '- 禁止写"没什么特别"之类的敷衍内容，每一天都值得珍惜\n\n' +
        '2.【记住】需要永久记住的重要信息（可选，每条不超过20字）\n' +
        '- 只记录关键事实：如姓名、生日、喜好、重要事件、承诺等\n' +
        '- 如果没有需要特别记住的内容，可以不写这部分\n' +
        '- 用简短的条目列出\n\n' +
        '格式如下，严格遵守：\n\n' +
        '【' + dateString + '】\n' +
        '【心声】（你的内心独白，要有感情）\n' +
        '【记住】\n- 条目1\n- 条目2';
    var conversationText = messagesToSummarize.map(function(m) {
        return (m.role === 'user' ? userName : '我') + ': ' + m.content;
    }).join('\n');
    var userRolePrompt = '以下是最近的对话，写下你的内心备忘：\n\n' + conversationText;
    try {
        var response = await fetch(config.baseUrl.replace(/\/+$/, '') + '/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + config.apiKey
            },
            body: JSON.stringify({
                model: config.modelName,
                messages: [
                    { role: 'system', content: systemRolePrompt },
                    { role: 'user', content: userRolePrompt }
                ],
                temperature: config.temperature || 0.7
            })
        });
        if (!response.ok) {
            var errorText = await response.text();
            throw new Error('API请求失败 (' + response.status + '): ' + errorText);
        }
        var data = await response.json();
        var diaryContent = cleanAiResponse(data.choices[0].message.content);
        if (diaryContent) {
            var freshChats = loadChats();
            for (var i = 0; i < freshChats.length; i++) {
                if (freshChats[i].id === chat.id) {
                    if (!freshChats[i].diaries) freshChats[i].diaries = [];
                    freshChats[i].diaries.push({
                        id: generateUniqueId(),
                        content: diaryContent,
                        timestamp: Date.now()
                    });
                    freshChats[i].lastDiaryIndex = startIndex + messagesToSummarize.length;
                    break;
                }
            }
            saveChats(freshChats);
            return true;
        }
        return false;
    } catch (e) {
        console.error('日记生成失败:', e);
        throw e;
    }
}

document.getElementById('resetPtrBtn').addEventListener('click', resetDiaryPointer);
document.getElementById('manualDiaryBtn').addEventListener('click', manualGenerateDiary);

renderDiaryList();
</script>
</body>
</html>
